<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATEC 인사관리(근태) · 전월/당월 비교(안정화)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;
    --accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;--dark:#111827;

    /* 도넛 색: 전월(파스텔) / 당월(채도↑) */
    --prev-ot:#fca5a5; --prev-hol:#93c5fd; --prev-etc:#e5e7eb;
    --now-ot:#f43f5e;  --now-hol:#3b82f6;  --now-etc:#cbd5e1;

    /* 막대: 전월(파랑) ← 당월(빨강) */
    --bar-prev:#60a5fa;
    --bar-now:#f87171;

    /* 추세 화살표 색 */
    --up:#ef4444;      /* 빨강 */
    --down:#2563eb;    /* 파랑 */
    --flat:#6b7280;    /* 중립 */
  }
  *{box-sizing:border-box}
  body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}

  .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line)}
  .stepper{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .step{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.25s;cursor:pointer}
  .step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
  .step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
  .step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
  .chev{flex:1 1 auto;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);position:relative;min-width:40px}
  .chev:after{content:"";position:absolute;right:-8px;top:-6px;border:8px solid transparent;border-left-color:#e5e7eb;opacity:.7}

  main{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}
  .page{display:none;opacity:0;transform:translateY(8px);transition:opacity .35s ease,transform .35s ease}
  .page.show{display:block;opacity:1;transform:none}

  .upload{display:flex;gap:16px;flex-wrap:wrap}
  .upload-card{flex:1 1 31%;border:2px dashed var(--line);border-radius:12px;padding:20px;text-align:center;background:#fbfdff;min-width:260px}
  input[type=file]{display:none}
  label.pick{background:#111827;color:#fff;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-block}
  label.pick.flash{background:var(--ok);animation:flash 1.1s ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
  .filename{display:block;color:var(--muted);margin-top:8px;min-height:20px}
  .btn{background:#111827;color:#fff;border:none;border-radius:12px;padding:14px 24px;cursor:pointer;font-weight:700}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed}
  .btn:not([disabled]):hover{background:var(--accent1)}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#dcfce7;color:#065f46;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}

  .summary-grid{display:grid;grid-template-columns:1.1fr .9fr .9fr;gap:16px;align-items:stretch}
  .kpi{border:1px solid var(--line);border-radius:16px;padding:18px}
  .kpi h3{margin:0 0 6px 0;color:#374151;font-size:14px}
  .kpi .line1{color:#111827}
  .kpi .line2{margin-top:4px}
  .up{color:var(--up)} .down{color:var(--down)} .flat{color:var(--flat)}
  .arrow{font-weight:900;margin-right:4px}

  .totalPay{font-size:42px;font-weight:900;letter-spacing:-.5px}
  .totalBox .delta{margin-top:6px}
  .totalBox .delta span{margin-right:8px}

  .chart-row{display:flex;gap:24px;justify-content:center;flex-wrap:wrap}
  .chart-box{width:860px;max-width:100%;text-align:center}
  .chart-title{margin:0 0 6px 0;font-weight:800}
  .chart-foot{margin:.5rem 0 0;color:#374151;font-size:14px;line-height:1.4}
  canvas{width:100%;height:auto}

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:.92rem;white-space:nowrap}
  th{background:#f3f4f6;position:sticky;top:0}
  tfoot td{background:#f9fafb;font-weight:700}

  .save-row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch}
  .btn-save{flex:1 1 0}
  .btn-merge{flex:3 1 0;background:var(--accent1)}
  .btn-merge:hover{background:#1d4ed8}

  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
</style>
</head>
<body>
  <header>ATEC 인사관리(근태) 프로그램</header>

  <div class="topbar">
    <div class="stepper" id="stepper">
      <div class="step active" data-target="1"><div class="num">1</div><div>업로드</div></div>
      <div class="chev"></div>
      <div class="step" data-target="2"><div class="num">2</div><div>리포트</div></div>
      <div class="chev"></div>
      <div class="step" data-target="3"><div class="num">3</div><div>세부내역</div></div>
      <div class="chev"></div>
      <div class="step" data-target="4"><div class="num">4</div><div>데이터 저장</div></div>
    </div>
  </div>

  <main>
    <!-- 1. 업로드 -->
    <section id="page1" class="page show">
      <div class="card">
        <h2>안내사항</h2>
        <p>✔ 산정기간: 전월 21일 ~ 당월 20일 (결재 완료 기준)</p>
        <p>✔ 휴게시간: 4시간 초과 시 1시간 부여</p>
        <p>✔ 주 52시간 근무제에 따라 휴일/야간근무는 주 12시간 이내 신청 가능</p>
        <p>✔ 필요 RAW 데이터(2개)</p>
        <div style="padding-left:10px">
          <div style="margin:10px 0">1) 그룹웨어-시간외근무 승인(관리자) 데이터</div>
          <div style="margin:10px 0">2) ERP-책정임근현황(통상시급)</div>
        </div>
      </div>

      <div class="card">
        <h2>데이터 업로드</h2>
        <h3 style="margin-top:0">[당월 자료]</h3>
        <div class="upload">
          <div class="upload-card">
            <label class="pick" for="fileAtt">근태 RAW</label>
            <input type="file" id="fileAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameAtt">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="fileWage">통상시급</label>
            <input type="file" id="fileWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameWage">선택된 파일 없음</span>
          </div>
        </div>

        <h3 style="margin:18px 0 8px 0">[전월 자료] <span class="muted">(선택사항)</span></h3>
        <div class="upload">
          <div class="upload-card">
            <label class="pick" for="prevAtt">전월 근태 RAW</label>
            <input type="file" id="prevAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="prevAttName">선택된 파일 없음</span>
            <p class="muted" id="prevAttStatus">전월 근태 RAW: 미업로드</p>
          </div>
          <div class="upload-card">
            <label class="pick" for="prevWage">전월 통상시급</label>
            <input type="file" id="prevWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="prevWageName">선택된 파일 없음</span>
            <p class="muted" id="prevWageStatus">전월 통상시급: 미업로드</p>
          </div>
          <div class="upload-card">
            <label class="pick" for="prevAll">전월 통합자료(권장)</label>
            <input type="file" id="prevAll" accept=".xlsx,.xls,.xlsm" />
            <span class="filename" id="prevAllName">선택된 파일 없음</span>
            <p class="muted" id="prevAllStatus">전월 통합자료: 미업로드</p>
          </div>
        </div>

        <div style="text-align:center;margin-top:20px;">
          <button class="btn" id="startSim" disabled>시뮬레이션 시작</button>
        </div>
      </div>
    </section>

    <!-- 2. 리포트 -->
    <section id="page2" class="page">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <span class="badge" id="prevState"><span>●</span> 전월 데이터: 미지정</span>
          <span class="muted" style="margin-left:10px">※ 전월 업로드 후 비교가 활성화됩니다.</span>
        </div>
        <button class="btn" id="btnPrevReset" style="background:#6b7280">전월 데이터 초기화</button>
      </div>

      <div class="card">
        <div class="summary-grid">
          <div class="kpi">
            <h3>총 적용시간</h3>
            <div class="line1" id="appliedLine1">당월: 0.0h (전월: 0.0h)</div>
            <div class="line2" id="appliedLine2"><span class="flat arrow">•</span><span class="flat">0.0h</span> <span class="flat arrow" style="margin-left:10px">•</span><span class="flat">0.0%</span></div>
          </div>
          <div class="kpi">
            <h3>시간외수당</h3>
            <div class="line1" id="overPayLine1">당월: 0 (전월: 0)</div>
            <div class="line2" id="overPayLine2"><span class="flat arrow">•</span><span class="flat">0</span> <span class="flat arrow" style="margin-left:10px">•</span><span class="flat">0.0%</span></div>
          </div>
          <div class="kpi">
            <h3>휴일수당</h3>
            <div class="line1" id="holPayLine1">당월: 0 (전월: 0)</div>
            <div class="line2" id="holPayLine2"><span class="flat arrow">•</span><span class="flat">0</span> <span class="flat arrow" style="margin-left:10px">•</span><span class="flat">0.0%</span></div>
          </div>
        </div>

        <div class="card totalBox" style="margin:16px 0 0 0">
          <div style="text-align:center">
            <div style="color:#6b7280;font-weight:700">총 수당(시간외 + 휴일)</div>
            <div class="totalPay"><span id="sumPayNow">0</span>원</div>
            <div class="delta">
              <span id="sumPayDeltaAbs"><span class="flat arrow">•</span>0원</span>
              <span id="sumPayDeltaPct"><span class="flat arrow">•</span>0.0%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 도넛(전월/당월) -->
      <div class="card">
        <div class="chart-row">
          <div class="chart-box" style="max-width:420px">
            <h3 class="chart-title">전월 시간/수당 비율</h3>
            <canvas id="donutPrev"></canvas>
            <div class="chart-foot" id="footPrev">연장시간 0.0h · 휴일시간 0.0h · 총수당 0원</div>
          </div>
          <div class="chart-box" style="max-width:420px">
            <h3 class="chart-title">당월 시간/수당 비율</h3>
            <canvas id="donutNow"></canvas>
            <div class="chart-foot" id="footNow">연장시간 0.0h · 휴일시간 0.0h · 총수당 0원</div>
          </div>
        </div>
      </div>

      <!-- 전월 대비 비교 차트 -->
      <div class="card">
        <h3 style="margin-top:0">전월 대비 비교 차트</h3>
        <div class="chart-row">
          <div class="chart-box">
            <canvas id="barHoursAll"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">시간 비교 (전월 vs 당월: 적용·연장·휴일)</p>
          </div>
        </div>
        <div class="chart-row" style="margin-top:12px">
          <div class="chart-box">
            <canvas id="barPays"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">수당 비교 (전월 vs 당월: 시간외·휴일·총)</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 3. 세부내역 -->
    <section id="page3" class="page">
      <div class="card"><h2>근태현황</h2><div class="table-wrap"><table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table></div></div>
      <div class="card"><h2>근태정리</h2><div class="table-wrap"><table id="tblSummary"><thead><tr><th>데이터 없음</th></tr></thead></table></div></div>
      <div class="card"><h2>익월적용</h2><div class="table-wrap"><table id="tblNext"><thead><tr><th>데이터 없음</th></tr></thead></table></div></div>
    </section>

    <!-- 4. 데이터 저장 -->
    <section id="page4" class="page">
      <div class="card">
        <h2 style="margin-top:0">엑셀 다운로드</h2>
        <p class="muted" style="margin-top:-4px">버튼을 클릭하면 .xlsx 저장 창이 열립니다.</p>
        <div class="save-row">
          <button class="btn btn-save" id="btnSaveStatus">근태현황 저장</button>
          <button class="btn btn-save" id="btnSaveSummary">근태정리 저장</button>
          <button class="btn btn-save" id="btnSaveNext">익월적용 저장</button>
          <button class="btn btn-merge" id="btnSaveAll">통합저장</button>
        </div>
        <p class="muted" style="margin-top:10px">※ 통합저장은 전월 데이터 보관 안 함(전월 비교는 1페이지에서 수동 업로드).</p>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
Chart.register(ChartDataLabels);
const $=(id)=>document.getElementById(id);
const showToast=(m)=>{const t=$('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2200);};
const steps=[...document.querySelectorAll('.stepper .step')];
const pages=[$('page1'),$('page2'),$('page3'),$('page4')];
function gotoStep(n){steps.forEach(s=>s.classList.remove('active'));steps[n-1].classList.add('active');pages.forEach(p=>{p.classList.remove('show');p.style.display='none';});const tgt=pages[n-1];tgt.style.display='block';requestAnimationFrame(()=>tgt.classList.add('show'));window.scrollTo({top:0,behavior:'smooth'});}
steps.forEach(s=>s.addEventListener('click',()=>gotoStep(Number(s.dataset.target))));

/* 필수 헤더 */
const REQUIRED_ATT=["신청시간","근무자 부서","근무자","근무일","근무유형","종결일자","상태"];
const REQUIRED_WAGE=["부서","이름","통상시급"];

/* 업로드/매핑 */
let attRowsRaw=[], wageRowsRaw=[], attRows=[], wageRows=[];
let okAtt=false, okWage=false;

function parseExcel(file, preferSheetNames=[]){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=(e)=>{try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      let sheet=null; for(const n of preferSheetNames){ if(wb.Sheets[n]){ sheet=wb.Sheets[n]; break; } }
      if(!sheet) sheet = wb.Sheets[wb.SheetNames[0]];
      resolve({rows:XLSX.utils.sheet_to_json(sheet,{defval:null}), wb});
    }catch(err){reject(err);}};
    reader.readAsArrayBuffer(file);
  });
}
function guessMapKeys(required, columns){
  const syn={"신청시간":["신청시간","시간","근무시간대","근무신청시간","시작~종료","근무시간(신청)"],"근무자 부서":["근무자 부서","부서","부서(팀)","부서명","소속"],"근무자":["근무자","이름","성명","근무자명","사원명"],"근무일":["근무일","일자","근무일자","날짜"],"근무유형":["근무유형","유형","구분","근무구분"],"종결일자":["종결일자","결재일자","승인일자","종결일","결재일"],"상태":["상태","결재상태","승인상태"],"부서":["부서","부서명","소속","부서(팀)"],"이름":["이름","성명","사원명"],"통상시급":["통상시급","기본시급","시급","통상 임금","통상임금"]};
  const map={}; required.forEach(k=>{const cands=(syn[k]||[]).map(s=>s.toLowerCase()); let pick=columns.find(c=>c.toLowerCase()===k.toLowerCase()); if(!pick) pick=columns.find(c=>cands.includes(c.toLowerCase())); map[k]=pick||"";}); return map;
}
function openMapper(title, requiredKeys, columns, onApply){
  const modalId='mapModal'; let modal=document.getElementById(modalId);
  if(!modal){
    const wrap=document.createElement('div'); wrap.id=modalId; wrap.style.position='fixed';wrap.style.inset='0';wrap.style.background='rgba(0,0,0,.45)';
    wrap.style.display='flex';wrap.style.alignItems='center';wrap.style.justifyContent='center';wrap.style.zIndex='10000';
    wrap.innerHTML=`<div style="background:#fff;max-width:720px;width:92vw;border-radius:16px;box-shadow:0 16px 60px rgba(0,0,0,.35);padding:18px">
      <h3 style="margin:0 0 8px 0" id="mapTitle">헤더 매핑</h3>
      <p class="muted" style="margin-top:0">업로드 파일 열 이름을 표준 항목에 연결하세요.</p>
      <div class="grid-map" id="mapGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
        <button class="btn" id="btnMapCancel" style="background:#6b7280">취소</button>
        <button class="btn" id="btnMapOk">매핑 완료</button>
      </div>
    </div>`;
    document.body.appendChild(wrap);
  }else{ modal.style.display='flex'; }
  $('mapTitle').textContent=title; const grid=$('mapGrid'); grid.innerHTML="";
  const guesses=guessMapKeys(requiredKeys, columns);
  requiredKeys.forEach(k=>{const wrap=document.createElement('div');wrap.className='cell';const lab=document.createElement('label');lab.textContent=k;const sel=document.createElement('select');sel.dataset.key=k;sel.style.width='100%';sel.style.padding='8px';sel.style.border='1px solid #e5e7eb';sel.style.borderRadius='10px';sel.appendChild(new Option('-- 열 선택 --',''));columns.forEach(col=>sel.appendChild(new Option(col,col)));sel.value=guesses[k]||"";wrap.appendChild(lab);wrap.appendChild(sel);grid.appendChild(wrap);});
  $('btnMapCancel').onclick=()=> $('mapModal').style.display='none';
  $('btnMapOk').onclick=()=>{const selects=[...document.querySelectorAll('#mapGrid select')]; const mapping={}; for(const s of selects){ if(!s.value){showToast('모든 항목을 매핑해 주세요.'); return;} mapping[s.dataset.key]=s.value; } $('mapModal').style.display='none'; onApply(mapping);};
}
function normalizeRows(rows, mapping){return rows.map(r=>{const o={}; Object.keys(mapping).forEach(k=>o[k]=r[mapping[k]]); return o;});}

function attachPicker(inputId, nameId, type){
  const input=$(inputId), name=$(nameId), label=document.querySelector(`label[for="${inputId}"]`);
  input.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f){name.textContent='선택된 파일 없음'; return;}
    name.textContent='분석 중…';
    try{
      const {rows}=await parseExcel(f);
      const cols=Object.keys(rows[0]||{});
      label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');
      if(type==='att'){
        attRowsRaw=rows.slice();
        const ok=REQUIRED_ATT.every(h=>cols.includes(h));
        if(!ok){ openMapper('근태 RAW 헤더 매핑', REQUIRED_ATT, cols, (m)=>{attRows=normalizeRows(attRowsRaw,m); name.textContent=`선택 완료 · ${f.name} (${attRows.length}행)`; okAtt=true; updateStartBtn();}); }
        else { attRows=rows; name.textContent=`선택 완료 · ${f.name} (${attRows.length}행)`; okAtt=true; updateStartBtn(); }
      }else{
        wageRowsRaw=rows.slice();
        const ok=REQUIRED_WAGE.every(h=>cols.includes(h));
        if(!ok){ openMapper('통상시급 헤더 매핑', REQUIRED_WAGE, cols, (m)=>{wageRows=normalizeRows(wageRowsRaw,m); name.textContent=`선택 완료 · ${f.name} (${wageRows.length}행)`; okWage=true; updateStartBtn();}); }
        else { wageRows=rows; name.textContent=`선택 완료 · ${f.name} (${wageRows.length}행)`; okWage=true; updateStartBtn(); }
      }
    }catch(err){console.error(err); name.textContent='파싱 실패'; showToast('파일 파싱 실패: '+err.message);}
  });
}
attachPicker('fileAtt','nameAtt','att');
attachPicker('fileWage','nameWage','wage');
function updateStartBtn(){ $('startSim').disabled=!(okAtt && okWage); }

/* 전월 업로드 */
let prevAttRows=null, prevWageRows=null, prevMetrics=null;
function updatePrevStatusTexts(){ $('prevAttStatus').textContent='전월 근태 RAW: '+(prevAttRows?'업로드됨':'미업로드'); $('prevWageStatus').textContent='전월 통상시급: '+(prevWageRows?'업로드됨':'미업로드'); }
function updatePrevBadge(){ const b=$('prevState'); if(prevMetrics){ b.style.background='#dcfce7'; b.style.color='#065f46'; b.innerHTML=`<span>●</span> 전월 데이터: 지정됨 (${prevMetrics.from||'업로드'})`; } else { b.style.background='#eef2ff'; b.style.color='#1e3a8a'; b.innerHTML=`<span>●</span> 전월 데이터: 미지정`; } }
function attachPrevPicker(inputId, nameId, kind){
  const input=$(inputId), name=$(nameId), label=document.querySelector(`label[for="${inputId}"]`);
  input.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f){name.textContent='선택된 파일 없음'; return;}
    name.textContent='분석 중…';
    try{
      if(kind==='prev_all'){
        const {wb}=await parseExcel(f,['근태정리']); let rowsSum=[];
        if(wb.Sheets['근태정리']) rowsSum=XLSX.utils.sheet_to_json(wb.Sheets['근태정리'],{defval:null});
        else rowsSum=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:null});
        const get=(arr,k)=>arr.reduce((a,b)=>a+(Number(b[k])||0),0);
        const overH=get(rowsSum,'평일연장')+get(rowsSum,'평일야간');
        const holH =get(rowsSum,'휴일일반')+get(rowsSum,'휴일연장')+get(rowsSum,'휴일야간')+get(rowsSum,'휴일연장야간');
        prevMetrics={appliedTotal:get(rowsSum,'적용시간')||0, overPay:get(rowsSum,'시간외수당')||0, holPay:get(rowsSum,'휴일수당')||0, totalPay:(get(rowsSum,'시간외수당')||0)+(get(rowsSum,'휴일수당')||0), overHours:overH||0, holHours:holH||0, from:f.name};
        label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');
        name.textContent=`선택 완료 · ${f.name}`; $('prevAllStatus').textContent='전월 통합자료: 업로드됨'; updatePrevBadge(); if(currentResult) renderReport(currentResult); showToast('전월 통합자료 설정 완료'); return;
      }
      const {rows}=await parseExcel(f); const cols=Object.keys(rows[0]||{});
      label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');
      if(kind==='prev_att'){
        const ok=REQUIRED_ATT.every(h=>cols.includes(h));
        if(!ok){ openMapper('전월 근태 RAW 헤더 매핑', REQUIRED_ATT, cols, (m)=>{prevAttRows=normalizeRows(rows,m); name.textContent=`선택 완료 · ${f.name} (${prevAttRows.length}행)`; $('prevAttStatus').textContent='전월 근태 RAW: 업로드됨'; tryBuildPrevFromParts();}); }
        else { prevAttRows=rows; name.textContent=`선택 완료 · ${f.name} (${prevAttRows.length}행)`; $('prevAttStatus').textContent='전월 근태 RAW: 업로드됨'; tryBuildPrevFromParts(); }
      }else{
        const ok=REQUIRED_WAGE.every(h=>cols.includes(h));
        if(!ok){ openMapper('전월 통상시급 헤더 매핑', REQUIRED_WAGE, cols, (m)=>{prevWageRows=normalizeRows(rows,m); name.textContent=`선택 완료 · ${f.name} (${prevWageRows.length}행)`; $('prevWageStatus').textContent='전월 통상시급: 업로드됨'; tryBuildPrevFromParts();}); }
        else { prevWageRows=rows; name.textContent=`선택 완료 · ${f.name} (${prevWageRows.length}행)`; $('prevWageStatus').textContent='전월 통상시급: 업로드됨'; tryBuildPrevFromParts(); }
      }
    }catch(err){console.error(err); name.textContent='파싱 실패'; showToast('파일 파싱 실패: '+err.message);}
  });
}
function tryBuildPrevFromParts(){
  if(!prevAttRows) return;
  try{
    const pr=process(prevAttRows, prevWageRows||[]);
    prevMetrics={appliedTotal:pr.metrics.appliedTotal||0, overPay:pr.metrics.overPay||0, holPay:pr.metrics.holPay||0, totalPay:(pr.metrics.overPay||0)+(pr.metrics.holPay||0), overHours:pr.metrics.overHours||0, holHours:pr.metrics.holHours||0, from: prevWageRows?'전월 개별 업로드(근태RAW+통상시급)':'전월 개별 업로드(근태RAW만: 수당0)'}; 
    updatePrevBadge(); updatePrevStatusTexts(); if(currentResult) renderReport(currentResult); showToast('전월 데이터 설정 완료');
  }catch(err){console.error(err); showToast('전월 데이터 계산 실패: '+err.message);}
}
attachPrevPicker('prevAll','prevAllName','prev_all');
attachPrevPicker('prevAtt','prevAttName','prev_att');
attachPrevPicker('prevWage','prevWageName','prev_wage');
updatePrevStatusTexts();

/* 엔진 */
const date21=new Date(new Date().getFullYear(), new Date().getMonth(), 21);
function hourMod24(t){return t-24*Math.floor(t/24);}
function parseTime(s){if(s==null) return -1; let st=String(s).trim(); if(!st) return -1; st=st.replace(/\s+/g,"").replace("시",":").replace("분",""); if(!st.includes(":")){ if(!/^\d+$/.test(st)) return -1; const n=parseInt(st,10); if(st.length<=2) return n; if(st.length<=4) return Math.floor(n/100)+(n%100)/60; return -1; } let [h,m]=st.split(":"); h=parseInt(h,10); m=parseInt(m,10); if(isNaN(h)||isNaN(m)||m<0||m>=60) return -1; return h+m/60;}
const ceilHalf=x=> Math.ceil(Number(x)/0.5)*0.5;
const fmtHM=d=>{const h=Math.floor(d)%24; const m=Math.round((d-Math.floor(d))*60)%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;};
const toNum=v=>{const n=Number(v); return isNaN(n)?0:n;};
const sum=(arr,key)=>arr.reduce((a,b)=>a+toNum(b[key]),0);

let dfStatus=[], dfSummary=[], dfNext=[];
function process(att, wage){
  let _status=[], _summary=[], _next=[]; const agg={}; const ensure=(n,d)=>{if(!agg[n]) agg[n]={부서:d,이름:n,근무시간:0,휴게시간:0,적용시간:0,평일연장:0,평일야간:0,휴일일반:0,휴일연장:0,휴일야간:0,휴일연장야간:0};};
  const cols=Object.keys(att[0]||{}); if(!REQUIRED_ATT.every(h=>cols.includes(h))) throw new Error('근태 RAW에 필수 헤더가 없습니다. (매핑 필요)');
  for(const r of att){
    if(String(r['상태']||'').includes('반려')) continue;
    const raw=String(r['신청시간']||''); let closeDate=r['종결일자']? new Date(r['종결일자']):null;
    if(!raw.includes('~')){ if(closeDate && closeDate>=date21) _next.push(r); continue; }
    let [s,e]=raw.split('~').map(x=>x.trim()); let sh=parseTime(s), eh=parseTime(e); if(sh<0||eh<0){ if(closeDate && closeDate>=date21) _next.push(r); continue; } if(eh<sh) eh+=24;
    const work=eh-sh, brk=Math.floor(work/5), applied=work-brk;
    if(closeDate && closeDate<date21){
      _status.push({순번:null,부서:r['근무자 부서'],이름:r['근무자'],근무일자:r['근무일'],근무유형:r['근무유형'],근무시작시간:fmtHM(sh),근무종료시간:fmtHM(eh),근무시간:+work.toFixed(2),휴게시간:+brk.toFixed(2),적용시간:+applied.toFixed(2),정수:ceilHalf(applied)});
      const name=String(r['근무자']||'').replace('(IT)','').trim(); const dept=r['근무자 부서']; const ty=String(r['근무유형']||'').toLowerCase(); if(!name) continue;
      ensure(name,dept); const A=agg[name]; A.근무시간+=work; A.휴게시간+=brk; A.적용시간+=applied;
      let effStart=sh+brk; if(effStart>eh) effStart=eh;
      for(let t=effStart; t<eh-1e-6; t+=0.25){ const hod=hourMod24(t); const worked=t-effStart;
        if(ty.includes('연장') && !ty.includes('휴일')){ if(hod>=18&&hod<22) A.평일연장+=0.25; if(hod>=22||hod<6) A.평일야간+=0.25; }
        else if(ty.includes('휴일')){ if(worked<8){ if(hod>=6&&hod<22) A.휴일일반+=0.25; else A.휴일야간+=0.25; } else { if(hod>=6&&hod<22) A.휴일연장+=0.25; else A.휴일연장야간+=0.25; } }
      }
    } else { _next.push(r); }
  }
  _status.forEach((r,i)=> r.순번=i+1);
  _summary=Object.values(agg).map((A,i)=>({순번:i+1,부서:A.부서,이름:A.이름,근무시간:+A.근무시간.toFixed(2),휴게시간:+A.휴게시간.toFixed(2),적용시간:+A.적용시간.toFixed(2),평일연장:+A.평일연장.toFixed(2),평일야간:+A.평일야간.toFixed(2),휴일일반:+A.휴일일반.toFixed(2),휴일연장:+A.휴일연장.toFixed(2),휴일야간:+A.휴일야간.toFixed(2),휴일연장야간:+A.휴일연장야간.toFixed(2)}));

  let overPay=0, holPay=0; if(wage && wage.length){
    const cols2=Object.keys(wage[0]||{}); if(!REQUIRED_WAGE.every(h=>cols2.includes(h))) throw new Error('통상시급 파일 헤더 누락(매핑 필요)');
    const map=new Map(); wage.forEach(r=>{const d=String(r['부서']||'').trim(); const n=String(r['이름']||'').trim(); const w=Number(r['통상시급']); if(n) map.set(`${d}|${n}`, isNaN(w)?0:w);});
    const mult={평일연장:1.5, 평일야간:2.0, 휴일일반:1.5, 휴일연장:2.0, 휴일야간:2.0, 휴일연장야간:2.5};
    _summary=_summary.map(r=>{const key=`${r['부서']}|${r['이름']}`; const base=map.has(key)?map.get(key):0;
      const N=Math.ceil(base*mult.평일연장*toNum(r['평일연장'])); const O=Math.ceil(base*mult.평일야간*toNum(r['평일야간']));
      const P=Math.ceil(base*mult.휴일일반*toNum(r['휴일일반'])); const Q=Math.ceil(base*mult.휴일연장*toNum(r['휴일연장']));
      const R=Math.ceil(base*mult.휴일야간*toNum(r['휴일야간'])); const S=Math.ceil(base*mult.휴일연장야간*toNum(r['휴일연장야간']));
      overPay+=(N+O); holPay+=(P+Q+R+S); return {...r,시간외수당:N+O,휴일수당:P+Q+R+S};});
  }
  return {status:_status, summary:_summary, next:_next, metrics:{
    appliedTotal:sum(_status,'적용시간'),
    overHours:sum(_summary,'평일연장')+sum(_summary,'평일야간'),
    holHours:sum(_summary,'휴일일반')+sum(_summary,'휴일연장')+sum(_summary,'휴일야간')+sum(_summary,'휴일연장야간'),
    overPay, holPay, totalPay:overPay+holPay }};
}

/* 주석/그래프 */
const appliedLine1=$('appliedLine1'), appliedLine2=$('appliedLine2');
const overPayLine1=$('overPayLine1'), overPayLine2=$('overPayLine2');
const holPayLine1=$('holPayLine1'), holPayLine2=$('holPayLine2');
const sumPayNow=$('sumPayNow'), sumPayDeltaAbs=$('sumPayDeltaAbs'), sumPayDeltaPct=$('sumPayDeltaPct');

const donutPrev=$('donutPrev'), donutNow=$('donutNow');
const barHoursAll=$('barHoursAll'), barPays=$('barPays');
const footPrev=$('footPrev'), footNow=$('footNow');

function deltaObj(now, prev){const d=now-(prev||0); const p=(prev&&prev!==0)?(d/prev*100):(now>0?100:0); return {d,p,up:d>0,flat:d===0};}
function setArrowSpans(el,obj,unit,isMoney){
  const cls = obj.up? 'up' : (obj.flat? 'flat':'down');
  const sym1= obj.up? '↖ ▲' : (obj.flat? '•' : '↘ ▼');
  const abs = isMoney? `${Math.abs(obj.d).toLocaleString()}${unit}` : `${Math.abs(obj.d).toFixed(1)}${unit}`;
  const pct = `${Math.abs(obj.p).toFixed(1)}%`;
  el.innerHTML = `<span class="${cls} arrow">${sym1}</span><span class="${cls}">${abs}</span> <span class="${cls} arrow" style="margin-left:10px">${sym1}</span><span class="${cls}">${pct}</span>`;
}

/* 도넛 */
function drawDoughnut(ctxRef, labels, data, isNow){
  const colors=isNow?['#ef4444','#2563eb','#cbd5e1']:['#fca5a5','#93c5fd','#e5e7eb'];
  if(ctxRef._chart) ctxRef._chart.destroy();
  ctxRef._chart=new Chart(ctxRef,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors}]},options:{plugins:{legend:{display=true,position:'bottom'},datalabels:{color:'#fff',textStrokeColor:'rgba(0,0,0,0.38)',textStrokeWidth:3,font:{size:18,weight:'900'},formatter:(v,ctx)=>{const total=ctx.dataset.data.reduce((a,b)=>a+(+b||0),0); if(!total) return ''; const per=v/total*100; return per<3?'':per.toFixed(1)+'%';}}},cutout:'62%'}});
}

/* 보조: CSS 변수 값 */
function cssVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

/* 라운드 사각형(브라우저 호환용) */
function roundRectPath(ctx,x,y,w,h,r){
  r=Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.arcTo(x+w, y, x+w, y+r, r);
  ctx.lineTo(x+w, y+h-r);
  ctx.arcTo(x+w, y+h, x+w-r, y+h, r);
  ctx.lineTo(x+r, y+h);
  ctx.arcTo(x, y+h, x, y+h-r, r);
  ctx.lineTo(x, y+r);
  ctx.arcTo(x, y, x+r, y, r);
  ctx.closePath();
}

/* 막대 라벨 도우미 */
function labelAnchor(ctx){const v=ctx.dataset.data[ctx.dataIndex]||0; const yMax=ctx.chart.scales.y.max||1; return v>(yMax*0.22)?'center':'end';}
function labelAlign(ctx){const v=ctx.dataset.data[ctx.dataIndex]||0; const yMax=ctx.chart.scales.y.max||1; return v>(yMax*0.22)?'center':'end';}
function labelColor(ctx){const v=ctx.dataset.data[ctx.dataIndex]||0; const yMax=ctx.chart.scales.y.max||1; return v>(yMax*0.22)?'#ffffff':'#0f172a';}

/* 추세 주석 플러그인(호환 버전) */
const TrendPlugin = {
  id: 'trendArrows',
  afterDatasetsDraw(chart){
    const {ctx, data} = chart;
    const dsPrev = chart.getDatasetMeta(0);
    const dsNow  = chart.getDatasetMeta(1);
    if(!dsPrev || !dsNow) return;

    ctx.save();
    ctx.font = '700 13px Pretendard, Noto Sans KR, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    for(let i=0;i<data.labels.length;i++){
      const barPrev = dsPrev.data[i];
      const barNow  = dsNow.data[i];
      if(!barPrev || !barNow || !barPrev.x || !barNow.x) continue;

      const prevVal = dsPrev.dataset.data[i] || 0;
      const nowVal  = dsNow.dataset.data[i]  || 0;
      const d = nowVal - prevVal;
      const p = prevVal ? (d/prevVal*100) : (nowVal>0 ? 100 : 0);

      const midX = (barPrev.x + barNow.x)/2;
      const yTop = Math.min(barPrev.y, barNow.y) - 10;

      const up = d>0, flat = d===0;
      const color = up ? cssVar('--up') : (flat ? cssVar('--flat') : cssVar('--down'));
      const sym   = up ? '↖ ▲' : (flat ? '•' : '↘ ▼');
      const text  = `${sym} ${Math.abs(p).toFixed(1)}%`;

      // 배경 상자(라운드 사각형 폴리필)
      const padX=8, padY=6;
      const w = ctx.measureText(text).width + padX*2;
      const h = 22;
      const x = midX - w/2, y = yTop - h;

      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      roundRectPath(ctx, x, y, w, h, 6);
      ctx.fill();

      // 텍스트
      ctx.fillStyle = color;
      ctx.fillText(text, midX, yTop - 4);
    }
    ctx.restore();
  }
};

/* 시간 막대(적용·연장·휴일) */
function drawHoursAll(ctxRef, prevApplied, nowApplied, prevOverH, nowOverH, prevHolH, nowHolH){
  if(ctxRef._chart) ctxRef._chart.destroy();
  const labels=['적용시간(h)','연장근무(h)','휴일근무(h)'];
  const prev=[prevApplied, prevOverH, prevHolH];
  const now=[nowApplied,  nowOverH,  nowHolH];
  const maxVal=Math.max(...prev,...now,0);
  const step=maxVal>0?Math.ceil(maxVal/8):1;

  ctxRef._chart=new Chart(ctxRef,{
    type:'bar',
    plugins:[ChartDataLabels, TrendPlugin],
    data:{labels,datasets:[
      {label:'전월', data:prev, backgroundColor:cssVar('--bar-prev'), order:1, barThickness:32, categoryPercentage:0.6, barPercentage:0.9},
      {label:'당월', data:now,  backgroundColor:cssVar('--bar-now'),  order:2, barThickness:32, categoryPercentage:0.6, barPercentage:0.9}
    ]},
    options:{
      layout:{padding:{top:36}},
      plugins:{
        legend:{display:true,position:'bottom'},
        datalabels:{
          anchor:labelAnchor, align:labelAlign, offset:4, clip:false,
          color:labelColor,
          backgroundColor:(ctx)=>labelColor(ctx)==='#ffffff'?'rgba(0,0,0,0.18)':'rgba(255,255,255,0.9)',
          borderRadius:4, padding:4, font:{weight:'700'},
          formatter:(v)=> (v%1===0)?v.toString():v.toFixed(1)
        }
      },
      scales:{
        y:{beginAtZero:true, suggestedMax:maxVal*1.25, ticks:{stepSize:step}, grid:{color:'#eaecef'}},
        x:{grid:{display:false}}
      }
    }
  });
}

/* 금액 포맷 */
function toMillions1(v){return (Number(v)/1_000_000).toFixed(1);}

/* 수당 막대(시간외·휴일·총) */
function drawPays(ctxRef, prevOver, nowOver, prevHol, nowHol, prevSum, nowSum){
  if(ctxRef._chart) ctxRef._chart.destroy();
  const labels=['시간외수당','휴일수당','총수당'];
  const prev=[prevOver, prevHol, prevSum];
  const now=[nowOver,  nowHol,  nowSum];
  const maxVal=Math.max(...prev,...now,0);
  const step=maxVal>0?Math.ceil(maxVal/8):1;

  ctxRef._chart=new Chart(ctxRef,{
    type:'bar',
    plugins:[ChartDataLabels, TrendPlugin],
    data:{labels,datasets:[
      {label:'전월', data:prev, backgroundColor:cssVar('--bar-prev'), order:1, barThickness:32, categoryPercentage:0.6, barPercentage:0.9},
      {label:'당월', data:now,  backgroundColor:cssVar('--bar-now'),  order:2, barThickness:32, categoryPercentage:0.6, barPercentage:0.9}
    ]},
    options:{
      layout:{padding:{top:40}},
      plugins:{
        legend:{display:true,position:'bottom'},
        datalabels:{
          anchor:labelAnchor, align:labelAlign, offset:4, clip:false,
          color:labelColor,
          backgroundColor:(ctx)=>labelColor(ctx)==='#ffffff'?'rgba(0,0,0,0.18)':'rgba(255,255,255,0.9)',
          borderRadius:4, padding:4, font:{weight:'800'},
          formatter:(v)=> toMillions1(v)+'백만'
        }
      },
      scales:{
        y:{beginAtZero:true, suggestedMax:maxVal*1.28, ticks:{ stepSize: step, callback:(v)=> toMillions1(v)+'백만' }, grid:{color:'#eaecef'}},
        x:{grid:{display:false}}
      }
    }
  });
}

/* 리포트 */
const appliedLine1El=$('appliedLine1'), appliedLine2El=$('appliedLine2');
const overPayLine1El=$('overPayLine1'), overPayLine2El=$('overPayLine2');
const holPayLine1El=$('holPayLine1'),  holPayLine2El=$('holPayLine2');

function renderReport(cur){
  const M=cur.metrics;
  const nowApplied=M.appliedTotal||0, nowOverPay=M.overPay||0, nowHolPay=M.holPay||0, nowSum=nowOverPay+nowHolPay;
  const nowOverH=M.overHours||0, nowHolH=M.holHours||0;

  const prevApplied=prevMetrics?.appliedTotal||0;
  const prevOverPay=prevMetrics?.overPay||0;
  const prevHolPay=prevMetrics?.holPay||0;
  const prevSum=prevOverPay+prevHolPay;
  const prevOverH=prevMetrics?.overHours||0;
  const prevHolH=prevMetrics?.holHours||0;

  appliedLine1El.textContent=`당월: ${nowApplied.toFixed(1)}h (전월: ${prevApplied.toFixed(1)}h)`;
  overPayLine1El.textContent=`당월: ${nowOverPay.toLocaleString()} (전월: ${prevOverPay.toLocaleString()})`;
  holPayLine1El.textContent =`당월: ${nowHolPay.toLocaleString()} (전월: ${prevHolPay.toLocaleString()})`;

  const dA = deltaObj(nowApplied, prevApplied);
  const dO = deltaObj(nowOverPay, prevOverPay);
  const dH = deltaObj(nowHolPay,  prevHolPay);

  setArrowSpans(appliedLine2El, dA,'h',false);
  setArrowSpans(overPayLine2El, dO,'원',true);
  setArrowSpans(holPayLine2El,  dH,'원',true);

  sumPayNow.textContent=nowSum.toLocaleString();
  const dSum=deltaObj(nowSum, prevSum);
  const cls = dSum.up? 'up' : (dSum.flat? 'flat':'down');
  const sym = dSum.up? '↖ ▲' : (dSum.flat? '•' : '↘ ▼');
  $('sumPayDeltaAbs').innerHTML=`<span class="${cls} arrow">${sym}</span><span class="${cls}">${Math.abs(dSum.d).toLocaleString()}원</span>`;
  $('sumPayDeltaPct').innerHTML=`<span class="${cls} arrow">${sym}</span><span class="${cls}">${Math.abs(dSum.p).toFixed(1)}%</span>`;

  // 도넛
  const nowEtc=Math.max(0, nowApplied-(nowOverH+nowHolH));
  const prevEtc=Math.max(0, prevApplied-(prevOverH+prevHolH));
  drawDoughnut(donutPrev, ['연장시간','휴일시간','기타'], [prevOverH, prevHolH, prevEtc], false);
  drawDoughnut(donutNow,  ['연장시간','휴일시간','기타'], [nowOverH,  nowHolH,  nowEtc],  true);
  footPrev.textContent=`연장시간 ${prevOverH.toFixed(1)}h · 휴일시간 ${prevHolH.toFixed(1)}h · 총수당 ${prevSum.toLocaleString()}원`;
  footNow.textContent =`연장시간 ${nowOverH.toFixed(1)}h · 휴일시간 ${nowHolH.toFixed(1)}h · 총수당 ${nowSum.toLocaleString()}원`;

  // 막대
  drawHoursAll(barHoursAll, prevApplied, nowApplied, prevOverH, nowOverH, prevHolH, nowHolH);
  drawPays(barPays, prevOverPay, nowOverPay, prevHolPay, nowHolPay, prevSum, nowSum);

  updatePrevBadge();
}

/* 테이블 렌더 & 저장 */
const tblStatus=$('tblStatus'), tblSummary=$('tblSummary'), tblNext=$('tblNext');
function renderStatusTable(rows){
  if(!rows||!rows.length){ tblStatus.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const cols=Object.keys(rows[0]);
  let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const sub={근무시간:0,휴게시간:0,적용시간:0,정수:0};
  rows.forEach(r=>{sub.근무시간+=toNum(r['근무시간']);sub.휴게시간+=toNum(r['휴게시간']);sub.적용시간+=toNum(r['적용시간']);sub.정수+=toNum(r['정수']);});
  const tbody='<tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  let tds=cols.map(c=>{
    if(c==='근무시간') return `<td style="text-align:right">${sub.근무시간.toFixed(2)}</td>`;
    if(c==='휴게시간') return `<td style="text-align:right">${sub.휴게시간.toFixed(2)}</td>`;
    if(c==='적용시간') return `<td style="text-align:right">${sub.적용시간.toFixed(2)}</td>`;
    if(c==='정수')     return `<td style="text-align:right">${sub.정수.toLocaleString()}</td>`;
    if(c==='순번')     return `<td>소계</td>`;
    return `<td></td>`;
  }).join('');
  const tfoot=`<tfoot><tr>${tds}</tr></tfoot>`;
  tblStatus.innerHTML=thead+tbody+tfoot;
}
function renderSummaryTable(rows){
  if(!rows||!rows.length){ tblSummary.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const ORDER=['순번','부서','이름','근무시간','휴게시간','적용시간','평일연장','평일야간','휴일일반','휴일연장','휴일야간','휴일연장야간','시간외수당','휴일수당'];
  const colsAll=Object.keys(rows[0]); const cols=ORDER.filter(c=>colsAll.includes(c));
  let thead=`<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
  let tbody='<tbody>'+rows.map(r=>{
    const tds=cols.map(c=>{
      const isHour=['근무시간','휴게시간','적용시간','평일연장','평일야간','휴일일반','휴일연장','휴일야간','휴일연장야간'].includes(c);
      const isMoney=(c==='시간외수당'||c==='휴일수당');
      const txt=isHour?toNum(r[c]).toFixed(1):(isMoney?toNum(r[c]).toLocaleString():(r[c]??''));
      const right=(isHour||isMoney)?' style="text-align:right"':'';
      return `<td${right}>${txt}</td>`;
    }).join('');
    return `<tr>${tds}</tr>`;
  }).join('')+'</tbody>';
  const sub={}; cols.forEach(c=>sub[c]=rows.reduce((a,b)=>a+toNum(b[c]),0));
  const tds=cols.map(c=>{
    const isHour=['근무시간','휴게시간','적용시간','평일연장','평일야간','휴일일반','휴일연장','휴일야간','휴일연장야간'].includes(c);
    const isMoney=(c==='시간외수당'||c==='휴일수당');
    const txt=isHour?sub[c].toFixed(1):(isMoney?sub[c].toLocaleString():(c==='순번'?'소계':'' ));
    const right=(isHour||isMoney||['근무시간','휴게시간','적용시간'].includes(c))?' style="text-align:right"':'';
    return `<td${right}>${txt}</td>`;
  }).join('');
  const tfoot=`<tfoot><tr>${tds}</tr></tfoot>`;
  tblSummary.innerHTML=thead+tbody+tfoot;
}
function renderNextTable(rows){
  const clean=(rows||[]).filter(r=>r&&Object.values(r).some(v=>v!=null && String(v).trim()!==""));
  if(!clean.length){ tblNext.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const cols=Object.keys(clean[0]); let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  let tbody='<tbody>'+clean.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  tblNext.innerHTML=thead+tbody;
}

/* 실행 & 저장 */
let currentResult=null;
$('startSim').addEventListener('click', ()=>{
  try{ const r=process(attRows,wageRows); currentResult=r; dfStatus=r.status; dfSummary=r.summary; dfNext=r.next; renderReport(r); renderStatusTable(r.status); renderSummaryTable(r.summary); renderNextTable(r.next); showToast('시뮬레이션 완료'); gotoStep(2);}
  catch(err){showToast('시뮬레이션 실패: '+err.message); console.error(err);}
});
$('btnPrevReset').addEventListener('click', ()=>{prevAttRows=null; prevWageRows=null; prevMetrics=null; $('prevAllStatus').textContent='전월 통합자료: 미업로드'; updatePrevStatusTexts(); updatePrevBadge(); if(currentResult) renderReport(currentResult); showToast('전월 데이터가 초기화되었습니다.');});

const companyPrefix="ATEC";
function toSheet(rows){return XLSX.utils.json_to_sheet(rows);}
function saveXlsx(filename, sheets){const wb=XLSX.utils.book_new(); sheets.forEach(s=>XLSX.utils.book_append_sheet(wb,s.ws,s.name)); const now=new Date(); const tag=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`; const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'}); const blob=new Blob([wbout],{type:"application/octet-stream"}); saveAs(blob, `${companyPrefix}_${filename}_${tag}.xlsx`);}
$('btnSaveStatus').addEventListener('click', ()=>{if(!dfStatus.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태현황',[{name:'근태현황',ws:toSheet(dfStatus)}]);});
$('btnSaveSummary').addEventListener('click', ()=>{if(!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태정리',[{name:'근태정리',ws:toSheet(dfSummary)}]);});
$('btnSaveNext').addEventListener('click', ()=>{if(!dfNext.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('익월적용',[{name:'익월적용',ws:toSheet(dfNext)}]);});
$('btnSaveAll').addEventListener('click', ()=>{if(!dfStatus.length||!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태_통합',[{name:'근태현황',ws:toSheet(dfStatus)},{name:'근태정리',ws:toSheet(dfSummary)},{name:'익월적용',ws:toSheet(dfNext||[])}]); showToast('통합 저장 완료');});
</script>
</body>
</html>
