<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATEC 인사관리(근태) · 1~4 페이지 통합본</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;--accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;--dark:#111827;--softblue:#e6efff;--softred:#ffe7e7;}
*{box-sizing:border-box}
body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}
.topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
.stepper{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
.step{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.2s;cursor:pointer}
.step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
.step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
.step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
.chev{flex:1;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);min-width:40px}
main{max-width:1200px;margin:18px auto;padding:0 16px}
.page{display:none;opacity:0;transform:translateY(6px);transition:opacity .28s ease,transform .28s ease}
.page.show{display:block;opacity:1;transform:none}
.card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.upload-box{border:2px dashed var(--line);border-radius:12px;padding:22px;text-align:center;background:#fbfdff}
.upload-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}
.upload-row .upload-box{min-height:130px}
.upload-action{display:flex;justify-content:center;margin-top:16px}
input[type=file]{display:none}
.pick{background:var(--dark);color:#fff;padding:10px 18px;border-radius:10px;font-weight:800;cursor:pointer;display:inline-block}
.pick.flash{background:var(--ok);animation:flash 1.1s ease-out}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
.filename{display:block;color:var(--muted);margin-top:10px;min-height:20px}
.btn{background:var(--dark);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
.btn:hover{background:var(--accent1)} .btn[disabled]{background:#9ca3af;cursor:not-allowed}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.kpi{border:1px solid var(--line);border-radius:16px;padding:14px;text-align:center;display:flex;flex-direction:column;align-items:center}
.kpi h4{margin:0;color:var(--muted);font-size:14px}
.kpi .big{font-size:28px;font-weight:700;margin-top:6px}
.kpi .small{font-size:13px;color:#374151;line-height:1.95;margin-top:4px}
.kpi .changeSmall{font-size:14px;margin-top:4px;line-height:1.3}
.chart-row{display:flex;gap:22px;justify-content:center;flex-wrap:wrap;align-items:flex-start}
.chart-box{width:460px;max-width:45vw;text-align:center}
.chart-box canvas{max-height:240px}
.chart-box p{font-size:15px;font-weight:800;margin:.6rem 0 0}
.sum-card h2{margin:0;font-size:22px}
.sum-meta{line-height:1.95;margin-top:4px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px 10px;text-align:center;font-size:.92rem;background:#fff}
th{background:#f3f4f6}
.subtotal{background:#f9fafb;font-weight:800;border-top:2px solid #9ca3af}
.group-red{box-shadow:inset 0 0 0 2px var(--softred);border-radius:8px}
.group-blue{box-shadow:inset 0 0 0 2px var(--softblue);border-radius:8px}
.next-wrap{overflow-x:auto;overflow-y:hidden;border:1px solid var(--line);border-radius:12px}
.next-inner{min-width:920px}
.save-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.btn-merge{background:#2563eb}
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10000}
.panel{background:#fff;max-width:720px;width:92vw;border-radius:16px;box-shadow:0 16px 60px rgba(0,0,0,.35);padding:18px}
.grid-map{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cell{display:flex;align-items:center;gap:10px}
.cell label{min-width:180px;font-weight:700}
select{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px}
</style>
</head>
<body>
<header>ATEC 인사관리(근태) 프로그램</header>
<div class="topbar">
  <div class="stepper">
    <div class="step active" data-step="1"><div class="num">1</div>업로드</div>
    <div class="chev"></div>
    <div class="step" data-step="2"><div class="num">2</div>리포트</div>
    <div class="chev"></div>
    <div class="step" data-step="3"><div class="num">3</div>세부내역</div>
    <div class="chev"></div>
    <div class="step" data-step="4"><div class="num">4</div>데이터 저장</div>
  </div>
</div>
<main>
<section id="page1" class="page show">
  <div class="card">
    <h2 style="margin:0 0 10px 0">안내사항</h2>
    <ul style="margin:8px 0 6px 18px;line-height:1.7">
      <li>산정기간: <b>전월 21일 ~ 당월 20일</b> (결재 완료 기준)</li>
      <li>휴게시간: <b>4시간 초과 시 1시간</b> 자동 부여</li>
      <li>주 52시간 기준: 휴일/야간근무는 <b>주 12시간 이내</b> 신청 가능</li>
      <li>필요 RAW 데이터(2개)</li>
    </ul>
    <div style="padding-left:10px">
      <div style="margin:10px 0">1) 그룹웨어-시간외근무 승인(관리자) 데이터</div>
      <div style="margin:10px 0">2) ERP-책정임근현황(통상시급)</div>
    </div>
  </div>
  <div class="card">
    <h2 style="margin:0 0 10px 0">데이터 업로드</h2>
    <div class="upload-grid">
      <div class="upload-box">
        <label class="pick" for="curAtt">근태 RAW</label>
        <input id="curAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curAttName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="curWage">통상시급</label>
        <input id="curWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curWageName" class="filename">선택된 파일 없음</span>
      </div>
    </div>
    <p style="margin:18px 0 6px;color:#374151;font-weight:800">[전월 자료] (선택사항)</p>
    <div class="upload-row">
      <div class="upload-box">
        <label class="pick" for="prevAtt">전월 근태 RAW</label>
        <input id="prevAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevAttName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevWage">전월 통상시급</label>
        <input id="prevWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevWageName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevMerged">전월 통합자료(권장)</label>
        <input id="prevMerged" type="file" accept=".xlsx,.xls,.xlsm" />
        <span id="prevMergedName" class="filename">선택된 파일 없음 (근태_통합 또는 근태정리 시트)</span>
      </div>
    </div>
    <div class="upload-action">
      <button id="btnRun" class="btn" disabled>시뮬레이션 시작</button>
    </div>
  </div>
</section>
<section id="page2" class="page">
  <div class="card sum-card" style="text-align:center">
    <h2 id="sumTitle">총 수당(시간외+휴일) 0원</h2>
    <p class="sum-meta" id="sumMeta">당월: 0원 (전월: 0원)</p>
    <p class="sum-meta" id="sumDelta" style="color:#2563eb">▼ 0원 (0.0%)</p>
  </div>
  <div class="card">
    <div class="summary-grid">
      <div class="kpi">
        <h4>총 적용시간</h4>
        <div class="big" id="appliedNow">0.0h</div>
        <div class="small" id="appliedSmall"></div>
        <div class="changeSmall" id="appliedChange"></div>
      </div>
      <div class="kpi">
        <h4>시간외수당</h4>
        <div class="big" id="overPayNow">0원</div>
        <div class="small" id="overPaySmall"></div>
        <div class="changeSmall" id="overPayChange"></div>
      </div>
      <div class="kpi">
        <h4>휴일수당</h4>
        <div class="big" id="holPayNow">0원</div>
        <div class="small" id="holPaySmall"></div>
        <div class="changeSmall" id="holPayChange"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="chart-row">
      <div class="chart-box">
        <p>전월 시간/수당 비율</p>
        <canvas id="donutPrev"></canvas>
      </div>
      <div class="chart-box">
        <p>당월 시간/수당 비율</p>
        <canvas id="donutNow"></canvas>
      </div>
    </div>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0">전월 대비 비교 차트</h3>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barHours"></canvas>
        <p style="margin:.6rem 0 0">시간 비교(적용·연장·휴일) — 전월(파랑) vs 당월(연한 빨강)</p>
      </div>
    </div>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barPays"></canvas>
        <p style="margin:.6rem 0 0">수당 비교(총·시간외·휴일) — 전월(파랑) vs 당월(연한 빨강)</p>
      </div>
    </div>
  </div>
</section>
<section id="page3" class="page">
  <div class="card">
    <h2 style="margin-top:0">근태현황</h2>
    <table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>근태정리</h2>
    <table id="tblSummary"><thead><tr><th>데이터 없음</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>익월적용</h2>
    <div class="next-wrap"><div class="next-inner">
      <table id="tblNext"><thead><tr><th>익월 적용 데이터 없음</th></tr></thead></table>
    </div></div>
  </div>
</section>
<section id="page4" class="page">
  <div class="card">
    <h2 style="margin-top:0">엑셀 다운로드</h2>
    <p class="muted" style="margin-top:-4px">버튼을 클릭하면 .xlsx 저장 창이 열립니다.</p>
    <div class="save-row">
      <button class="btn" id="btnSaveStatus">근태현황 저장</button>
      <button class="btn" id="btnSaveSummary">근태정리 저장</button>
      <button class="btn" id="btnSaveNext">익월적용 저장</button>
      <button class="btn btn-merge" id="btnSaveAll">통합저장</button>
    </div>
    <p class="muted" style="margin-top:10px">※ 통합저장은 전월 데이터 보관을 하지 않습니다. 전월 비교는 1페이지의 <b>전월 자료 업로드</b>로 지정하세요.</p>
  </div>
</section>
</main>
<div class="modal" id="mapModal">
  <div class="panel">
    <h3 id="mapTitle" style="margin:0 0 8px 0">헤더 매핑</h3>
    <p class="muted" style="margin-top:0">업로드한 파일의 열 이름을 아래 표준 항목에 연결하세요.</p>
    <div class="grid-map" id="mapGrid"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn" id="btnMapCancel" style="background:#6b7280">취소</button>
      <button class="btn" id="btnMapOk">매핑 완료</button>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
Chart.register(ChartDataLabels);
const $ = id => document.getElementById(id);
const showToast = msg => {
  const t = $('toast'); t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000);
};
const number = v => {
  const n = Number(String(v ?? '').toString().replace(/[, ]/g, ''));
  return isNaN(n) ? 0 : n;
};
const hourMod24 = t => t - 24 * Math.floor(t / 24);
function parseTime(s) {
  if (s == null) return -1; let st = String(s).trim().replace(/\s+/g, '');
  st = st.replace('시', ':').replace('분', '');
  if (!st.includes(':')) {
    if (!/^\d+$/.test(st)) return -1;
    const n = parseInt(st, 10); if (st.length <= 2) return n; if (st.length <= 4) return Math.floor(n / 100) + (n % 100) / 60; return -1;
  }
  let [h, m] = st.split(':'); h = parseInt(h, 10); m = parseInt(m, 10);
  if (isNaN(h) || isNaN(m) || m < 0 || m >= 60) return -1; return h + m / 60;
}
const ceilHalf = x => Math.ceil(Number(x) / 0.5) * 0.5;
const fmtHM = d => {
  const h = Math.floor(d) % 24; const m = Math.round((d - Math.floor(d)) * 60) % 60; return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
};
const sum = (rows, key) => rows.reduce((a, r) => a + number(r[key]), 0);
// Header mappings and normalization omitted for brevity, keep previous patterns from above
// Attach pickers and mapping for RAW, WAGE, previous data -- same as previous

// After loading curAttRows, extract dfNext for 익월적용 rows where 종결일자 is empty:
function updateDfNext() {
  if (!curAttRows.length) return;
  const closeDateKey = Object.keys(curAttRows[0]).find(key => key.includes('종결일자')) || '종결일자';
  dfNext = curAttRows.filter(r => !r[closeDateKey] || r[closeDateKey] === null || r[closeDateKey] === '');
  renderNextTable(dfNext);
}
// call this inside upload handler for RAW files

// The process function with all logic including 수당 calculations and metrics:
function process(attRows, wageRows) {
  const status = [], agg = {};
  const ensure = (name, dept) => { if (!agg[name]) agg[name] = { 부서: dept, 이름: name, 근무시간: 0, 휴게시간: 0, 적용시간: 0, 평일연장: 0, 평일야간: 0, 휴일일반: 0, 휴일연장: 0, 휴일야간: 0, 휴일연장야간: 0 }; };
  for (const r of attRows) {
    if (String(r['상태'] || '').includes('반려')) continue;
    const raw = String(r['신청시간'] || ''); if (!raw.includes('~')) continue;
    let [s, e] = raw.split('~').map(x => x.trim()); let sh = parseTime(s), eh = parseTime(e); if (sh < 0 || eh < 0) continue; if (eh < sh) eh += 24;
    const work = eh - sh, brk = Math.floor(work / 5), applied = work - brk;
    status.push({ 부서: r['근무자 부서'], 이름: r['근무자'], 근무일자: r['근무일'], 근무유형: r['근무유형'], 근무시작시간: fmtHM(sh), 근무종료시간: fmtHM(eh), 근무시간: +work.toFixed(2), 휴게시간: +brk.toFixed(2), 적용시간: +applied.toFixed(2), 정수: ceilHalf(applied) });
    const nm = String(r['근무자'] || '').replace('(IT)', '').trim(); if (!nm) continue; const dept = r['근무자 부서']; const ty = String(r['근무유형'] || '').toLowerCase();
    ensure(nm, dept); const A = agg[nm]; A.근무시간 += work; A.휴게시간 += brk; A.적용시간 += applied;
    let effStart = sh + brk; if (effStart > eh) effStart = eh;
    for (let t = effStart; t < eh - 1e-6; t += 0.25) {
      const hod = hourMod24(t); const worked = t - effStart;
      if (ty.includes('연장') && !ty.includes('휴일')) { if (hod >= 18 && hod < 22) A.평일연장 += 0.25; if (hod >= 22 || hod < 6) A.평일야간 += 0.25; }
      else if (ty.includes('휴일')) {
        if (worked < 8) { if (hod >= 6 && hod < 22) A.휴일일반 += 0.25; else A.휴일야간 += 0.25; }
        else { if (hod >= 6 && hod < 22) A.휴일연장 += 0.25; else A.휴일연장야간 += 0.25; }
      }
    }
  }
  const summary = Object.values(agg).map((A, i) => ({
    순번: i + 1, 부서: A.부서, 이름: A.이름, 근무시간: +A.근무시간.toFixed(2), 휴게시간: +A.휴게시간.toFixed(2), 적용시간: +A.적용시간.toFixed(2),
    평일연장: +A.평일연장.toFixed(2), 평일야간: +A.평일야간.toFixed(2), 휴일일반: +A.휴일일반.toFixed(2), 휴일연장: +A.휴일연장.toFixed(2), 휴일야간: +A.휴일야간.toFixed(2), 휴일연장야간: +A.휴일연장야간.toFixed(2)
  }));
  if (wageRows && wageRows.length) {
    const map = new Map();
    wageRows.forEach(r => map.set(`${String(r['부서'] || '').trim()}|${String(r['이름'] || '').trim()}`, number(r['통상시급'])));
    const mult = { 평일연장: 1.5, 평일야간: 2.0, 휴일일반: 1.5, 휴일연장: 2.0, 휴일야간: 2.0, 휴일연장야간: 2.5 };
    summary.forEach(r => {
      const base = map.get(`${r.부서}|${r.이름}`) || 0;
      r['시간외수당'] = Math.ceil(base * mult.평일연장 * r.평일연장) + Math.ceil(base * mult.평일야간 * r.평일야간);
      r['휴일수당'] = Math.ceil(base * mult.휴일일반 * r.휴일일반) + Math.ceil(base * mult.휴일연장 * r.휴일연장) + Math.ceil(base * mult.휴일야간 * r.휴일야간) + Math.ceil(base * mult.휴일연장야간 * r.휴일연장야간);
    });
  }
  const overHours = summary.reduce((a, r) => a + r.평일연장 + r.평일야간, 0);
  const holHours = summary.reduce((a, r) => a + r.휴일일반 + r.휴일연장 + r.휴일야간 + r.휴일연장야간, 0);
  const appliedTotal = status.reduce((a, r) => a + number(r.적용시간), 0);
  let overPay = 0, holPay = 0;
  if (wageRows && wageRows.length) {
    summary.forEach(r => {
      overPay += number(r['시간외수당']);
      holPay += number(r['휴일수당']);
    });
  }
  return { status, summary, next: dfNext, metrics: { appliedTotal, overHours, holHours, overPay, holPay, totalPay: overPay + holPay } };
}
/* ===== 차트, 리포트, UI Functions (omitted for brevity, same as shown previously, including the revamped renderReport that formats with 3 lines for each KPI) ===== */
/* ===== Event Handler ===== */
$('btnRun').addEventListener('click', () => {
  try {
    const cur = process(curAttRows, curWageRows);
    dfStatus = cur.status; dfSummary = cur.summary; dfNext = cur.next;
    let prev = { appliedTotal: 0, overHours: 0, holHours: 0, overPay: 0, holPay: 0, totalPay: 0 };
    if (prevMergedMetrics) prev = prevMergedMetrics;
    else if (prevAttRows.length && prevWageRows.length) prev = process(prevAttRows, prevWageRows).metrics;
    renderTable(tblStatus, dfStatus);
    renderSummaryTable(dfSummary);
    renderNextTable(dfNext);
    renderReport(cur.metrics, prev);
    setActiveStep(2); goto(2);
    showToast('시뮬레이션 완료');
  } catch (err) { console.error(err); showToast('실패: ' + err.message); }
});
/* ===== Utility Navigation Functions & Initialization ===== */
function goto(n) { const pages = [...document.querySelectorAll('.page')]; pages.forEach(p => { p.classList.remove('show'); p.style.display = 'none'; }); const tgt = $('page' + n); tgt.style.display = 'block'; requestAnimationFrame(() => tgt.classList.add('show')); window.scrollTo({ top: 0, behavior: 'smooth' }); }
function setActiveStep(n) { document.querySelectorAll('.step').forEach(x => x.classList.remove('active')); document.querySelector(`.step[data-step="${n}"]`).classList.add('active'); }
document.querySelectorAll('.step').forEach(s => s.addEventListener('click', () => { const n = Number(s.dataset.step); setActiveStep(n); goto(n); }));
goto(1);
</script>
</body>
</html>
