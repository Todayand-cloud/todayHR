<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ATEC 인사관리(근태) 프로그램</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --line:#e5e7eb; --ink:#111827; --muted:#6b7280;
    --accent1:#2563eb; --accent2:#ef4444; --ok:#16a34a; --dark:#111827;
  }
  *{box-sizing:border-box}
  body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  header{background:#fff;padding:12px 20px;font-weight:800;border-bottom:1px solid var(--line)}

  /* 상단 고정 스텝 네비게이션 */
  .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line)}
  .stepper{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .step{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.25s}
  .step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
  .step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
  .step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
  .chev{flex:1 1 auto;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);position:relative;min-width:40px}
  .chev:after{content:"";position:absolute;right:-8px;top:-6px;border:8px solid transparent;border-left-color:#e5e7eb;opacity:.7}

  main{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}

  /* 페이지 전환 효과 */
  .page{display:none;opacity:0;transform:translateY(8px);transition:opacity .35s ease,transform .35s ease}
  .page.show{display:block;opacity:1;transform:none}

  /* 업로드 */
  .upload{display:flex;gap:16px;flex-wrap:wrap}
  .upload-card{flex:1 1 48%;border:2px dashed var(--line);border-radius:12px;padding:20px;text-align:center;background:#fbfdff}
  input[type=file]{display:none}
  label.pick{background:var(--dark);color:#fff;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-block}
  label.pick.flash{background:var(--ok);animation:flash 1.2s ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
  .filename{display:block;color:var(--muted);margin-top:8px;min-height:20px}
  .btn{background:var(--dark);color:#fff;border:none;border-radius:12px;padding:14px 24px;cursor:pointer;font-weight:700}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed}
  .btn:not([disabled]):hover{background:var(--accent1)}

  /* KPI/차트 */
  .summary-grid{display:grid;grid-template-columns:1.1fr .9fr .9fr;gap:16px;align-items:stretch}
  .kpi{border:1px solid var(--line);border-radius:16px;padding:18px;display:flex;flex-direction:column;justify-content:center}
  .kpi h3{margin:0;color:var(--muted);font-size:14px}
  .kpi .big{font-size:40px;font-weight:900;line-height:1.1;letter-spacing:-.5px}
  .kpi .small{color:#374151;margin-top:8px;font-size:13px}
  .charts{display:flex;gap:24px;justify-content:center;flex-wrap:wrap}
  .chart-box{width:260px;text-align:center}
  canvas{width:100%;height:auto}

  /* 비교 카드 */
  .compare{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .cmp{border:1px dashed var(--line);border-radius:14px;padding:12px 14px;background:#fbfdff}
  .cmp h4{margin:0 0 8px 0;font-size:13px;color:#374151}
  .cmp .row{display:flex;justify-content:space-between;font-size:14px}
  .cmp .delta.up{color:#ef4444;font-weight:700}
  .cmp .delta.down{color:#16a34a;font-weight:700}
  .muted{color:#6b7280}

  /* 테이블 */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:center;font-size:.92rem}
  th{background:#f3f4f6;position:sticky;top:0}

  /* 안내 간격 */
  .guide-tight p + p{margin-top:10px}
  .guide-spaced .line{margin:8px 0}

  .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2)}
</style>
</head>
<body>
  <header>ATEC 인사관리(근태) 프로그램</header>

  <!-- 상단 고정 스텝 네비: 1→2→3→4 -->
  <div class="topbar">
    <div class="stepper" id="stepper">
      <div class="step active" data-target="1"><div class="num">1</div><div>업로드</div></div>
      <div class="chev"></div>
      <div class="step" data-target="2"><div class="num">2</div><div>리포트</div></div>
      <div class="chev"></div>
      <div class="step" data-target="3"><div class="num">3</div><div>세부내역</div></div>
      <div class="chev"></div>
      <div class="step" data-target="4"><div class="num">4</div><div>데이터 저장</div></div>
    </div>
  </div>

  <main>
    <!-- 1. 업로드 -->
    <section id="page1" class="page show">
      <div class="card guide-tight">
        <h2>안내사항</h2>
        <p>✔ 산정기간: 전월 21일 ~ 당월 20일 (결재 완료 기준)</p>
        <p>✔ 휴게시간: 4시간 초과 시 1시간 부여</p>
        <p>✔ 주 52시간 근무제에 따라 휴일/야간근무는 주 12시간 이내 신청 가능</p>
        <p>✔ 필요 RAW 데이터(2개)</p>
        <div class="guide-spaced" style="padding-left:10px">
          <div class="line">1) 그룹웨어-시간외근무 승인(관리자) 데이터</div>
          <div class="line">2) ERP-책정임근현황(통상시급)</div>
        </div>
      </div>

      <div class="card">
        <h2>데이터 업로드</h2>
        <div class="upload">
          <div class="upload-card">
            <label class="pick" for="fileAtt">근태 RAW 업로드</label>
            <input type="file" id="fileAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameAtt">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="fileWage">통상시급 업로드</label>
            <input type="file" id="fileWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameWage">선택된 파일 없음</span>
          </div>
        </div>
        <div style="text-align:center;margin-top:20px;">
          <button class="btn" id="startSim" disabled>시뮬레이션 시작</button>
        </div>
      </div>
    </section>

    <!-- 2. 리포트 -->
    <section id="page2" class="page">
      <div class="card">
        <div class="summary-grid">
          <div class="kpi">
            <h3>총 적용시간</h3>
            <div class="big" id="totalApplied">0.0h</div>
            <div class="small">총 근무시간 <strong id="totalWork">0.0h</strong></div>
            <div class="small">총 수당 <strong id="totalPay">0</strong> 원</div>
          </div>
          <div class="kpi">
            <h3>연장근무</h3>
            <div class="big" id="totalOver">0.0h</div>
            <div class="small">총 수당 <strong id="overPay">0</strong> 원</div>
          </div>
          <div class="kpi">
            <h3>휴일근무</h3>
            <div class="big" id="totalHoliday">0.0h</div>
            <div class="small">총 수당 <strong id="holidayPay">0</strong> 원</div>
          </div>
        </div>
      </div>

      <!-- 전월 비교 업로드 + 현황 -->
      <div class="card">
        <h3 style="margin-top:0">전월 데이터 비교 현황</h3>
        <p class="muted" id="prevHint">전월 비교를 위해 아래 전월 파일을 선택해 주세요. (선택 사항)</p>
        <div class="upload" style="margin-top:8px">
          <div class="upload-card">
            <label class="pick" for="filePrevAtt">전월 근태 RAW 업로드</label>
            <input type="file" id="filePrevAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="namePrevAtt">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="filePrevWage">전월 통상시급 업로드</label>
            <input type="file" id="filePrevWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="namePrevWage">선택된 파일 없음</span>
          </div>
        </div>

        <div class="compare" style="margin-top:14px" id="cmpGrid">
          <div class="cmp">
            <h4>총 적용시간</h4>
            <div class="row"><span>전월</span><strong id="cmpAppliedPrev">-</strong></div>
            <div class="row"><span>당월</span><strong id="cmpAppliedCur">-</strong></div>
            <div class="row"><span>증감</span><strong class="delta" id="cmpAppliedDelta">-</strong></div>
          </div>
          <div class="cmp">
            <h4>연장근무</h4>
            <div class="row"><span>전월</span><strong id="cmpOverPrev">-</strong></div>
            <div class="row"><span>당월</span><strong id="cmpOverCur">-</strong></div>
            <div class="row"><span>증감</span><strong class="delta" id="cmpOverDelta">-</strong></div>
          </div>
          <div class="cmp">
            <h4>휴일근무</h4>
            <div class="row"><span>전월</span><strong id="cmpHolPrev">-</strong></div>
            <div class="row"><span>당월</span><strong id="cmpHolCur">-</strong></div>
            <div class="row"><span>증감</span><strong class="delta" id="cmpHolDelta">-</strong></div>
          </div>
          <div class="cmp">
            <h4>총 수당</h4>
            <div class="row"><span>전월</span><strong id="cmpPayPrev">-</strong></div>
            <div class="row"><span>당월</span><strong id="cmpPayCur">-</strong></div>
            <div class="row"><span>증감</span><strong class="delta" id="cmpPayDelta">-</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;gap:24px;justify-content:center;flex-wrap:wrap">
          <div class="chart-box">
            <canvas id="chartOver"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">연장근무 비율 및 수당</p>
          </div>
          <div class="chart-box">
            <canvas id="chartHoliday"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">휴일근무 비율 및 수당</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 3. 세부내역 -->
    <section id="page3" class="page">
      <div class="card">
        <h2>근태현황</h2>
        <table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table>
      </div>
      <div class="card">
        <h2>근태정리</h2>
        <table id="tblSummary"><thead><tr><th>데이터 없음</th></tr></thead></table>
      </div>
      <div class="card">
        <h2>익월적용</h2>
        <table id="tblNext"><thead><tr><th>데이터 없음</th></tr></thead></table>
      </div>
    </section>

    <!-- 4. 데이터 저장 -->
    <section id="page4" class="page">
      <div class="card">
        <h2 style="margin-top:0">엑셀 다운로드</h2>
        <p class="muted" style="margin-top:-4px">아래 버튼을 클릭하면 해당 표가 .xlsx 파일로 저장됩니다.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn" id="btnSaveStatus">근태현황 저장</button>
          <button class="btn" id="btnSaveSummary">근태정리 저장</button>
          <button class="btn" id="btnSaveNext">익월적용 저장</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- SheetJS & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    /* ---------- 공통 헬퍼 ---------- */
    const $ = (id) => document.getElementById(id);
    const showToast = (msg) => { const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); };

    const pages=[ $('page1'),$('page2'),$('page3'),$('page4') ];
    const steps=[...document.querySelectorAll('.stepper .step')];
    function gotoStep(n){
      steps.forEach(s=>s.classList.remove('active'));
      steps[n-1].classList.add('active');
      pages.forEach(p=>{p.classList.remove('show'); p.style.display='none';});
      const tgt=pages[n-1]; tgt.style.display='block'; requestAnimationFrame(()=>tgt.classList.add('show'));
      window.scrollTo({top:0,behavior:'smooth'});
    }
    steps.forEach(s=>s.addEventListener('click',()=>gotoStep(Number(s.dataset.target))));

    /* ---------- DOM 바인딩 ---------- */
    const totalApplied=$('totalApplied'), totalWork=$('totalWork'), totalOver=$('totalOver'), totalHoliday=$('totalHoliday');
    const overPayEl=$('overPay'), holidayPayEl=$('holidayPay'), totalPayEl=$('totalPay');
    const tblStatus=$('tblStatus'), tblSummary=$('tblSummary'), tblNext=$('tblNext');

    // 전월 비교 DOM
    const cmpAppliedPrev=$('cmpAppliedPrev'), cmpAppliedCur=$('cmpAppliedCur'), cmpAppliedDelta=$('cmpAppliedDelta');
    const cmpOverPrev=$('cmpOverPrev'), cmpOverCur=$('cmpOverCur'), cmpOverDelta=$('cmpOverDelta');
    const cmpHolPrev=$('cmpHolPrev'), cmpHolCur=$('cmpHolCur'), cmpHolDelta=$('cmpHolDelta');
    const cmpPayPrev=$('cmpPayPrev'), cmpPayCur=$('cmpPayCur'), cmpPayDelta=$('cmpPayDelta');

    /* ---------- 유틸 ---------- */
    const REQUIRED=["신청시간","근무자 부서","근무자","근무일","근무유형","종결일자","상태"];
    const date21=new Date(new Date().getFullYear(), new Date().getMonth(), 21);
    function hourMod24(t){ return t - 24*Math.floor(t/24); }
    function parseTime(s){
      if(s==null) return -1;
      let st=String(s).trim();
      if(!st) return -1;
      st=st.replace(/\s+/g,"").replace("시",":").replace("분","");
      if(!st.includes(":")){
        if(!/^\d+$/.test(st)) return -1;
        const n=parseInt(st,10);
        if(st.length<=2) return n;
        if(st.length<=4) return Math.floor(n/100)+(n%100)/60;
        return -1;
      }
      let [h,m]=st.split(":"); h=parseInt(h,10); m=parseInt(m,10);
      if(isNaN(h)||isNaN(m)||m<0||m>=60) return -1;
      return h + m/60;
    }
    const ceilHalf=x=> Math.ceil(Number(x)/0.5)*0.5;
    const fmtHM=d=>{ const h=Math.floor(d)%24; const m=Math.round((d-Math.floor(d))*60)%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };
    const toNum=v=>{ const n=Number(v); return isNaN(n)?0:n; };
    const sum=(arr,key)=> arr.reduce((a,b)=>a+toNum(b[key]),0);

    function renderTable(el, rows){
      if(!rows||!rows.length){ el.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
      const cols=Object.keys(rows[0]);
      let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
      let tbody='<tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
      el.innerHTML=thead+tbody;
    }

    async function fileToRows(file){
      const name=file.name.toLowerCase();
      if(name.endsWith('.csv')){
        const text=await file.text(); return parseCSV(text);
      } else {
        const data=new Uint8Array(await file.arrayBuffer());
        const wb=XLSX.read(data,{type:'array'});
        const pick=wb.Sheets['승인목록'] || wb.Sheets['통상시급'] || wb.Sheets[wb.SheetNames[0]];
        return XLSX.utils.sheet_to_json(pick,{defval:null});
      }
    }
    function parseCSV(text){
      const lines=text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.length>0);
      if(!lines.length) return [];
      const heads=lines[0].split(',').map(s=>s.trim());
      return lines.slice(1).map(line=>{
        const cells=line.split(','); const obj={};
        heads.forEach((h,i)=>obj[h]=cells[i]!==undefined?cells[i]:null);
        return obj;
      });
    }

    function attachPicker(inputId, nameId, onOk){
      const inp=$(inputId), name=$(nameId);
      const lab=document.querySelector(`label[for="${inputId}"]`);
      inp.addEventListener('change', async (e)=>{
        const f=e.target.files[0];
        if(!f){ name.textContent='선택된 파일 없음'; onOk(false); updateStartBtn(); return; }
        name.textContent='파일 분석 중…';
        try{
          const rows= await fileToRows(f);
          if(!rows.length) throw new Error('빈 파일');
          name.textContent='선택 완료 · '+f.name+` (행수: ${rows.length})`;
          lab.classList.remove('flash'); void lab.offsetWidth; lab.classList.add('flash');
          onOk(true, rows);
        } catch(err){
          showToast('파일 파싱 실패: '+err.message);
          name.textContent='선택된 파일 없음'; onOk(false);
        } finally { updateStartBtn(); }
      });
    }

    /* ---------- 현재월 데이터 처리 ---------- */
    let okAtt=false, okWage=false, attRows=[], wageRows=[];
    attachPicker('fileAtt','nameAtt',(ok,rows)=>{ okAtt=!!ok; attRows= ok? rows: []; });
    attachPicker('fileWage','nameWage',(ok,rows)=>{ okWage=!!ok; wageRows= ok? rows: []; });

    function updateStartBtn(){ $('startSim').disabled=!(okAtt && okWage); }

    let dfStatus=[], dfSummary=[], dfNext=[];
    function process(att, wage){
      let _status=[], _summary=[], _next=[];
      const agg={};
      const ensure=(name,dept)=>{ if(!agg[name]) agg[name]={부서:dept,이름:name,근무시간:0,휴게시간:0,적용시간:0,평일연장:0,평일야간:0,휴일일반:0,휴일연장:0,휴일야간:0,휴일연장야간:0}; };

      if(!att.length) throw new Error('근태 RAW 데이터가 비었습니다.');
      const cols=Object.keys(att[0]||{});
      if(!REQUIRED.every(r=>cols.includes(r))) throw new Error('필수 헤더 누락(승인목록): '+REQUIRED.join(', '));

      for(const r of att){
        if(String(r['상태']||'').includes('반려')) continue;
        const raw=String(r['신청시간']||'');
        let closeDate=r['종결일자']? new Date(r['종결일자']):null;
        if(!raw.includes('~')){ if(closeDate && closeDate>=date21) _next.push(r); continue; }

        let [s,e]=raw.split('~').map(x=>x.trim());
        let sh=parseTime(s), eh=parseTime(e); if(sh<0||eh<0){ if(closeDate && closeDate>=date21) _next.push(r); continue; }
        if(eh<sh) eh+=24;

        const work=eh-sh, brk=Math.floor(work/5), applied=work-brk;

        if(closeDate && closeDate<date21){
          _status.push({순번:null,부서:r['근무자 부서'],이름:r['근무자'],근무일자:r['근무일'],근무유형:r['근무유형'],근무시작시간:fmtHM(sh),근무종료시간:fmtHM(eh),근무시간:+work.toFixed(2),휴게시간:+brk.toFixed(2),적용시간:+applied.toFixed(2),정수:ceilHalf(applied)});
          const name=String(r['근무자']||'').replace('(IT)','').trim(); const dept=r['근무자 부서']; const ty=String(r['근무유형']||'').toLowerCase(); ensure(name,dept);
          const A=agg[name]; A.근무시간+=work; A.휴게시간+=brk; A.적용시간+=applied;
          let effStart=sh+brk; if(effStart>eh) effStart=eh;
          for(let t=effStart; t<eh-1e-6; t+=0.25){
            const hod=hourMod24(t); const worked=t-effStart;
            if(ty.includes('연장') && !ty.includes('휴일')){
              if(hod>=18 && hod<22) A.평일연장+=0.25;
              if(hod>=22 || hod<6) A.평일야간+=0.25;
            } else if(ty.includes('휴일')){
              if(worked<8){ if(hod>=6&&hod<22) A.휴일일반+=0.25; else A.휴일야간+=0.25; }
              else { if(hod>=6&&hod<22) A.휴일연장+=0.25; else A.휴일연장야간+=0.25; }
            }
          }
        } else { _next.push(r); }
      }
      _status.forEach((r,i)=> r.순번=i+1);
      _summary=Object.values(agg).map((A,i)=>({순번:i+1,부서:A.부서,이름:A.이름,근무시간:+A.근무시간.toFixed(2),휴게시간:+A.휴게시간.toFixed(2),적용시간:+A.적용시간.toFixed(2),평일연장:+A.평일연장.toFixed(2),평일야간:+A.평일야간.toFixed(2),휴일일반:+A.휴일일반.toFixed(2),휴일연장:+A.휴일연장.toFixed(2),휴일야간:+A.휴일야간.toFixed(2),휴일연장야간:+A.휴일연장야간.toFixed(2)}));

      // 통상시급 수당
      let overPay=0, holPay=0, totalPay=0;
      if(wage && wage.length){
        const cols2=Object.keys(wage[0]);
        const dcol=cols2.includes('부서')?'부서':(cols2[1]||cols2[0]);
        const ncol=cols2.includes('이름')?'이름':(cols2[3]||cols2[0]);
        const wcol=cols2.includes('통상시급')?'통상시급':(cols2.includes('기본시급')?'기본시급':(cols2[cols2.length-1]));
        const map=new Map(); wage.forEach(r=>{ const d=String(r[dcol]||'').trim(); const n=String(r[ncol]||'').trim(); const w=Number(r[wcol]); if(n) map.set(`${d}|${n}`, isNaN(w)?0:w); });
        const mult={평일연장:1.5, 평일야간:2.0, 휴일일반:1.5, 휴일연장:2.0, 휴일야간:2.0, 휴일연장야간:2.5};
        _summary=_summary.map(r=>{
          const key=`${r['부서']}|${r['이름']}`; const base=map.has(key)?map.get(key):0;
          const N=Math.ceil(base*mult.평일연장*toNum(r['평일연장']));
          const O=Math.ceil(base*mult.평일야간*toNum(r['평일야간']));
          const P=Math.ceil(base*mult.휴일일반*toNum(r['휴일일반']));
          const Q=Math.ceil(base*mult.휴일연장*toNum(r['휴일연장']));
          const R=Math.ceil(base*mult.휴일야간*toNum(r['휴일야간']));
          const S=Math.ceil(base*mult.휴일연장야간*toNum(r['휴일연장야간']));
          overPay += (N+O); holPay += (P+Q+R+S);
          return {...r, 시간외수당:N+O, 휴일수당:P+Q+R+S};
        });
        totalPay = overPay + holPay;
      }
      return {
        status:_status, summary:_summary, next:_next,
        metrics:{
          workTotal: sum(_status,'근무시간'),
          appliedTotal: sum(_status,'적용시간'),
          overHours: sum(_summary,'평일연장')+sum(_summary,'평일야간'),
          holHours: sum(_summary,'휴일일반')+sum(_summary,'휴일연장')+sum(_summary,'휴일야간')+sum(_summary,'휴일연장야간'),
          overPay, holPay, totalPay
        }
      };
    }

    function drawDonut(canvasId,percent,amount,color){
      const c=document.getElementById(canvasId); const ctx=c.getContext('2d');
      const dpi=window.devicePixelRatio||1; const W=260,H=260; c.width=W*dpi; c.height=H*dpi; c.style.width=W+'px'; c.style.height=H+'px'; ctx.scale(dpi,dpi);
      const cx=W/2,cy=H/2,r=100; ctx.lineWidth=26;
      ctx.strokeStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke();
      ctx.strokeStyle=color; ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+2*Math.PI*Math.max(0,Math.min(100,percent))/100); ctx.stroke();
      ctx.fillStyle='#111827'; ctx.font='700 22px Pretendard, Noto Sans KR, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText((percent||0).toFixed(1)+'%',cx,cy-10);
      ctx.fillStyle='#6b7280'; ctx.font='600 13px Pretendard, Noto Sans KR, sans-serif'; ctx.fillText((amount||0).toLocaleString()+' 원',cx,cy+16);
    }

    function showCurrentResult(cur){
      const M=cur.metrics;
      totalApplied.textContent=M.appliedTotal.toFixed(1)+'h';
      totalWork.textContent   =M.workTotal.toFixed(1)+'h';
      totalOver.textContent   =M.overHours.toFixed(1)+'h';
      totalHoliday.textContent=M.holHours.toFixed(1)+'h';
      overPayEl.textContent   =(M.overPay||0).toLocaleString();
      holidayPayEl.textContent=(M.holPay||0).toLocaleString();
      totalPayEl.textContent  =(M.totalPay||0).toLocaleString();

      drawDonut('chartOver',   M.appliedTotal? (M.overHours/M.appliedTotal*100):0, M.overPay, '#ef4444');
      drawDonut('chartHoliday',M.appliedTotal? (M.holHours/M.appliedTotal*100):0, M.holPay, '#2563eb');

      renderTable(tblStatus,  cur.status);
      renderTable(tblSummary, cur.summary);
      renderTable(tblNext,    cur.next);
    }

    $('startSim').addEventListener('click', ()=>{
      try{
        const cur=process(attRows, wageRows);
        dfStatus=cur.status; dfSummary=cur.summary; dfNext=cur.next;
        showCurrentResult(cur);
        showToast('시뮬레이션 완료');
        gotoStep(2);
      }catch(err){ showToast('시뮬레이션 실패: '+err.message); console.error(err); }
    });

    /* ---------- 전월 비교 ---------- */
    let prevAtt=[], prevWage=[], okPrevAtt=false, okPrevWage=false;
    attachPicker('filePrevAtt','namePrevAtt',(ok,rows)=>{ okPrevAtt=!!ok; prevAtt=ok?rows:[]; tryCompare(); });
    attachPicker('filePrevWage','namePrevWage',(ok,rows)=>{ okPrevWage=!!ok; prevWage=ok?rows:[]; tryCompare(); });

    function paintDelta(el, delta, unit){
      const v = (unit==='원') ? (delta||0).toLocaleString() : (delta||0).toFixed(1)+'h';
      el.textContent = (delta>0? '▲ ':'▼ ')+(unit==='원' ? Math.abs(delta).toLocaleString() : Math.abs(delta).toFixed(1)+(unit==='원'?'':'h'));
      el.classList.remove('up','down');
      el.classList.add(delta>=0 ? 'up':'down');
    }
    function tryCompare(){
      if(!(okPrevAtt && okPrevWage)) return; // 둘 다 있어야 비교
      try{
        const cur=process(attRows, wageRows);
        const prev=process(prevAtt, prevWage);

        $('prevHint').textContent='전월 파일 업로드 완료(자동 비교)';
        // 값 표시
        cmpAppliedPrev.textContent=prev.metrics.appliedTotal.toFixed(1)+'h';
        cmpAppliedCur.textContent  =cur.metrics.appliedTotal.toFixed(1)+'h';
        paintDelta(cmpAppliedDelta, cur.metrics.appliedTotal - prev.metrics.appliedTotal);

        cmpOverPrev.textContent=prev.metrics.overHours.toFixed(1)+'h';
        cmpOverCur .textContent=cur.metrics.overHours.toFixed(1)+'h';
        paintDelta(cmpOverDelta, cur.metrics.overHours - prev.metrics.overHours);

        cmpHolPrev.textContent=prev.metrics.holHours.toFixed(1)+'h';
        cmpHolCur .textContent=cur.metrics.holHours.toFixed(1)+'h';
        paintDelta(cmpHolDelta, cur.metrics.holHours - prev.metrics.holHours);

        cmpPayPrev.textContent=(prev.metrics.totalPay||0).toLocaleString()+' 원';
        cmpPayCur .textContent=(cur.metrics.totalPay||0).toLocaleString()+' 원';
        paintDelta(cmpPayDelta, (cur.metrics.totalPay||0) - (prev.metrics.totalPay||0), '원');
      }catch(err){ showToast('전월 비교 실패: '+err.message); }
    }

    /* ---------- 엑셀 저장(4페이지) ---------- */
    function toSheet(rows){ return XLSX.utils.json_to_sheet(rows); }
    function saveXlsx(filename, sheets){
      const wb=XLSX.utils.book_new();
      sheets.forEach(s=>XLSX.utils.book_append_sheet(wb, s.ws, s.name));
      const now=new Date();
      const tag=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
      XLSX.writeFile(wb, `${filename}_${tag}.xlsx`);
    }
    $('btnSaveStatus').addEventListener('click', ()=>{
      if(!dfStatus.length) return showToast('먼저 시뮬레이션을 수행하세요.');
      saveXlsx('근태현황', [{name:'근태현황', ws:toSheet(dfStatus)}]);
    });
    $('btnSaveSummary').addEventListener('click', ()=>{
      if(!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.');
      saveXlsx('근태정리', [{name:'근태정리', ws:toSheet(dfSummary)}]);
    });
    $('btnSaveNext').addEventListener('click', ()=>{
      if(!dfNext.length) return showToast('먼저 시뮬레이션을 수행하세요.');
      saveXlsx('익월적용', [{name:'익월적용', ws:toSheet(dfNext)}]);
    });
  </script>
</body>
</html>
