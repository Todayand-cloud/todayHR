<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATEC ì¸ì‚¬ê´€ë¦¬(ê·¼íƒœ) Â· 1~4 í˜ì´ì§€ í†µí•©ë³¸</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;--accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;--dark:#111827;--softblue:#e6efff;--softred:#ffe7e7;}
*{box-sizing:border-box}
body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}
.topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
.stepper{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
.step{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.2s;cursor:pointer}
.step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
.step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
.step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
.chev{flex:1;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);min-width:40px}
main{max-width:1200px;margin:18px auto;padding:0 16px}
.page{display:none;opacity:0;transform:translateY(6px);transition:opacity .28s ease,transform .28s ease}
.page.show{display:block;opacity:1;transform:none}
.card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.upload-box{border:2px dashed var(--line);border-radius:12px;padding:22px;text-align:center;background:#fbfdff}
.upload-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}
.upload-row .upload-box{min-height:130px}
.upload-action{display:flex;justify-content:center;margin-top:16px}
input[type=file]{display:none}
.pick{background:var(--dark);color:#fff;padding:10px 18px;border-radius:10px;font-weight:800;cursor:pointer;display:inline-block}
.pick.flash{background:var(--ok);animation:flash 1.1s ease-out}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
.filename{display:block;color:var(--muted);margin-top:10px;min-height:20px}
.btn{background:var(--dark);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
.btn:hover{background:var(--accent1)} .btn[disabled]{background:#9ca3af;cursor:not-allowed}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.kpi{border:1px solid var(--line);border-radius:16px;padding:14px;text-align:center}
.kpi h4{margin:0;color:var(--muted);font-size:14px}
.kpi .big{font-size:24px;font-weight:700;margin-top:3px}
.kpi .small{font-size:13px;color:#374151;line-height:1.95;margin-top:6px}
.chart-row{display:flex;gap:22px;justify-content:center;flex-wrap:wrap;align-items:flex-start}
.chart-box{width:460px;max-width:45vw;text-align:center}
.chart-box canvas{max-height:240px}
.chart-box p{font-size:15px;font-weight:800;margin:.6rem 0 0}
sum-card h2{margin:0;font-size:22px}

/* í—¤ë” ì¹´ë“œ ì¤„ ê°„ê²©/ì—¬ë°± í†µì¼ */
.sum-card .sum-meta { 
  margin: 6px 0 0;   /* ìœ„ë¡œë§Œ ì¼ì • ì—¬ë°± */
  line-height: 1.9; 
}
#sumDelta { 
  margin-top: 10px;  /* ì¦ê° ë¼ì¸ì€ ì‚´ì§ ë” ë„ì›€ */
}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px 10px;text-align:center;font-size:.92rem;background:#fff}
th{background:#f3f4f6}
.subtotal{background:#f9fafb;font-weight:800;border-top:2px solid #9ca3af}
.group-red{box-shadow:inset 0 0 0 2px var(--softred);border-radius:8px}
.group-blue{box-shadow:inset 0 0 0 2px var(--softblue);border-radius:8px}
.next-wrap{overflow-x:auto;overflow-y:hidden;border:1px solid var(--line);border-radius:12px}
.next-inner{min-width:920px}
.save-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.btn-merge{background:#2563eb}
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10000}
.panel{background:#fff;max-width:720px;width:92vw;border-radius:16px;box-shadow:0 16px 60px rgba(0,0,0,.35);padding:18px}
.grid-map{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cell{display:flex;align-items:center;gap:10px}
.cell label{min-width:180px;font-weight:700}
select{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px}

/* === ì¶”ê°€: ìˆ˜ë‹¹ ë¬¶ìŒ í…Œë‘ë¦¬/ë°°ê²½ === */
td.grp-over-first, th.grp-over-first {border-left:2px solid var(--accent1);}
td.grp-over-last,  th.grp-over-last  {border-right:2px solid var(--accent1);}
td.grp-over-mid {border-left:0;border-right:0;}
td.bg-over {background:#eaf2ff;} /* ì‹œê°„ì™¸ìˆ˜ë‹¹ íŒŒìŠ¤í…” */

td.grp-hol-first, th.grp-hol-first {border-left:2px solid var(--accent2);}
td.grp-hol-last,  th.grp-hol-last  {border-right:2px solid var(--accent2);}
td.grp-hol-mid {border-left:0;border-right:0;}
td.bg-hol {background:#ffecef;} /* íœ´ì¼ìˆ˜ë‹¹ íŒŒìŠ¤í…” */
</style>
</head>
<body>
<header>ATEC ì¸ì‚¬ê´€ë¦¬(ê·¼íƒœ) í”„ë¡œê·¸ë¨</header>
<!-- ğŸ”¹ ìµœì´ˆ ì•ˆë‚´ë¬¸ ì˜¤ë²„ë ˆì´ -->
<div id="introOverlay" style="position:fixed;inset:0;z-index:10000;background:#fff;display:flex;align-items:center;justify-content:center;overflow:auto;padding:40px;">
  <div style="max-width:900px;background:#ffffff;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,0.15);padding:36px;">
    <h1 style="margin-top:0;font-size:28px;font-weight:800;color:#111827;">ATEC ì¸ì‚¬ê´€ë¦¬(ê·¼íƒœ) ìë™í™” í”„ë¡œê·¸ë¨ ì•ˆë‚´</h1>
    <p style="line-height:1.9;font-size:16px;color:#374151;">
      ë³¸ ì‹œìŠ¤í…œì€ <strong>ATEC ì¸ì‚¬ì´ë¬´íŒ€</strong>ì—ì„œ ê°œë°œí•œ ê·¼íƒœ ìë™í™” í”„ë¡œê·¸ë¨ìœ¼ë¡œ, 
      ê·¸ë£¹ì›¨ì–´ì˜ ì‹œê°„ì™¸ê·¼ë¬´ ìŠ¹ì¸ ë°ì´í„°ì™€ ERP í†µìƒì‹œê¸‰ ìë£Œë¥¼ í†µí•©í•˜ì—¬
      <strong>ê·¼íƒœí˜„í™© Â· ê·¼íƒœì •ë¦¬ Â· ìµì›”ì ìš©</strong> ì‹œíŠ¸ë¥¼ ìë™ ìƒì„±í•˜ê³ ,
      ì „ì›” ëŒ€ë¹„ ë¦¬í¬íŠ¸ ë° ìˆ˜ë‹¹ ë³€ë™ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
    </p>
    <ul style="margin:16px 0 0 20px;line-height:1.8;color:#374151;">
      <li>RAW ë°ì´í„° ë° í†µìƒì‹œê¸‰ íŒŒì¼ ì—…ë¡œë“œ</li>
      <li>ì „ì›” ëŒ€ë¹„ ê·¼ë¬´ì‹œê°„Â·ìˆ˜ë‹¹ ì¦ê°ë¥  ìë™ ë¶„ì„</li>
      <li>ê·¼íƒœí˜„í™© / ê·¼íƒœì •ë¦¬ / ìµì›”ì ìš© ì‹œíŠ¸ ìë™ ìƒì„±</li>
      <li>Excel íŒŒì¼ í†µí•© ì €ì¥ ê¸°ëŠ¥ ì œê³µ</li>
      <li>ì¢…ê²°ì¼ì ê³µë€ ì‹œ ìµì›”ì ìš© ìë™ ë¶„ë¥˜</li>
    </ul>

    <div style="margin-top:30px;text-align:right;">
      <button id="btnIntroOk" 
        style="background:#111827;color:#fff;padding:14px 26px;border:none;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;transition:0.2s;">
        í™•ì¸ì™„ë£Œ
      </button>
    </div>
  </div>
</div>

<div class="topbar">
  <div class="stepper">
    <div class="step active" data-step="1"><div class="num">1</div>ì—…ë¡œë“œ</div>
    <div class="chev"></div>
    <div class="step" data-step="2"><div class="num">2</div>ë¦¬í¬íŠ¸</div>
    <div class="chev"></div>
    <div class="step" data-step="3"><div class="num">3</div>ì„¸ë¶€ë‚´ì—­</div>
    <div class="chev"></div>
    <div class="step" data-step="4"><div class="num">4</div>ë°ì´í„° ì €ì¥</div>
  </div>
</div>
<main style="display:none;" id="mainContent">
<!-- 1. ì—…ë¡œë“œ -->
<section id="page1" class="page show">
  <div class="card">
    <h2 style="margin:0 0 10px 0">ì•ˆë‚´ì‚¬í•­</h2>
    <ul style="margin:8px 0 6px 18px;line-height:1.7">
      <li>ì‚°ì •ê¸°ê°„: <b>ì „ì›” 21ì¼ ~ ë‹¹ì›” 20ì¼</b> (ê²°ì¬ ì™„ë£Œ ê¸°ì¤€)</li>
      <li>íœ´ê²Œì‹œê°„: <b>4ì‹œê°„ ì´ˆê³¼ ì‹œ 1ì‹œê°„</b> ìë™ ë¶€ì—¬</li>
      <li>ì£¼ 52ì‹œê°„ ê¸°ì¤€: íœ´ì¼/ì•¼ê°„ê·¼ë¬´ëŠ” <b>ì£¼ 12ì‹œê°„ ì´ë‚´</b> ì‹ ì²­ ê°€ëŠ¥</li>
      <li>í•„ìš” RAW ë°ì´í„°(2ê°œ)</li>
    </ul>
    <div style="padding-left:10px">
      <div style="margin:10px 0">1) ê·¸ë£¹ì›¨ì–´-ì‹œê°„ì™¸ê·¼ë¬´ ìŠ¹ì¸(ê´€ë¦¬ì) ë°ì´í„°</div>
      <div style="margin:10px 0">2) ERP-ì±…ì •ì„ê·¼í˜„í™©(í†µìƒì‹œê¸‰)</div>
    </div>
  </div>
  <div class="card">
    <h2 style="margin:0 0 10px 0">ë°ì´í„° ì—…ë¡œë“œ</h2>
    <div class="upload-grid">
      <div class="upload-box">
        <label class="pick" for="curAtt">ê·¼íƒœ RAW</label>
        <input id="curAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curAttName" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="curWage">í†µìƒì‹œê¸‰</label>
        <input id="curWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curWageName" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
      </div>
    </div>
    <p style="margin:18px 0 6px;color:#374151;font-weight:800">[ì „ì›” ìë£Œ] (ì„ íƒì‚¬í•­)</p>
    <div class="upload-row">
      <div class="upload-box">
        <label class="pick" for="prevAtt">ì „ì›” ê·¼íƒœ RAW</label>
        <input id="prevAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevAttName" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevWage">ì „ì›” í†µìƒì‹œê¸‰</label>
        <input id="prevWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevWageName" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevMerged">ì „ì›” í†µí•©ìë£Œ(ê¶Œì¥)</label>
        <input id="prevMerged" type="file" accept=".xlsx,.xls,.xlsm" />
        <span id="prevMergedName" class="filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ (ê·¼íƒœ_í†µí•© ë˜ëŠ” ê·¼íƒœì •ë¦¬ ì‹œíŠ¸)</span>
      </div>
    </div>
    <div class="upload-action">
      <button id="btnRun" class="btn" disabled>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
    </div>
  </div>
</section>
<!-- 2. ë¦¬í¬íŠ¸ -->
<section id="page2" class="page">
  <div class="card sum-card" style="text-align:center">
    <h2 id="sumTitle">ì´ ìˆ˜ë‹¹(ì‹œê°„ì™¸+íœ´ì¼) 0ì›</h2>
    <p class="sum-meta" id="sumMeta">ë‹¹ì›”: 0ì› (ì „ì›”: 0ì›)</p>
    <p class="sum-meta" id="sumDelta" style="color:#2563eb">â–¼ 0ì› (0.0%)</p>
  </div>
  <div class="card">
    <div class="summary-grid">
      <div class="kpi">
        <h4>ì´ ì ìš©ì‹œê°„</h4>
        <div class="big" id="appliedNow">0.0h</div>
        <div class="small" id="appliedPrev" style="opacity:.9">(ì „ì›”: 0.0h)</div>
        <div class="small" id="appliedDelta"></div>
      </div>
      <div class="kpi">
        <h4>ì‹œê°„ì™¸ìˆ˜ë‹¹</h4>
        <div class="big"><span id="overPayNow">0</span>ì›</div>
        <div class="small" id="overPayPrev" style="opacity:.9">(ì „ì›”: 0ì›)</div>
        <div class="small" id="overPayDelta"></div>
      </div>
      <div class="kpi">
        <h4>íœ´ì¼ìˆ˜ë‹¹</h4>
        <div class="big"><span id="holPayNow">0</span>ì›</div>
        <div class="small" id="holPayPrev" style="opacity:.9">(ì „ì›”: 0ì›)</div>
        <div class="small" id="holPayDelta"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="chart-row">
      <div class="chart-box">
        <p>ì „ì›” ì‹œê°„/ìˆ˜ë‹¹ ë¹„ìœ¨</p>
        <canvas id="donutPrev"></canvas>
      </div>
      <div class="chart-box">
        <p>ë‹¹ì›” ì‹œê°„/ìˆ˜ë‹¹ ë¹„ìœ¨</p>
        <canvas id="donutNow"></canvas>
      </div>
    </div>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0">ì „ì›” ëŒ€ë¹„ ë¹„êµ ì°¨íŠ¸</h3>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barHours"></canvas>
        <p style="margin:.6rem 0 0">ì‹œê°„ ë¹„êµ</p>
      </div>
    </div>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barPays"></canvas>
        <p style="margin:.6rem 0 0">ìˆ˜ë‹¹ ë¹„êµ</p>
      </div>
    </div>
  </div>
</section>
<!-- 3. ì„¸ë¶€ë‚´ì—­ -->
<section id="page3" class="page">
  <div class="card">
    <h2 style="margin-top:0">ê·¼íƒœí˜„í™©</h2>
    <table id="tblStatus"><thead><tr><th>ë°ì´í„° ì—†ìŒ</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>ê·¼íƒœì •ë¦¬</h2>
    <table id="tblSummary"><thead><tr><th>ë°ì´í„° ì—†ìŒ</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>ìµì›”ì ìš©</h2>
    <div class="next-wrap"><div class="next-inner">
      <table id="tblNext"><thead><tr><th>ë°ì´í„° ì—†ìŒ</th></tr></thead></table>
    </div></div>
  </div>
</section>
<!-- 4. ë°ì´í„° ì €ì¥ -->
<section id="page4" class="page">
  <div class="card">
    <h2 style="margin-top:0">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</h2>
    <p class="muted" style="margin-top:-4px">ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ .xlsx ì €ì¥ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.</p>
    <div class="save-row">
      <button class="btn" id="btnSaveStatus">ê·¼íƒœí˜„í™© ì €ì¥</button>
      <button class="btn" id="btnSaveSummary">ê·¼íƒœì •ë¦¬ ì €ì¥</button>
      <button class="btn" id="btnSaveNext">ìµì›”ì ìš© ì €ì¥</button>
      <button class="btn btn-merge" id="btnSaveAll">í†µí•©ì €ì¥</button>
    </div>
    <p class="muted" style="margin-top:10px">â€» í†µí•©ì €ì¥ì€ ì „ì›” ë°ì´í„° ë³´ê´€ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì „ì›” ë¹„êµëŠ” 1í˜ì´ì§€ì˜ <b>ì „ì›” ìë£Œ ì—…ë¡œë“œ</b>ë¡œ ì§€ì •í•˜ì„¸ìš”.</p>
  </div>
</section>
<!-- ğŸ”¹ í”„ë¡œê·¸ë¨ ì†Œê°œ ì„¹ì…˜ (ì™¸ë¶€ ì‚¬ìš©ììš©) -->
<section id="about" style="margin:40px auto;max-width:900px;background:#fff;border-radius:16px;padding:30px 40px;box-shadow:0 6px 20px rgba(0,0,0,0.08)">
  <h2 style="margin-top:0;font-size:24px;font-weight:800;color:#111827;">ATEC ì¸ì‚¬ê´€ë¦¬(ê·¼íƒœ) ìë™í™” í”„ë¡œê·¸ë¨</h2>
  <p style="line-height:1.8;color:#374151;font-size:15px;margin-top:10px;">
    ë³¸ ì‹œìŠ¤í…œì€ <strong>ATEC ì¸ì‚¬ì´ë¬´íŒ€</strong>ì—ì„œ ê°œë°œí•œ ê·¼íƒœ ìë™í™” í”„ë¡œê·¸ë¨ìœ¼ë¡œ,<br>
    ê·¸ë£¹ì›¨ì–´ì˜ ì‹œê°„ì™¸ê·¼ë¬´ ìŠ¹ì¸ ë°ì´í„°ì™€ ERPì˜ í†µìƒì‹œê¸‰ ìë£Œë¥¼ í†µí•©í•˜ì—¬
    <strong>ê·¼íƒœí˜„í™© Â· ê·¼íƒœì •ë¦¬ Â· ìµì›”ì ìš©</strong> ì‹œíŠ¸ë¥¼ ìë™ ìƒì„±í•˜ê³ ,<br>
    ì „ì›” ëŒ€ë¹„ ë¦¬í¬íŠ¸ ë° ìˆ˜ë‹¹ ë³€ë™ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
  </p>

  <h3 style="margin-top:26px;color:#111827;">ì£¼ìš” ê¸°ëŠ¥</h3>
  <ul style="margin-left:18px;line-height:1.9;color:#374151;font-size:15px;">
    <li>RAW ë°ì´í„°(ì‹œê°„ì™¸ê·¼ë¬´ ìŠ¹ì¸í˜„í™©) ë° í†µìƒì‹œê¸‰ íŒŒì¼ ì—…ë¡œë“œ</li>
    <li>ì „ì›” ëŒ€ë¹„ ê·¼ë¬´ì‹œê°„Â·ìˆ˜ë‹¹ ì¦ê°ë¥  ìë™ ë¶„ì„ ë° ì‹œê°í™”</li>
    <li>ê·¼íƒœí˜„í™© / ê·¼íƒœì •ë¦¬ / ìµì›”ì ìš© ì‹œíŠ¸ ìë™ ìƒì„±</li>
    <li>Excel í†µí•© ë‹¤ìš´ë¡œë“œ ì§€ì› (ê°œë³„Â·ì „ì²´ ì„ íƒ ê°€ëŠ¥)</li>
    <li>ì¢…ê²°ì¼ì ê³µë€ ì‹œ ìµì›”ì ìš© ìë™ ë¶„ë¥˜</li>
  </ul>

  <h3 style="margin-top:26px;color:#111827;">ê¸°ë³¸ ê³„ì‚° ë¡œì§</h3>
  <table style="width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;">
    <thead>
      <tr style="background:#f3f4f6;">
        <th style="border:1px solid #e5e7eb;padding:8px;">í•­ëª©</th>
        <th style="border:1px solid #e5e7eb;padding:8px;">ê¸°ì¤€</th>
      </tr>
    </thead>
    <tbody>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">í‰ì¼ì—°ì¥</td><td style="border:1px solid #e5e7eb;padding:8px;">í‰ì¼ 18:00 ~ 22:00</td></tr>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">í‰ì¼ì•¼ê°„</td><td style="border:1px solid #e5e7eb;padding:8px;">í‰ì¼ 22:00 ~ ìµì¼ 06:00</td></tr>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ì¼ë°˜</td><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ 06:00 ~ 22:00</td></tr>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ì—°ì¥</td><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ì¼ë°˜ ì¤‘ 8ì‹œê°„ ì´ˆê³¼</td></tr>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ì•¼ê°„</td><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ 22:00 ~ ìµì¼ 06:00</td></tr>
      <tr><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ì—°ì¥ì•¼ê°„</td><td style="border:1px solid #e5e7eb;padding:8px;">íœ´ì¼ ì¤‘ 22ì‹œ ì´í›„ 8ì‹œê°„ ì´ˆê³¼ë¶„</td></tr>
    </tbody>
  </table>

  <div style="margin-top:26px;padding:14px 16px;border-left:4px solid #2563eb;background:#f0f6ff;">
    <strong>ë¬¸ì˜</strong><br>
    ATEC CN ê²½ì˜ì§€ì›ì‹¤ ê¹€ì„ í™ ì„ ì„<br> 
    ğŸ“§ <a href="mailto:shkim5@ateccn.kr">shkim5@ateccn.kr</a> 
  </div>
</section>   

</main>

<!-- í—¤ë” ë§¤í•‘ ëª¨ë‹¬ -->
<div class="modal" id="mapModal">
  <div class="panel">
    <h3 id="mapTitle" style="margin:0 0 8px 0">í—¤ë” ë§¤í•‘</h3>
    <p class="muted" style="margin-top:0">ì—…ë¡œë“œí•œ íŒŒì¼ì˜ ì—´ ì´ë¦„ì„ ì•„ë˜ í‘œì¤€ í•­ëª©ì— ì—°ê²°í•˜ì„¸ìš”.</p>
    <div class="grid-map" id="mapGrid"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn" id="btnMapCancel" style="background:#6b7280">ì·¨ì†Œ</button>
      <button class="btn" id="btnMapOk">ë§¤í•‘ ì™„ë£Œ</button>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
/* === ChartDataLabels ì•ˆì „ ë“±ë¡(ê¸°ì¡´ ìœ ì§€) === */
try{
  if(window.Chart && window.ChartDataLabels){
    Chart.register(ChartDataLabels);
  }
}catch(e){
  console.warn('ChartDataLabels not ready', e);
}

/* === ê³µí†µ ìœ í‹¸ === */
const $=id=>document.getElementById(id);
const showToast=(m)=>{const t=$('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2500);}
const number = v => { const n = Number(String(v??'').toString().replace(/[, ]/g,'')); return isNaN(n)?0:n; };
const hourMod24 = t => t - 24*Math.floor(t/24);
function parseTime(s){
  if(s==null) return -1; let st=String(s).trim().replace(/\s+/g,'');
  st=st.replace('ì‹œ',':').replace('ë¶„','');
  if(!st.includes(':')){
    if(!/^\d+$/.test(st)) return -1;
    const n=parseInt(st,10); if(st.length<=2) return n; if(st.length<=4) return Math.floor(n/100)+(n%100)/60; return -1;
  }
  let [h,m]=st.split(':'); h=parseInt(h,10); m=parseInt(m,10);
  if(isNaN(h)||isNaN(m)||m<0||m>=60) return -1; return h+m/60;
}
const ceilHalf=x=> Math.ceil(Number(x)/0.5)*0.5;
const fmtHM=d=>{const h=Math.floor(d)%24;const m=Math.round((d-Math.floor(d))*60)%60;return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
const sum=(rows,key)=> rows.reduce((a,r)=> a + number(r[key]), 0);

/* === í—¤ë” ë§¤í•‘(ë³€ê²½ ì—†ìŒ) === */
const REQUIRED_ATT=["ì‹ ì²­ì‹œê°„","ê·¼ë¬´ì ë¶€ì„œ","ê·¼ë¬´ì","ê·¼ë¬´ì¼","ê·¼ë¬´ìœ í˜•","ì¢…ê²°ì¼ì","ìƒíƒœ"];
const REQUIRED_WAGE=["ë¶€ì„œ","ì´ë¦„","í†µìƒì‹œê¸‰"];
const SYN={
 "ì‹ ì²­ì‹œê°„":["ì‹ ì²­ì‹œê°„","ì‹œê°„","ê·¼ë¬´ì‹œê°„ëŒ€","ê·¼ë¬´ì‹ ì²­ì‹œê°„","ì‹œì‘~ì¢…ë£Œ","ê·¼ë¬´ì‹œê°„(ì‹ ì²­)"],
 "ê·¼ë¬´ì ë¶€ì„œ":["ê·¼ë¬´ì ë¶€ì„œ","ë¶€ì„œ","ë¶€ì„œ(íŒ€)","ë¶€ì„œëª…","ì†Œì†"],
 "ê·¼ë¬´ì":["ê·¼ë¬´ì","ì´ë¦„","ì„±ëª…","ê·¼ë¬´ìëª…","ì‚¬ì›ëª…"],
 "ê·¼ë¬´ì¼":["ê·¼ë¬´ì¼","ì¼ì","ê·¼ë¬´ì¼ì","ë‚ ì§œ"],
 "ê·¼ë¬´ìœ í˜•":["ê·¼ë¬´ìœ í˜•","ìœ í˜•","êµ¬ë¶„","ê·¼ë¬´êµ¬ë¶„"],
 "ì¢…ê²°ì¼ì":["ì¢…ê²°ì¼ì","ê²°ì¬ì¼ì","ìŠ¹ì¸ì¼ì","ì¢…ê²°ì¼","ê²°ì¬ì¼"],
 "ìƒíƒœ":["ìƒíƒœ","ê²°ì¬ìƒíƒœ","ìŠ¹ì¸ìƒíƒœ"],
 "ë¶€ì„œ":["ë¶€ì„œ","ë¶€ì„œëª…","ì†Œì†","ë¶€ì„œ(íŒ€)"],
 "ì´ë¦„":["ì´ë¦„","ì„±ëª…","ì‚¬ì›ëª…"],
 "í†µìƒì‹œê¸‰":["í†µìƒì‹œê¸‰","ê¸°ë³¸ì‹œê¸‰","ì‹œê¸‰","í†µìƒ ì„ê¸ˆ","í†µìƒì„ê¸ˆ"]
};
function guessMap(required, cols){
  const m={}; required.forEach(k=>{
    const l=cols.map(c=>String(c||'').toLowerCase());
    const idx1=l.indexOf(k.toLowerCase());
    if(idx1>-1){ m[k]=cols[idx1]; return; }
    const alt=(SYN[k]||[]).map(s=>s.toLowerCase());
    const idx2=l.findIndex(x=>alt.includes(x));
    m[k]= idx2>-1? cols[idx2] : "";
  }); return m;
}
function openMapper(title, required, cols){
  return new Promise((resolve,reject)=>{
    $('mapTitle').textContent=title;
    const grid=$('mapGrid'); grid.innerHTML="";
    const g=guessMap(required, cols);
    required.forEach(k=>{
      const wrap=document.createElement('div'); wrap.className='cell';
      const lab=document.createElement('label'); lab.textContent=k;
      const sel=document.createElement('select'); sel.dataset.key=k;
      sel.appendChild(new Option('-- ì—´ ì„ íƒ --',''));
      cols.forEach(c=> sel.appendChild(new Option(c,c)));
      sel.value=g[k]||"";
      wrap.appendChild(lab); wrap.appendChild(sel);
      grid.appendChild(wrap);
    });
    const modal=$('mapModal'); modal.style.display='flex';
    $('btnMapCancel').onclick=()=>{ modal.style.display='none'; reject(new Error('ë§¤í•‘ ì·¨ì†Œ')); };
    $('btnMapOk').onclick=()=>{
      const mapping={}; const selects=[...grid.querySelectorAll('select')];
      for(const s of selects){ if(!s.value){ showToast('ëª¨ë“  í•­ëª©ì„ ë§¤í•‘í•´ ì£¼ì„¸ìš”.'); return; } mapping[s.dataset.key]=s.value; }
      modal.style.display='none'; resolve(mapping);
    };
  });
}
function normalizeRows(rows, mapping){ return rows.map(r=>{ const o={}; for(const k in mapping){ o[k]=r[mapping[k]]; } return o; }); }

/* === ìƒíƒœ ê°’(ë³€ê²½ ì—†ìŒ) === */
let curAttRows=[], curWageRows=[];
let prevAttRows=[], prevWageRows=[];
let prevMergedMetrics=null;
let dfStatus=[], dfSummary=[], dfNext=[];

/* === ë¦¬ë”(ë³€ê²½ ì—†ìŒ) === */
function readExcel(file, preferSheets=[]){
  return new Promise((resolve,reject)=>{
    if(typeof XLSX==='undefined'){ return reject(new Error('Excel ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬/CDN ì°¨ë‹¨)')); }
    const fr=new FileReader();
    fr.onload=e=>{
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        let ws=null; for(const n of preferSheets){ if(wb.Sheets[n]){ ws=wb.Sheets[n]; break; } }
        if(!ws) ws=wb.Sheets[wb.SheetNames[0]];
        resolve({wb, rows:XLSX.utils.sheet_to_json(ws,{defval:null})});
      }catch(err){reject(err);}
    }; fr.readAsArrayBuffer(file);
  });
}

/* === ì—…ë¡œë“œ UI(ë³€ê²½ ì—†ìŒ) === */
function flashLabel(forId){ const lab=document.querySelector(`label[for="${forId}"]`); if(!lab) return; lab.classList.remove('flash'); void lab.offsetWidth; lab.classList.add('flash'); }
function attachPicker(inputId, nameId, handler){
  const inp=$(inputId), name=$(nameId);
  inp.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f){ name.textContent='ì„ íƒëœ íŒŒì¼ ì—†ìŒ'; return; }
    name.textContent='ë¶„ì„ ì¤‘â€¦';
    try{ await handler(f, name, inputId); flashLabel(inputId); }
    catch(err){ console.error(err); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: '+err.message); name.textContent='ì‹¤íŒ¨'; }
    finally{ e.target.value=''; }
  });
}
function updateRunBtn(){ $('btnRun').disabled = !(curAttRows.length && curWageRows.length); }

/* === ì²˜ë¦¬ ë¡œì§(ë³€ê²½ ì—†ìŒ) === */
function process(attRows, wageRows){
  const status=[], agg={}, nextRows=[];
  const ensure=(name,dept)=>{ if(!agg[name]) agg[name]={ë¶€ì„œ:dept,ì´ë¦„:name,ê·¼ë¬´ì‹œê°„:0,íœ´ê²Œì‹œê°„:0,ì ìš©ì‹œê°„:0,í‰ì¼ì—°ì¥:0,í‰ì¼ì•¼ê°„:0,íœ´ì¼ì¼ë°˜:0,íœ´ì¼ì—°ì¥:0,íœ´ì¼ì•¼ê°„:0,íœ´ì¼ì—°ì¥ì•¼ê°„:0}; };
  for(const r of attRows){
  if(String(r['ìƒíƒœ']||'').includes('ë°˜ë ¤')) continue;
  const raw=String(r['ì‹ ì²­ì‹œê°„']||''); if(!raw.includes('~')) continue;
  let [s,e]=raw.split('~').map(x=>x.trim()); 
  let sh=parseTime(s), eh=parseTime(e); 
  if(sh<0||eh<0) continue; 
  if(eh<sh) eh+=24;

  const work=eh-sh, brk=Math.floor(work/5), applied=work-brk;
  const rowData = {
    ë¶€ì„œ: r['ê·¼ë¬´ì ë¶€ì„œ'],
    ì´ë¦„: r['ê·¼ë¬´ì'],
    ê·¼ë¬´ì¼ì: r['ê·¼ë¬´ì¼'],
    ê·¼ë¬´ìœ í˜•: r['ê·¼ë¬´ìœ í˜•'],
    ê·¼ë¬´ì‹œì‘ì‹œê°„: fmtHM(sh),
    ê·¼ë¬´ì¢…ë£Œì‹œê°„: fmtHM(eh),
    ê·¼ë¬´ì‹œê°„: +work.toFixed(2),
    íœ´ê²Œì‹œê°„: +brk.toFixed(2),
    ì ìš©ì‹œê°„: +applied.toFixed(2),
    ì •ìˆ˜: ceilHalf(applied),
  };
  status.push(rowData);

  // âœ… ì¢…ê²°ì¼ì ê³µë€ì´ë©´ ìµì›”ì ìš©ìœ¼ë¡œ ì´ë™, í•©ì‚° ì œì™¸
  if (!r['ì¢…ê²°ì¼ì'] || String(r['ì¢…ê²°ì¼ì']).trim() === '') {
    dfNext.push(rowData);
    continue;
  }

  // ì´í•˜ ê¸°ì¡´ ì§‘ê³„ ë¡œì§
  const nm = String(r['ê·¼ë¬´ì'] || '').replace('(IT)', '').trim(); 
  if (!nm) continue;
  const dept = r['ê·¼ë¬´ì ë¶€ì„œ']; 
  const ty = String(r['ê·¼ë¬´ìœ í˜•'] || '').toLowerCase();

  ensure(nm, dept);
  const A = agg[nm];
  A.ê·¼ë¬´ì‹œê°„ += work;
  A.íœ´ê²Œì‹œê°„ += brk;
  A.ì ìš©ì‹œê°„ += applied;
    let effStart=sh+brk; if(effStart>eh) effStart=eh;
    for(let t=effStart; t<eh-1e-6; t+=0.25){
      const hod=hourMod24(t); const worked=t-effStart;
      if(ty.includes('ì—°ì¥') && !ty.includes('íœ´ì¼')){ if(hod>=18&&hod<22) A.í‰ì¼ì—°ì¥+=0.25; if(hod>=22||hod<6) A.í‰ì¼ì•¼ê°„+=0.25; }
      else if(ty.includes('íœ´ì¼')){
        if(worked<8){ if(hod>=6&&hod<22) A.íœ´ì¼ì¼ë°˜+=0.25; else A.íœ´ì¼ì•¼ê°„+=0.25; }
        else { if(hod>=6&&hod<22) A.íœ´ì¼ì—°ì¥+=0.25; else A.íœ´ì¼ì—°ì¥ì•¼ê°„+=0.25; }
      }
    }
  }
  const summary=Object.values(agg).map((A,i)=>({ìˆœë²ˆ:i+1,ë¶€ì„œ:A.ë¶€ì„œ,ì´ë¦„:A.ì´ë¦„,ê·¼ë¬´ì‹œê°„:+A.ê·¼ë¬´ì‹œê°„.toFixed(2),íœ´ê²Œì‹œê°„:+A.íœ´ê²Œì‹œê°„.toFixed(2),ì ìš©ì‹œê°„:+A.ì ìš©ì‹œê°„.toFixed(2),
    í‰ì¼ì—°ì¥:+A.í‰ì¼ì—°ì¥.toFixed(2),í‰ì¼ì•¼ê°„:+A.í‰ì¼ì•¼ê°„.toFixed(2),íœ´ì¼ì¼ë°˜:+A.íœ´ì¼ì¼ë°˜.toFixed(2),íœ´ì¼ì—°ì¥:+A.íœ´ì¼ì—°ì¥.toFixed(2),íœ´ì¼ì•¼ê°„:+A.íœ´ì¼ì•¼ê°„.toFixed(2),íœ´ì¼ì—°ì¥ì•¼ê°„:+A.íœ´ì¼ì—°ì¥ì•¼ê°„.toFixed(2)}));

  if(wageRows && wageRows.length){
    const key = (dept,name)=>`${String(dept||'').trim()}|${String(name||'').trim()}`;
    const wageMap = new Map();
    wageRows.forEach(r=>{
      const dept=String(r['ë¶€ì„œ']||'').trim();
      const name=String(r['ì´ë¦„']||'').trim();
      const base=number(r['í†µìƒì‹œê¸‰']);
      if(!wageMap.has(key(dept,name))) wageMap.set(key(dept,name), base);
      if(!wageMap.has(key('',name))) wageMap.set(key('',name), base);
      if(!wageMap.has(key(dept,''))) wageMap.set(key(dept,''), base);
    });
    const mult={í‰ì¼ì—°ì¥:1.5, í‰ì¼ì•¼ê°„:2.0, íœ´ì¼ì¼ë°˜:1.5, íœ´ì¼ì—°ì¥:2.0, íœ´ì¼ì•¼ê°„:2.0, íœ´ì¼ì—°ì¥ì•¼ê°„:2.5};
    summary.forEach(r=>{
      const base = wageMap.get(key(r.ë¶€ì„œ,r.ì´ë¦„)) ?? wageMap.get(key('',r.ì´ë¦„)) ?? wageMap.get(key(r.ë¶€ì„œ,'')) ?? 0;
      r['ì‹œê°„ì™¸ìˆ˜ë‹¹'] = Math.ceil(base*mult.í‰ì¼ì—°ì¥*r.í‰ì¼ì—°ì¥) + Math.ceil(base*mult.í‰ì¼ì•¼ê°„*r.í‰ì¼ì•¼ê°„);
      r['íœ´ì¼ìˆ˜ë‹¹'] = Math.ceil(base*mult.íœ´ì¼ì¼ë°˜*r.íœ´ì¼ì¼ë°˜) + Math.ceil(base*mult.íœ´ì¼ì—°ì¥*r.íœ´ì¼ì—°ì¥) + Math.ceil(base*mult.íœ´ì¼ì•¼ê°„*r.íœ´ì¼ì•¼ê°„) + Math.ceil(base*mult.íœ´ì¼ì—°ì¥ì•¼ê°„*r.íœ´ì¼ì—°ì¥ì•¼ê°„);
    });
  }
const overHours=summary.reduce((a,r)=>a+r.í‰ì¼ì—°ì¥+r.í‰ì¼ì•¼ê°„,0);
const holHours =summary.reduce((a,r)=>a+r.íœ´ì¼ì¼ë°˜+r.íœ´ì¼ì—°ì¥+r.íœ´ì¼ì•¼ê°„+r.íœ´ì¼ì—°ì¥ì•¼ê°„,0);
// âœ… ì ìš©ì‹œê°„ì€ í™•ì • ì§‘ê³„ ê¸°ì¤€ìœ¼ë¡œ ê°•ì œ ì¼ì¹˜
const appliedTotal = overHours + holHours;

  let overPay=0, holPay=0;
  if(wageRows && wageRows.length){
    summary.forEach(r=>{ overPay += number(r['ì‹œê°„ì™¸ìˆ˜ë‹¹']); holPay += number(r['íœ´ì¼ìˆ˜ë‹¹']); });
  }
  return {status,summary,next:nextRows,metrics:{appliedTotal,overHours,holHours,overPay,holPay,totalPay:overPay+holPay}};
}

/* === ì°¨íŠ¸ (ë§‰ëŒ€ ë¼ë²¨ í°íŠ¸ 17 â†’ 15 ë¡œ ì¶•ì†Œ) === */
const donutPrev=document.getElementById('donutPrev'), donutNow=document.getElementById('donutNow');
const barHours=document.getElementById('barHours'), barPays=document.getElementById('barPays');
function drawDoughnut(ctx, labels, data, colors){
  if(!window.Chart) return;
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2}]},
    options:{maintainAspectRatio:false,aspectRatio:1.2,cutout:'62%',
      plugins:{legend:{position:'bottom',labels:{boxWidth:14}},
        datalabels:{color:'#fff',font:{weight:'700',size:14},formatter:v=>v?`${v}%`:''}}},plugins:(window.ChartDataLabels?[ChartDataLabels]:[])});
}
function drawBars(ctx, labels, prev, now, isMoney){
  if(!window.Chart) return;
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart=new Chart(ctx,{type:'bar',
    data:{labels,datasets:[
      {label:'ì „ì›”',data:prev,backgroundColor:'#60a5fa',maxBarThickness:40},
      {label:'ë‹¹ì›”',data:now, backgroundColor:'#fca5a5',maxBarThickness:40}
    ]},
    options:{maintainAspectRatio:false,aspectRatio:1.7,
      plugins:{
        legend:{position:'bottom'},
        datalabels:{
          anchor:'end',align:'end',offset:4,
          color:'#111827',
          backgroundColor:'rgba(220,235,255,0.68)',
          font:{weight:'bold',size:13}, /* â† 15ì—ì„œ 13ë¡œ */
          borderRadius:8,
          padding:{top:4,bottom:4,left:8,right:8},
          borderWidth:2,
          borderColor:'rgba(120,120,220,0.18)',
          shadowBlur:7,shadowColor:'#bdbdbd',
          formatter:v=>isMoney?Number(v).toLocaleString():v
        }
      },
      scales:{y:{beginAtZero:true,grace:'12%',ticks:{callback:v=>isMoney?Number(v).toLocaleString():v}}}
    },plugins:(window.ChartDataLabels?[ChartDataLabels]:[])});
}

/* === í‘œ ë Œë”ë§(ìˆ˜ë‹¹ ë¬¶ìŒ í…Œë‘ë¦¬/ë°°ê²½ ì ìš©) === */
const tblStatus=$('tblStatus'), tblSummary=$('tblSummary'), tblNext=$('tblNext');
function renderTable(el, rows){
  if(!rows||!rows.length){ el.innerHTML='<thead><tr><th>ë°ì´í„° ì—†ìŒ</th></tr></thead>'; return; }
  const cols=Object.keys(rows[0]);
  let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  let tbody='<tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  el.innerHTML=thead+tbody;
}
function renderSummaryTable(rows){
  if(!rows||!rows.length){ tblSummary.innerHTML='<thead><tr><th>ë°ì´í„° ì—†ìŒ</th></tr></thead>'; return; }

  const baseCols=['ìˆœë²ˆ','ë¶€ì„œ','ì´ë¦„','ê·¼ë¬´ì‹œê°„','íœ´ê²Œì‹œê°„','ì ìš©ì‹œê°„'];
  const overCols=['í‰ì¼ì—°ì¥','í‰ì¼ì•¼ê°„','ì‹œê°„ì™¸ìˆ˜ë‹¹']; // ì‹œê°„ì™¸ìˆ˜ë‹¹ ë¬¶ìŒ
  const holCols=['íœ´ì¼ì¼ë°˜','íœ´ì¼ì—°ì¥','íœ´ì¼ì•¼ê°„','íœ´ì¼ì—°ì¥ì•¼ê°„','íœ´ì¼ìˆ˜ë‹¹']; // íœ´ì¼ìˆ˜ë‹¹ ë¬¶ìŒ
  const cols=[...baseCols,...overCols,...holCols];

  const totals={}; cols.forEach(c=> totals[c]=0);
  rows.forEach(r=> cols.forEach(c=> totals[c]+= number(r[c])));

  // í—¤ë”
  let thead='<thead><tr>';
  cols.forEach(c=>{
    let cls='';
    if(c===overCols[0]) cls='grp-over-first';
    else if(c===overCols[overCols.length-1]) cls='grp-over-last';
    else if(overCols.includes(c)) cls='grp-over-mid';
    if(c===holCols[0]) cls='grp-hol-first';
    else if(c===holCols[holCols.length-1]) cls='grp-hol-last';
    else if(holCols.includes(c)) cls='grp-hol-mid';
    thead+=`<th class="${cls}">${c}</th>`;
  });
  thead+='</tr></thead>';

  // ë°”ë””
  let body='<tbody>';
  rows.forEach((r,i)=>{
    body+='<tr>';
    // ê¸°ë³¸
    baseCols.forEach(c=> body+=`<td>${r[c]??''}</td>`);
    // ì‹œê°„ì™¸ ë¬¶ìŒ
    overCols.forEach((c,idx)=>{
      const isLast = (idx===overCols.length-1);
      const cls = idx===0 ? 'grp-over-first' : (isLast?'grp-over-last':'grp-over-mid');
      const bg  = (isLast && i>=0) ? ' bg-over' : ''; // 2í–‰ë¶€í„° ì†Œê³„ ì „ê¹Œì§€(ì—¬ê¸°ì„œëŠ” ì†Œê³„ ì œì™¸ ì²˜ë¦¬í•˜ë¯€ë¡œ ë°ì´í„°êµ¬ê°„ ì „ì²´, ì†Œê³„ëŠ” ì•„ë˜)
      const val = c.includes('ìˆ˜ë‹¹')? number(r[c]).toLocaleString() : r[c];
      body+=`<td class="${cls}${bg}">${val??''}</td>`;
    });
    // íœ´ì¼ ë¬¶ìŒ
    holCols.forEach((c,idx)=>{
      const isLast = (idx===holCols.length-1);
      const cls = idx===0 ? 'grp-hol-first' : (isLast?'grp-hol-last':'grp-hol-mid');
      const bg  = (isLast && i>=0) ? ' bg-hol' : '';
      const val = c.includes('ìˆ˜ë‹¹')? number(r[c]).toLocaleString() : r[c];
      body+=`<td class="${cls}${bg}">${val??''}</td>`;
    });
    body+='</tr>';
  });

  // ì†Œê³„ í–‰
  const subtotal = '<tr class="subtotal">'+
    '<td colspan="3">ì†Œê³„</td>'+
    ['ê·¼ë¬´ì‹œê°„','íœ´ê²Œì‹œê°„','ì ìš©ì‹œê°„'].map(c=>`<td>${totals[c].toFixed(2)}</td>`).join('')+
    overCols.map((c,idx)=>{
      const cls = idx===0 ? 'grp-over-first' : (idx===overCols.length-1?'grp-over-last':'grp-over-mid');
      const val = c.includes('ìˆ˜ë‹¹')? totals[c].toLocaleString(): totals[c].toFixed(2);
      return `<td class="${cls}">${val}</td>`;
    }).join('')+
    holCols.map((c,idx)=>{
      const cls = idx===0 ? 'grp-hol-first' : (idx===holCols.length-1?'grp-hol-last':'grp-hol-mid');
      const val = c.includes('ìˆ˜ë‹¹')? totals[c].toLocaleString(): totals[c].toFixed(2);
      return `<td class="${cls}">${val}</td>`;
    }).join('')+
  '</tr>';

  body+=subtotal+'</tbody>';
  tblSummary.innerHTML=thead+body;
}
function renderNextTable(rows){
  if(!rows || !rows.length){ tblNext.innerHTML='<thead><tr><th>ìµì›” ì ìš© ë°ì´í„° ì—†ìŒ</th></tr></thead>'; return; }
  renderTable(tblNext, rows);
}

/* === ì €ì¥(ë³€ê²½ ì—†ìŒ) === */
function toSheet(rows){ return XLSX.utils.json_to_sheet(rows); }
function saveXlsx(filename, sheets){
  if(typeof XLSX==='undefined' || typeof saveAs!=='function'){ showToast('ì €ì¥ì„ ìœ„í•´ XLSX/FileSaverê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
  const wb=XLSX.utils.book_new();
  sheets.forEach(s=>XLSX.utils.book_append_sheet(wb, s.ws, s.name));
  const now=new Date();
  const tag=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:"application/octet-stream"}), `ATEC_${filename}_${tag}.xlsx`);
}
$('btnSaveStatus').addEventListener('click', ()=>{ if(!dfStatus.length) return showToast('ë¨¼ì € ì‹œë®¬ë ˆì´ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”.'); saveXlsx('ê·¼íƒœí˜„í™©',[{name:'ê·¼íƒœí˜„í™©',ws:toSheet(dfStatus)}]); });
$('btnSaveSummary').addEventListener('click', ()=>{ if(!dfSummary.length) return showToast('ë¨¼ì € ì‹œë®¬ë ˆì´ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”.'); saveXlsx('ê·¼íƒœì •ë¦¬',[{name:'ê·¼íƒœì •ë¦¬',ws:toSheet(dfSummary)}]); });
$('btnSaveNext').addEventListener('click', ()=>{ if(!dfNext.length) return showToast('ìµì›”ì ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); saveXlsx('ìµì›”ì ìš©',[{name:'ìµì›”ì ìš©',ws:toSheet(dfNext)}]); });
$('btnSaveAll').addEventListener('click', ()=>{ if(!dfStatus.length||!dfSummary.length) return showToast('ë¨¼ì € ì‹œë®¬ë ˆì´ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”.'); saveXlsx('ê·¼íƒœ_í†µí•©',[{name:'ê·¼íƒœí˜„í™©',ws:toSheet(dfStatus)},{name:'ê·¼íƒœì •ë¦¬',ws:toSheet(dfSummary)},{name:'ìµì›”ì ìš©',ws:toSheet(dfNext||[])}]); });

/* === ë¦¬í¬íŠ¸(ë³€ê²½ ì—†ìŒ) === */
function renderReport(now, prev){
  const hasPrev = !!(prev && (prev.totalPay || prev.appliedTotal));

  function deltaArrow(val, prevVal) {
    const diff = (val || 0) - (prevVal || 0);
    const pct = (prevVal ? diff / prevVal * 100 : 0);
    const arrow = diff >= 0 ? 'â–²' : 'â–¼';
    const color = diff >= 0 ? '#ef4444' : '#2563eb';
    return {arrow, diff, pct, color};
  }

  // ì´ ìˆ˜ë‹¹(í° íƒ€ì´í‹€)
  $('sumTitle').textContent = `ì´ ìˆ˜ë‹¹(ì‹œê°„ì™¸+íœ´ì¼) ${(now.totalPay || 0).toLocaleString()}ì›`;

  // ì ìš©ì‹œê°„ Now
  $('appliedNow').textContent = (now.appliedTotal || 0).toFixed(1) + 'h';
  // ì‹œê°„ì™¸ìˆ˜ë‹¹ Now
  $('overPayNow').textContent = (now.overPay || 0).toLocaleString();
  // íœ´ì¼ìˆ˜ë‹¹ Now
  $('holPayNow').textContent = (now.holPay || 0).toLocaleString();

  if (hasPrev) {
    // ì „ì›” í‘œê¸° + ì¦ê°(ì ìš©/ì‹œê°„ì™¸/íœ´ì¼)
    const applied = deltaArrow(now.appliedTotal, prev.appliedTotal);
    $('appliedPrev').textContent = `(ì „ì›”: ${(prev.appliedTotal||0).toFixed(1)}h)`;
    $('appliedDelta').innerHTML =
      `<span style="color:${applied.color};font-weight:800;">${applied.arrow} ${Math.abs(applied.diff).toFixed(1)}h (${applied.pct.toFixed(1)}%)</span>`;

    const overPay = deltaArrow(now.overPay, prev.overPay);
    $('overPayPrev').textContent = `(ì „ì›”: ${(prev.overPay||0).toLocaleString()}ì›)`;
    $('overPayDelta').innerHTML =
      `<span style="color:${overPay.color};font-weight:800;">${overPay.arrow} ${Math.abs(overPay.diff).toLocaleString()}ì› (${overPay.pct.toFixed(1)}%)</span>`;

    const holPay = deltaArrow(now.holPay, prev.holPay);
    $('holPayPrev').textContent = `(ì „ì›”: ${(prev.holPay||0).toLocaleString()}ì›)`;
    $('holPayDelta').innerHTML =
      `<span style="color:${holPay.color};font-weight:800;">${holPay.arrow} ${Math.abs(holPay.diff).toLocaleString()}ì› (${holPay.pct.toFixed(1)}%)</span>`;

    // í—¤ë” ì¹´ë“œ í•˜ë‹¨ (ì „ì›”/ì¦ê°)
    $('sumMeta').textContent = `(ì „ì›”: ${(prev.totalPay||0).toLocaleString()}ì›)`;
    const d = (now.totalPay || 0) - (prev.totalPay || 0);
    const p = (prev.totalPay ? d / prev.totalPay * 100 : 0);
    const arrow = d >= 0 ? 'â–²' : 'â–¼';
    const col = d >= 0 ? '#ef4444' : '#2563eb';
    $('sumDelta').style.color = col;
    $('sumDelta').textContent = `${arrow} ${Math.abs(d).toLocaleString()}ì› (${p.toFixed(1)}%)`;

    // ì°¨íŠ¸(ì „ì›”/ë‹¹ì›” ë¹„êµ)
    const pct = (n, t) => t ? Math.round(n / t * 100) : 0;
    const prevT = (prev.overHours || 0) + (prev.holHours || 0);
    const nowT  = (now.overHours  || 0) + (now.holHours  || 0);
    drawDoughnut(donutPrev, ['ì—°ì¥ì‹œê°„', 'íœ´ì¼ì‹œê°„'],
      [pct(prev.overHours, prevT), pct(prev.holHours, prevT)],
      ['#fecaca', '#bfdbfe']);
    drawDoughnut(donutNow, ['ì—°ì¥ì‹œê°„', 'íœ´ì¼ì‹œê°„'],
      [pct(now.overHours, nowT), pct(now.holHours, nowT)],
      ['#ef4444', '#2563eb']);
    drawBars(barHours, ['ì ìš©ì‹œê°„(h)', 'ì—°ì¥ì‹œê°„(h)', 'íœ´ì¼ì‹œê°„(h)'],
      [prev.appliedTotal || 0, prev.overHours || 0, prev.holHours || 0],
      [now.appliedTotal || 0, now.overHours || 0, now.holHours || 0], false);
    drawBars(barPays, ['ì´ìˆ˜ë‹¹(ì›)', 'ì‹œê°„ì™¸ìˆ˜ë‹¹(ì›)', 'íœ´ì¼ìˆ˜ë‹¹(ì›)'],
      [prev.totalPay || 0, prev.overPay || 0, prev.holPay || 0],
      [now.totalPay || 0, now.overPay || 0, now.holPay || 0], true);

  } else {
    // ì „ì›” ë°ì´í„° ì—†ìŒ: ì „ì›”/ì¦ê° ìˆ¨ê¹€
    $('appliedPrev').textContent = '(ì „ì›” ë°ì´í„° ì—†ìŒ)';
    $('appliedDelta').textContent = '';

    $('overPayPrev').textContent = '(ì „ì›” ë°ì´í„° ì—†ìŒ)';
    $('overPayDelta').textContent = '';

    $('holPayPrev').textContent = '(ì „ì›” ë°ì´í„° ì—†ìŒ)';
    $('holPayDelta').textContent = '';

    $('sumMeta').textContent = '(ì „ì›” ë°ì´í„° ì—†ìŒ)';
    $('sumDelta').textContent = '';

    // ì°¨íŠ¸: ì „ì›”ì€ ë¹„ì›€, ë‹¹ì›”ë§Œ ì›í˜• í‘œì‹œ
    if (donutPrev && donutPrev._chart) { donutPrev._chart.destroy(); }
    const ctxH = barHours.getContext('2d');
    const ctxP = barPays.getContext('2d');
    ctxH.clearRect(0, 0, barHours.width, barHours.height);
    ctxP.clearRect(0, 0, barPays.width, barPays.height);

    drawDoughnut(donutNow, ['ì—°ì¥ì‹œê°„', 'íœ´ì¼ì‹œê°„'],
      [(now.overHours || 0), (now.holHours || 0)],
      ['#ef4444', '#2563eb']);
  }
}
/* === ì‹¤í–‰(ë³€ê²½ ì—†ìŒ) === */
$('btnRun').addEventListener('click', ()=>{
  try{
    const cur=process(curAttRows, curWageRows);
    dfStatus=cur.status; dfSummary=cur.summary; dfNext=cur.next;
    let prev={appliedTotal:0,overHours:0,holHours:0,overPay:0,holPay:0,totalPay:0};
    if(prevMergedMetrics) prev=prevMergedMetrics;
    else if(prevAttRows.length && prevWageRows.length) prev=process(prevAttRows, prevWageRows).metrics;
    renderTable(tblStatus, dfStatus);
    renderSummaryTable(dfSummary);
    renderNextTable(dfNext);
    renderReport(cur.metrics, prev);
    setActiveStep(2); goto(2);
    showToast('ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ');
  }catch(err){ console.error(err); showToast('ì‹¤íŒ¨: '+err.message); }
});

/* === ë„¤ë¹„(ë³€ê²½ ì—†ìŒ) === */
function goto(n){ const pages=[...document.querySelectorAll('.page')]; pages.forEach(p=>{p.classList.remove('show');p.style.display='none';}); const tgt=document.getElementById('page'+n); tgt.style.display='block'; requestAnimationFrame(()=>tgt.classList.add('show')); window.scrollTo({top:0,behavior:'smooth'}); }
function setActiveStep(n){ document.querySelectorAll('.step').forEach(x=>x.classList.remove('active')); document.querySelector(`.step[data-step="${n}"]`).classList.add('active'); }
document.querySelectorAll('.step').forEach(s=> s.addEventListener('click', ()=>{ const n=Number(s.dataset.step); setActiveStep(n); goto(n); }));

/* === ì—…ë¡œë“œ ë°”ì¸ë”©(ë³€ê²½ ì—†ìŒ: DOMContentLoaded ì´í›„) === */
function bindPickers(){
  attachPicker('curAtt','curAttName', async (file, name)=>{
    const {rows}=await readExcel(file);
    if(!rows.length) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_ATT.every(h=>cols.includes(h))){
      const map=await openMapper('ë‹¹ì›” ê·¼íƒœ RAW í—¤ë” ë§¤í•‘', REQUIRED_ATT, cols);
      curAttRows = normalizeRows(rows, map);
    }else curAttRows=rows;
    name.textContent=`ì„ íƒ ì™„ë£Œ Â· ${file.name} (${curAttRows.length}í–‰)`; updateRunBtn();
  });

  attachPicker('curWage','curWageName', async (file, name)=>{
    const {rows}=await readExcel(file);
    if(!rows.length) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_WAGE.every(h=>cols.includes(h))){
      const map=await openMapper('ë‹¹ì›” í†µìƒì‹œê¸‰ í—¤ë” ë§¤í•‘', REQUIRED_WAGE, cols);
      curWageRows = normalizeRows(rows, map);
    }else curWageRows=rows;
    name.textContent=`ì„ íƒ ì™„ë£Œ Â· ${file.name} (${curWageRows.length}í–‰)`; updateRunBtn();
  });

  attachPicker('prevAtt','prevAttName', async (file, name)=>{
    const {rows}=await readExcel(file);
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_ATT.every(h=>cols.includes(h))){
      const map=await openMapper('ì „ì›” ê·¼íƒœ RAW í—¤ë” ë§¤í•‘', REQUIRED_ATT, cols);
      prevAttRows = normalizeRows(rows, map);
    }else prevAttRows=rows;
    prevMergedMetrics=null;
    name.textContent=`ì „ì›” RAW ì„ íƒ Â· ${file.name} (${prevAttRows.length}í–‰)`;
  });

  attachPicker('prevWage','prevWageName', async (file, name)=>{
    const {rows}=await readExcel(file);
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_WAGE.every(h=>cols.includes(h))){
      const map=await openMapper('ì „ì›” í†µìƒì‹œê¸‰ í—¤ë” ë§¤í•‘', REQUIRED_WAGE, cols);
      prevWageRows = normalizeRows(rows, map);
    }else prevWageRows=rows;
    prevMergedMetrics=null;
    name.textContent=`ì „ì›” í†µìƒì‹œê¸‰ ì„ íƒ Â· ${file.name} (${prevWageRows.length}í–‰)`;
  });

  attachPicker('prevMerged','prevMergedName', async (file, name)=>{
    const {wb}=await readExcel(file, ['ê·¼íƒœì •ë¦¬']);
    if(!wb.Sheets['ê·¼íƒœì •ë¦¬']) throw new Error('ê·¼íƒœì •ë¦¬ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const rows=XLSX.utils.sheet_to_json(wb.Sheets['ê·¼íƒœì •ë¦¬'],{defval:null});
    const subtotal = rows.find(r=> Object.values(r).some(v=> String(v).includes('ì†Œê³„')));
    const sumCols=(keys)=> subtotal
      ? keys.reduce((a,k)=> a + number(subtotal[k]), 0)
      : rows.reduce((a,r)=> a + keys.reduce((s,k)=> s + number(r[k]),0), 0);
    const overHours = sumCols(['í‰ì¼ì—°ì¥','í‰ì¼ì•¼ê°„']);
    const holHours  = sumCols(['íœ´ì¼ì¼ë°˜','íœ´ì¼ì—°ì¥','íœ´ì¼ì•¼ê°„','íœ´ì¼ì—°ì¥ì•¼ê°„']);
    const overPay   = sumCols(['ì‹œê°„ì™¸ìˆ˜ë‹¹']);
    const holPay    = sumCols(['íœ´ì¼ìˆ˜ë‹¹']);
    const appliedTotal = rows.reduce((a,r)=> a + number(r['ì ìš©ì‹œê°„']), 0) || (overHours+holHours);
    prevMergedMetrics = {appliedTotal,overHours,holHours,overPay,holPay,totalPay:overPay+holPay,from:file.name};
    prevAttRows=[]; prevWageRows=[];
    name.textContent=`ì „ì›” í†µí•© ì§€ì • Â· ${file.name} (ê·¼íƒœì •ë¦¬ ${rows.length}í–‰)`; showToast('ì „ì›” í†µí•©ìë£Œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
}
document.addEventListener('DOMContentLoaded', ()=>{ try{ bindPickers(); } catch(e){ console.error(e); showToast('ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message);} });

/* === ì´ˆê¸° í˜ì´ì§€ === */
goto(1);
/* ===== ìµœì´ˆ ì•ˆë‚´ë¬¸ í™•ì¸ í›„ ë©”ì¸ í‘œì‹œ ===== */
document.getElementById('btnIntroOk').addEventListener('click', () => {
  document.getElementById('introOverlay').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

</script>
</body>
</html>
