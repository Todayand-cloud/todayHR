<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATEC 인사관리(근태) · v6.4</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 스타일 지정용 (가독성 서식) -->
<script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;
    --accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;--dark:#111827;
    --grp-ot-border:#ffbaba; /* 연한 빨강 */
    --grp-hol-border:#b9ccff; /* 연한 파랑 */
  }
  *{box-sizing:border-box}
  body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}

  .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line)}
  .stepper{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .step{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.25s;cursor:pointer}
  .step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
  .step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
  .step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
  .chev{flex:1;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);position:relative;min-width:40px}
  .chev:after{content:"";position:absolute;right:-8px;top:-6px;border:8px solid transparent;border-left-color:#e5e7eb;opacity:.7}

  main{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}

  .page{display:none;opacity:0;transform:translateY(8px);transition:opacity .35s ease,transform .35s ease}
  .page.show{display:block;opacity:1;transform:none}

  .upload{display:flex;gap:16px;flex-wrap:wrap}
  .upload-card{flex:1 1 31%;border:2px dashed var(--line);border-radius:12px;padding:20px;text-align:center;background:#fbfdff;min-width:260px}
  input[type=file]{display:none}
  label.pick{background:var(--dark);color:#fff;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;display:inline-block}
  label.pick.flash{background:#16a34a;animation:flash 1.1s ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
  .filename{display:block;color:#6b7280;margin-top:8px;min-height:20px}
  .btn{background:#111827;color:#fff;border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:700}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed}
  .btn:not([disabled]):hover{background:var(--accent1)}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#1e3a8a;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}

  .summary-grid{display:grid;grid-template-columns:1.1fr .9fr .9fr;gap:16px}
  .kpi{border:1px solid var(--line);border-radius:16px;padding:14px 16px}
  .kpi h3{margin:0;color:#6b7280;font-size:13px}
  .kpi .small{color:#374151;margin-top:6px;line-height:1.5}
  .kpi .big{font-size:26px;font-weight:800;line-height:1.25;margin-top:6px} /* 2pt 축소 */
  .kpi .delta{margin-top:12px;line-height:1.7} /* 줄간격 넓힘 */
  .delta-up{color:#dc2626}.delta-down{color:#2563eb}

  .chart-row{display:flex;gap:28px;justify-content:center;flex-wrap:wrap}
  .chart-box{width:520px;max-width:100%;text-align:center}
  canvas{width:100%;height:auto}

  table{width:100%;border-collapse:collapse;table-layout:auto}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:center;font-size:.92rem;white-space:nowrap} /* 1줄 고정 */
  th{background:#f3f4f6;position:sticky;top:0;z-index:1}

  /* 근태정리: 그룹 외곽 테두리만 강조 */
  #tblSummary th.ot-left,   #tblSummary td.ot-left{border-left:2px solid var(--grp-ot-border)}
  #tblSummary th.ot-right,  #tblSummary td.ot-right{border-right:2px solid var(--grp-ot-border)}
  #tblSummary th.hol-left,  #tblSummary td.hol-left{border-left:2px solid var(--grp-hol-border)}
  #tblSummary th.hol-right, #tblSummary td.hol-right{border-right:2px solid var(--grp-hol-border)}
  #tblSummary tr.subtotal-row td{font-weight:800;background:#fafafa;border-top:3px double #cbd5e1}

  /* 익월적용: 카드 안에서만 가로 스크롤 */
  .next-wrap{overflow-x:auto;border:1px dashed var(--line);border-radius:12px;padding:4px}

  /* 모달 기본 숨김 */
  .modal[aria-hidden="true"]{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:10000}
  .modal .panel{background:#fff;max-width:720px;width:92vw;border-radius:16px;box-shadow:0 16px 60px rgba(0,0,0,.35);padding:18px}
  .grid-map{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-map .cell{display:flex;align-items:center;gap:10px}
  .grid-map label{min-width:180px;font-weight:700}
  select{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px}
</style>
</head>
<body>
  <header>ATEC 인사관리(근태) 프로그램</header>

  <div class="topbar">
    <div class="stepper" id="stepper">
      <div class="step active" data-target="1"><div class="num">1</div><div>업로드</div></div>
      <div class="chev"></div>
      <div class="step" data-target="2"><div class="num">2</div><div>리포트</div></div>
      <div class="chev"></div>
      <div class="step" data-target="3"><div class="num">3</div><div>세부내역</div></div>
      <div class="chev"></div>
      <div class="step" data-target="4"><div class="num">4</div><div>데이터 저장</div></div>
    </div>
  </div>

  <main>
    <!-- 1. 업로드 -->
    <section id="page1" class="page show">
      <div class="card">
        <h2>안내사항</h2>
        <p>✔ 산정기간: 전월 21일 ~ 당월 20일 (결재 완료 기준)</p>
        <p>✔ 휴게시간: 4시간 초과 시 1시간 부여</p>
        <p>✔ 주 52시간 근무제: 휴일/야간근무는 주 12시간 이내 신청</p>
        <p>✔ 필요 RAW 데이터(2개)</p>
        <div style="padding-left:10px">
          <div style="margin:10px 0">1) 그룹웨어-시간외근무 승인(관리자)</div>
          <div style="margin:10px 0">2) ERP-책정임근현황(통상시급)</div>
        </div>
      </div>

      <div class="card">
        <h2>데이터 업로드</h2>

        <h3>당월 자료</h3>
        <div class="upload" style="margin-bottom:10px">
          <div class="upload-card">
            <label class="pick" for="fileAtt">근태 RAW</label>
            <input type="file" id="fileAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameAtt">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="fileWage">통상시급</label>
            <input type="file" id="fileWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="nameWage">선택된 파일 없음</span>
          </div>
        </div>

        <h3>전월 자료 <span class="muted">(선택사항)</span></h3>
        <div class="upload">
          <div class="upload-card">
            <label class="pick" for="filePrevAtt">전월 근태 RAW</label>
            <input type="file" id="filePrevAtt" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="namePrevAtt">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="filePrevWage">전월 통상시급</label>
            <input type="file" id="filePrevWage" accept=".xlsx,.xls,.xlsm,.csv" />
            <span class="filename" id="namePrevWage">선택된 파일 없음</span>
          </div>
          <div class="upload-card">
            <label class="pick" for="filePrevAll">전월 통합자료(통합저장)</label>
            <input type="file" id="filePrevAll" accept=".xlsx,.xls,.xlsm" />
            <span class="filename" id="namePrevAll">선택된 파일 없음</span>
          </div>
        </div>

        <div style="text-align:center;margin-top:20px;">
          <button class="btn" id="startSim" disabled>시뮬레이션 시작</button>
        </div>
      </div>
    </section>

    <!-- 2. 리포트 -->
    <section id="page2" class="page">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <span class="badge" id="prevState"><span>●</span> 전월 데이터: 미지정</span>
          <span class="muted" style="margin-left:10px">※ 전월 업로드 후 비교가 활성화됩니다.</span>
        </div>
        <button class="btn" id="btnPrevReset" style="background:#6b7280">전월 데이터 초기화</button>
      </div>

      <div class="card">
        <div class="summary-grid">
          <div class="kpi">
            <h3>총 적용시간</h3>
            <div class="small" id="appliedLine">당월: 0.0h (전월: 0.0h)</div>
            <div class="big" id="appliedNow">0.0h</div>
            <div class="delta" id="appliedDelta">—</div>
          </div>
          <div class="kpi">
            <h3>시간외수당</h3>
            <div class="small" id="overLine">당월: 0원 (전월: 0원)</div>
            <div class="big"><span id="overPayNow">0</span>원</div>
            <div class="delta" id="overPayDelta">—</div>
          </div>
          <div class="kpi">
            <h3>휴일수당</h3>
            <div class="small" id="holLine">당월: 0원 (전월: 0원)</div>
            <div class="big"><span id="holPayNow">0</span>원</div>
            <div class="delta" id="holPayDelta">—</div>
          </div>
        </div>

        <div class="card" style="margin:20px 0 6px;background:#f9fafb;border:1px dashed var(--line);padding:26px 16px">
          <div style="text-align:center">
            <div style="font-weight:800;font-size:24px;margin-bottom:10px">총 수당(시간외 + 휴일)</div>
            <div style="font-size:36px;font-weight:900;letter-spacing:-.2px;margin-bottom:12px" id="sumPayNow">0</div>
            <div class="small" id="sumLine" style="margin-bottom:8px;color:#374151">전월: 0원</div>
            <div class="delta" id="sumPayDelta">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="chart-row">
          <div class="chart-box">
            <div style="font-weight:700;margin-bottom:8px">전월 시간/수당 비율</div>
            <canvas id="donutPrev"></canvas>
            <p style="margin:.8rem 0 0;color:#374151;font-size:13px" id="prevSummaryInfo">—</p>
          </div>
          <div class="chart-box">
            <div style="font-weight:700;margin-bottom:8px">당월 시간/수당 비율</div>
            <canvas id="donutNow"></canvas>
            <p style="margin:.8rem 0 0;color:#374151;font-size:13px" id="nowSummaryInfo">—</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">전월 대비 비교 차트</h3>
        <div class="chart-row" style="gap:30px">
          <div class="chart-box">
            <canvas id="barHours"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">시간 비교(적용·연장·휴일) — <b>전월(좌, 파랑) vs 당월(우, 연한 빨강)</b></p>
          </div>
          <div class="chart-box">
            <canvas id="barPays"></canvas>
            <p style="margin:.5rem 0 0;color:#374151">수당 비교(시간외·휴일·총) — <b>전월(좌, 파랑) vs 당월(우, 연한 빨강)</b></p>
          </div>
        </div>
      </div>
    </section>

    <!-- 3. 세부내역 -->
    <section id="page3" class="page">
      <div class="card">
        <h2>근태현황</h2>
        <table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table>
      </div>
      <div class="card">
        <h2>근태정리</h2>
        <table id="tblSummary"><thead><tr><th>데이터 없음</th></tr></thead></table>
      </div>
      <div class="card">
        <h2>익월적용</h2>
        <div class="next-wrap">
          <table id="tblNext"><thead><tr><th>데이터 없음</th></tr></thead></table>
        </div>
      </div>
    </section>

    <!-- 4. 데이터 저장 -->
    <section id="page4" class="page">
      <div class="card">
        <h2 style="margin-top:0">엑셀 다운로드</h2>
        <p class="muted" style="margin-top:-4px">버튼을 클릭하면 .xlsx 저장 창이 열립니다.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn" id="btnSaveStatus">근태현황 저장</button>
          <button class="btn" id="btnSaveSummary">근태정리 저장</button>
          <button class="btn" id="btnSaveNext">익월적용 저장</button>
          <button class="btn" style="flex:3 1 0;background:#2563eb" id="btnSaveAll">통합저장</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 헤더 매핑 모달(기본 숨김) -->
  <div class="modal" id="mapModal" aria-hidden="true">
    <div class="panel">
      <h3 style="margin:0 0 8px 0" id="mapTitle">헤더 매핑</h3>
      <p class="muted" style="margin-top:0">업로드한 파일의 열 이름을 아래 표준 항목에 연결하세요.</p>
      <div class="grid-map" id="mapGrid"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
        <button class="btn" id="btnMapCancel" style="background:#6b7280">취소</button>
        <button class="btn" id="btnMapOk">매핑 완료</button>
      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none"></div>

<script>
/* ===== 도우미 ===== */
const $=(id)=>document.getElementById(id);
const showToast=(m)=>{const t=$('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2200);};
const steps=[...document.querySelectorAll('.stepper .step')];
const pages=[$('page1'),$('page2'),$('page3'),$('page4')];
function gotoStep(n){steps.forEach(s=>s.classList.remove('active'));steps[n-1].classList.add('active');pages.forEach(p=>{p.classList.remove('show');p.style.display='none';});const tgt=pages[n-1];tgt.style.display='block';requestAnimationFrame(()=>tgt.classList.add('show'));window.scrollTo({top:0,behavior:'smooth'});}
steps.forEach(s=>s.addEventListener('click',()=>gotoStep(Number(s.dataset.target))));

/* ===== 필수 헤더 ===== */
const REQUIRED_ATT=["신청시간","근무자 부서","근무자","근무일","근무유형","종결일자","상태"];
const REQUIRED_WAGE=["부서","이름","통상시급"];

/* ===== 상태 ===== */
let attRowsRaw=[], wageRowsRaw=[], prevAttRaw=[], prevWageRaw=[];
let attRows=[], wageRows=[];
let okAtt=false, okWage=false;
let prevMetrics=null;
let currentResult=null;

/* ===== 시간/유틸 ===== */
const date21=new Date(new Date().getFullYear(), new Date().getMonth(), 21);
function hourMod24(t){ return t - 24*Math.floor(t/24); }
function parseTime(s){ if(s==null) return -1; let st=String(s).trim(); if(!st) return -1; st=st.replace(/\s+/g,"").replace("시",":").replace("분",""); if(!st.includes(":")){ if(!/^\d+$/.test(st)) return -1; const n=parseInt(st,10); if(st.length<=2) return n; if(st.length<=4) return Math.floor(n/100)+(n%100)/60; return -1;} let [h,m]=st.split(":"); h=parseInt(h,10); m=parseInt(m,10); if(isNaN(h)||isNaN(m)||m<0||m>=60) return -1; return h + m/60; }
const ceilHalf=x=> Math.ceil(Number(x)/0.5)*0.5;
const fmtHM=d=>{ const h=Math.floor(d)%24; const m=Math.round((d-Math.floor(d))*60)%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };
const toNum=v=>{ const n=Number(v); return isNaN(n)?0:n; };
const sum=(arr,key)=> arr.reduce((a,b)=>a+toNum(b[key]),0);

/* ===== 엑셀 파서 ===== */
function parseExcel(file, preferSheetNames=[]){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=(e)=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        let sheet=null;
        for(const name of preferSheetNames){ if(wb.Sheets[name]){ sheet=wb.Sheets[name]; break; } }
        if(!sheet){ sheet = wb.Sheets[wb.SheetNames[0]]; }
        resolve({rows:XLSX.utils.sheet_to_json(sheet,{defval:null}), wb});
      }catch(err){reject(err);}
    };
    reader.readAsArrayBuffer(file);
  });
}

/* ===== 헤더 매핑 ===== */
function guessMapKeys(required, columns){
  const syn = {
    "신청시간": ["신청시간","시간","근무시간대","근무신청시간","시작~종료","근무시간(신청)"],
    "근무자 부서": ["근무자 부서","부서","부서(팀)","부서명","소속"],
    "근무자": ["근무자","이름","성명","근무자명","사원명"],
    "근무일": ["근무일","일자","근무일자","날짜"],
    "근무유형": ["근무유형","유형","구분","근무구분"],
    "종결일자": ["종결일자","결재일자","승인일자","종결일","결재일"],
    "상태": ["상태","결재상태","승인상태"],
    "부서": ["부서","부서명","소속","부서(팀)"],
    "이름": ["이름","성명","사원명"],
    "통상시급": ["통상시급","기본시급","시급","통상 임금","통상임금"]
  };
  const map={};
  required.forEach(key=>{
    const cands=(syn[key]||[]).map(s=>s.toLowerCase());
    let pick = columns.find(c=>c.toLowerCase()===key.toLowerCase());
    if(!pick){ pick = columns.find(c=>cands.includes(c.toLowerCase())); }
    map[key]= pick || "";
  });
  return map;
}
function openMapper(title, requiredKeys, columns, onApply){
  $('mapTitle').textContent = title;
  const grid=$('mapGrid'); grid.innerHTML="";
  const guesses = guessMapKeys(requiredKeys, columns);
  requiredKeys.forEach(k=>{
    const wrap=document.createElement('div'); wrap.className='cell';
    const lab=document.createElement('label'); lab.textContent=k;
    const sel=document.createElement('select'); sel.dataset.key=k;
    sel.appendChild(new Option('-- 열 선택 --',''));
    columns.forEach(col=> sel.appendChild(new Option(col,col)));
    sel.value = guesses[k] || "";
    wrap.appendChild(lab); wrap.appendChild(sel);
    grid.appendChild(wrap);
  });
  const modal=$('mapModal'); modal.setAttribute('aria-hidden','false');
  $('btnMapCancel').onclick=()=> modal.setAttribute('aria-hidden','true');
  $('btnMapOk').onclick=()=>{
    const selects=[...grid.querySelectorAll('select')];
    const mapping={};
    for(const s of selects){
      if(!s.value){ showToast('모든 항목을 매핑해 주세요.'); return; }
      mapping[s.dataset.key]=s.value;
    }
    modal.setAttribute('aria-hidden','true');
    onApply(mapping);
  };
}
function normalizeRows(rows, mapping){
  return rows.map(r=>{
    const o={};
    Object.keys(mapping).forEach(k=>{ o[k]= r[mapping[k]]; });
    return o;
  });
}

/* ===== 파일 선택(1회만 뜨게) ===== */
function hookPicker(inputId, nameId, type){
  const input=$(inputId), name=$(nameId), label=document.querySelector(`label[for="${inputId}"]`);
  label.addEventListener('click',()=>{ input.value=""; });
  input.addEventListener('click',()=>{ input.value=""; });
  input.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0];
    if(!f){ name.textContent='선택된 파일 없음'; return; }
    name.textContent='분석 중…';
    try{
      if(type==='prevAll'){
        const {rows, wb} = await parseExcel(f, ['근태정리']);
        let sheetRows = rows;
        if(wb.Sheets['근태정리']) sheetRows = XLSX.utils.sheet_to_json(wb.Sheets['근태정리'],{defval:null});
        const g=(k)=> sheetRows.reduce((a,b)=> a+(Number(b[k])||0),0);
        prevMetrics = {
          appliedTotal: +(g('적용시간')||0),
          overHours: +(g('평일연장')+g('평일야간')||0),
          holHours: +(g('휴일일반')+g('휴일연장')+g('휴일야간')+g('휴일연장야간')||0),
          overPay: +(g('시간외수당')||0),
          holPay: +(g('휴일수당')||0),
          totalPay: +(g('시간외수당')+g('휴일수당')||0),
          from:f.name
        };
        label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');
        name.textContent=`전월 통합: 업로드됨 · ${f.name} (${sheetRows.length}행)`;
        updatePrevBadge(); if(currentResult) renderReport(currentResult);
        return;
      }
      if(type==='prevAtt' || type==='prevWage'){
        const {rows} = await parseExcel(f);
        const cols=Object.keys(rows[0]||{});
        if(type==='prevAtt'){
          if(!REQUIRED_ATT.every(h=>cols.includes(h))){
            openMapper('전월 근태 RAW 헤더 매핑', REQUIRED_ATT, cols, (mapping)=>{
              prevAttRaw = normalizeRows(rows, mapping);
              name.textContent=`전월 근태 RAW: 업로드됨 · ${f.name} (${prevAttRaw.length}행)`; tryBuildPrevFromPair();
            });
          }else{ prevAttRaw=rows; name.textContent=`전월 근태 RAW: 업로드됨 · ${f.name} (${rows.length}행)`; tryBuildPrevFromPair(); }
        }else{
          if(!REQUIRED_WAGE.every(h=>cols.includes(h))){
            openMapper('전월 통상시급 헤더 매핑', REQUIRED_WAGE, cols, (mapping)=>{
              prevWageRaw = normalizeRows(rows, mapping);
              name.textContent=`전월 통상시급: 업로드됨 · ${f.name} (${prevWageRaw.length}행)`; tryBuildPrevFromPair();
            });
          }else{ prevWageRaw=rows; name.textContent=`전월 통상시급: 업로드됨 · ${f.name} (${rows.length}행)`; tryBuildPrevFromPair(); }
        }
        label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');
        return;
      }

      // 당월
      const {rows} = await parseExcel(f);
      const cols=Object.keys(rows[0]||{});
      label.classList.remove('flash'); void label.offsetWidth; label.classList.add('flash');

      if(type==='att'){
        attRowsRaw=rows.slice();
        const hasAll = REQUIRED_ATT.every(h=>cols.includes(h));
        if(!hasAll){
          openMapper('근태 RAW 헤더 매핑', REQUIRED_ATT, cols, (mapping)=>{
            attRows = normalizeRows(attRowsRaw, mapping);
            name.textContent=`선택 완료 · ${f.name} (${attRows.length}행)`; okAtt=true; updateStartBtn();
          });
        }else{ attRows=rows; name.textContent=`선택 완료 · ${f.name} (${attRows.length}행)`; okAtt=true; updateStartBtn(); }
      }else if(type==='wage'){
        wageRowsRaw=rows.slice();
        const hasAll = REQUIRED_WAGE.every(h=>cols.includes(h));
        if(!hasAll){
          openMapper('통상시급 헤더 매핑', REQUIRED_WAGE, cols, (mapping)=>{
            wageRows = normalizeRows(wageRowsRaw, mapping);
            name.textContent=`선택 완료 · ${f.name} (${wageRows.length}행)`; okWage=true; updateStartBtn();
          });
        }else{ wageRows=rows; name.textContent=`선택 완료 · ${f.name} (${wageRows.length}행)`; okWage=true; updateStartBtn(); }
      }
    }catch(err){ console.error(err); name.textContent='파싱 실패'; showToast('파일 파싱 실패: '+err.message); }
  });
}
hookPicker('fileAtt','nameAtt','att');
hookPicker('fileWage','nameWage','wage');
hookPicker('filePrevAtt','namePrevAtt','prevAtt');
hookPicker('filePrevWage','namePrevWage','prevWage');
hookPicker('filePrevAll','namePrevAll','prevAll');

function updateStartBtn(){ $('startSim').disabled=!(okAtt && okWage); }

/* ===== 동일 로직 처리 ===== */
function process(att, wage){
  let _status=[], _summary=[], _next=[];
  const agg={};
  const ensure=(name,dept)=>{ if(!agg[name]) agg[name]={부서:dept,이름:name,근무시간:0,휴게시간:0,적용시간:0,평일연장:0,평일야간:0,휴일일반:0,휴일연장:0,휴일야간:0,휴일연장야간:0}; };

  const cols=Object.keys(att[0]||{});
  if(!REQUIRED_ATT.every(h=>cols.includes(h))) throw new Error('근태 RAW에 필수 헤더가 없습니다. (매핑 필요)');

  for(const r of att){
    if(String(r['상태']||'').includes('반려')) continue;
    const raw=String(r['신청시간']||'');
    let closeDate=r['종결일자']? new Date(r['종결일자']):null;
    if(!raw.includes('~')){ if(closeDate && closeDate>=date21) _next.push(r); continue; }

    let [s,e]=raw.split('~').map(x=>x.trim());
    let sh=parseTime(s), eh=parseTime(e); if(sh<0||eh<0){ if(closeDate && closeDate>=date21) _next.push(r); continue; }
    if(eh<sh) eh+=24;

    const work=eh-sh, brk=Math.floor(work/5), applied=work-brk;

    if(closeDate && closeDate<date21){
      _status.push({순번:null,부서:r['근무자 부서'],이름:r['근무자'],근무일자:r['근무일'],근무유형:r['근무유형'],근무시작시간:fmtHM(sh),근무종료시간:fmtHM(eh),근무시간:+work.toFixed(2),휴게시간:+brk.toFixed(2),적용시간:+applied.toFixed(2),정수:ceilHalf(applied)});
      const name=String(r['근무자']||'').replace('(IT)','').trim(); const dept=r['근무자 부서']; const ty=String(r['근무유형']||'').toLowerCase(); 
      if(!name) continue;
      ensure(name,dept);
      const A=agg[name]; A.근무시간+=work; A.휴게시간+=brk; A.적용시간+=applied;

      let effStart=sh+brk; if(effStart>eh) effStart=eh;
      for(let t=effStart; t<eh-1e-6; t+=0.25){
        const hod=hourMod24(t); const worked=t-effStart;
        if(ty.includes('연장') && !ty.includes('휴일')){
          if(hod>=18 && hod<22) A.평일연장+=0.25;
          if(hod>=22 || hod<6)  A.평일야간+=0.25;
        } else if(ty.includes('휴일')){
          if(worked<8){ if(hod>=6&&hod<22) A.휴일일반+=0.25; else A.휴일야간+=0.25; }
          else { if(hod>=6&&hod<22) A.휴일연장+=0.25; else A.휴일연장야간+=0.25; }
        }
      }
    } else { _next.push(r); }
  }
  _status.forEach((r,i)=> r.순번=i+1);
  _summary=Object.values(agg).map((A,i)=>({순번:i+1,부서:A.부서,이름:A.이름,근무시간:+A.근무시간.toFixed(2),휴게시간:+A.휴게시간.toFixed(2),적용시간:+A.적용시간.toFixed(2),평일연장:+A.평일연장.toFixed(2),평일야간:+A.평일야간.toFixed(2),휴일일반:+A.휴일일반.toFixed(2),휴일연장:+A.휴일연장.toFixed(2),휴일야간:+A.휴일야간.toFixed(2),휴일연장야간:+A.휴일연장야간.toFixed(2)}));

  // 통상시급 수당
  let overPay=0, holPay=0, totalPay=0;
  if(wage && wage.length){
    const cols2=Object.keys(wage[0]||{});
    if(!REQUIRED_WAGE.every(h=>cols2.includes(h))) throw new Error('통상시급 파일 헤더 누락(매핑 필요)');

    const map=new Map(); wage.forEach(r=>{ const d=String(r['부서']||'').trim(); const n=String(r['이름']||'').trim(); const w=Number(r['통상시급']); if(n) map.set(`${d}|${n}`, isNaN(w)?0:w); });
    const mult={평일연장:1.5, 평일야간:2.0, 휴일일반:1.5, 휴일연장:2.0, 휴일야간:2.0, 휴일연장야간:2.5};
    _summary=_summary.map(r=>{
      const key=`${r['부서']}|${r['이름']}`; const base=map.has(key)?map.get(key):0;
      const N=Math.ceil(base*mult.평일연장*toNum(r['평일연장']));
      const O=Math.ceil(base*mult.평일야간*toNum(r['평일야간']));
      const P=Math.ceil(base*mult.휴일일반*toNum(r['휴일일반']));
      const Q=Math.ceil(base*mult.휴일연장*toNum(r['휴일연장']));
      const R=Math.ceil(base*mult.휴일야간*toNum(r['휴일야간']));
      const S=Math.ceil(base*mult.휴일연장야간*toNum(r['휴일연장야간']));
      overPay += (N+O); holPay += (P+Q+R+S);
      return {...r, 시간외수당:N+O, 휴일수당:P+Q+R+S};
    });
    totalPay = overPay + holPay;
  }
  return {
    status:_status, summary:_summary, next:_next,
    metrics:{
      appliedTotal: sum(_status,'적용시간'),
      overHours: sum(_summary,'평일연장')+sum(_summary,'평일야간'),
      holHours: sum(_summary,'휴일일반')+sum(_summary,'휴일연장')+sum(_summary,'휴일야간')+sum(_summary,'휴일연장야간'),
      overPay, holPay, totalPay
    }
  };
}
function tryBuildPrevFromPair(){
  if(!prevAttRaw.length) return;
  try{
    const tmp = process(prevAttRaw, prevWageRaw||[]);
    prevMetrics = {...tmp.metrics, from:'전월 개별 업로드'};
  }catch(e){
    // 최소 적용시간만
    let applied=0; for(const r of prevAttRaw){ const raw=String(r['신청시간']||''); if(!raw.includes('~')) continue; let [s,e]=raw.split('~').map(x=>x.trim()); let sh=parseTime(s), eh=parseTime(e); if(sh<0||eh<0) continue; if(eh<sh) eh+=24; const w=eh-sh, br=Math.floor(w/5); applied+=w-br; }
    prevMetrics={appliedTotal:+applied.toFixed(1)||0, overHours:0, holHours:0, overPay:0, holPay:0, totalPay:0, from:'전월 개별 업로드'};
  }
  updatePrevBadge(); if(currentResult) renderReport(currentResult);
}

/* ===== 차트 라벨: 겹침 방지 개선 ===== */
const BarValuePlugin = {
  id:'barValue',
  afterDatasetsDraw(chart){
    const {ctx} = chart;
    const isMoney = chart.$money || false;
    const metas = chart.data.datasets.map((_,i)=> chart.getDatasetMeta(i));
    metas.forEach((meta, di)=>{
      meta.data.forEach((el, i)=>{
        const raw = chart.data.datasets[di].data[i]; if(raw==null) return;
        const text = isMoney ? Number(raw).toLocaleString() : (typeof raw==='number' ? (Math.round(raw*10)/10).toString() : raw);

        // 다른 막대와의 픽셀 간격 확인
        const mate = metas[(di+1)%metas.length]?.data[i];
        let x = el.x, y = el.y - 6;
        if(mate){
          const dy = Math.abs(mate.y - el.y);
          if(dy < 16){ // 너무 가까우면 한쪽은 위로, 한쪽은 아래로
            if(di===0) y = el.y - 18;
            else       y = el.y + 14;
          }
          // 좌우로도 살짝 벌려주기
          x += (di===0 ? -8 : +8);
        }
        // 최소 y 보정
        if (y < chart.chartArea.top + 12) y = chart.chartArea.top + 12;

        ctx.save();
        ctx.font='12px Pretendard, sans-serif';
        ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=3; ctx.textAlign='center';
        ctx.strokeText(text, x, y);
        ctx.fillStyle = di===0 ? '#2563eb' : '#b91c1c';
        ctx.fillText(text, x, y);
        ctx.restore();
      });
    });
  }
};
const DoughnutPercentPlugin = {
  id:'donutPercent',
  afterDatasetsDraw(chart){
    if(chart.config.type!=='doughnut') return;
    const {ctx} = chart;
    const ds = chart.data.datasets[0]; if(!ds) return;
    const meta = chart.getDatasetMeta(0);
    const total = ds.data.reduce((a,b)=>a+(+b||0),0) || 0;
    meta.data.forEach((arc, i)=>{
      const val=+ds.data[i]||0; if(!val || total===0) return;
      const p = Math.round(val/total*100);
      const pos = arc.tooltipPosition();
      ctx.save();
      ctx.font='bold 13px Pretendard, sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=3;
      ctx.strokeText(p+'%', pos.x, pos.y);
      ctx.fillStyle='#111827';
      ctx.fillText(p+'%', pos.x, pos.y);
      ctx.restore();
    });
  }
};

const donutPrev=$('donutPrev'), donutNow=$('donutNow'), barHours=$('barHours'), barPays=$('barPays');

function drawDoughnut(ctxRef, labels, data, colors){
  const filt = data.map((v,i)=>({v,i})).filter(o=>o.v>0);
  const L=filt.map(o=>labels[o.i]), D=filt.map(o=>data[o.i]), C=filt.map(o=>colors[o.i]);
  if(ctxRef._chart) ctxRef._chart.destroy();
  ctxRef._chart = new Chart(ctxRef,{
    type:'doughnut',
    data:{labels:L, datasets:[{data:D, backgroundColor:C, borderWidth:0}]},
    options:{ plugins:{legend:{display:true,position:'bottom'}}, cutout:'65%' },
    plugins:[DoughnutPercentPlugin]
  });
}
function drawGroupedBars(ctxRef, labels, prev, now, isMoney){
  if(ctxRef._chart) ctxRef._chart.destroy();
  const chart = new Chart(ctxRef,{
    type:'bar',
    data:{labels,
      datasets:[
        {label:'전월', data:prev, backgroundColor:'rgba(37,99,235,0.55)', borderRadius:6},
        {label:'당월', data:now,  backgroundColor:'rgba(239,68,68,0.45)', borderRadius:6}
      ]
    },
    options:{
      categoryPercentage:0.7, barPercentage:0.85,
      plugins:{ legend:{display:true,position:'bottom'},
                tooltip:{callbacks:{label:(c)=> isMoney? Number(c.parsed.y).toLocaleString() : c.parsed.y}} },
      scales:{ y:{ grid:{color:'#eef2ff'},
                   ticks:{ callback:(v)=> isMoney? Number(v).toLocaleString() : v },
                   suggestedMax: Math.max(...prev,...now)*1.25 || 10 } }
    },
    plugins:[BarValuePlugin]
  });
  chart.$money = isMoney;
  ctxRef._chart = chart;
}

/* ===== 리포트 렌더 ===== */
const appliedLine=$('appliedLine'), overLine=$('overLine'), holLine=$('holLine');
const appliedNow=$('appliedNow'), overPayNow=$('overPayNow'), holPayNow=$('holPayNow');
const appliedDelta=$('appliedDelta'), overPayDelta=$('overPayDelta'), holPayDelta=$('holPayDelta');
const sumPayNow=$('sumPayNow'), sumPayDelta=$('sumPayDelta'), sumLine=$('sumLine');
const prevInfo=$('prevSummaryInfo'), nowInfo=$('nowSummaryInfo');

function makeDeltaText(now, prev, unit, isMoney){
  const d = now - (prev||0);
  const pct = (prev && prev!==0)? (d/prev*100) : 0;
  const arrow = d>0? '▲' : (d<0? '▼' : '—');
  const cls = d>0? 'delta-up' : (d<0? 'delta-down' : '');
  const fmtNow = isMoney? now.toLocaleString() : now.toFixed(1);
  const fmtPrev= isMoney? (prev||0).toLocaleString() : (prev||0).toFixed(1);
  const fmtDelta = isMoney? Math.abs(d).toLocaleString() : Math.abs(d).toFixed(1);
  const pctText = `(${Math.abs(pct).toFixed(1)}%)`;
  return { line:`당월: ${fmtNow}${unit} (전월: ${fmtPrev}${unit})`, delta:`<span class="${cls}">${arrow} ${fmtDelta}${unit} ${pctText}</span>` };
}
function renderReport(cur){
  const M=cur.metrics;
  const nowApplied=M.appliedTotal||0, nowOverPay=M.overPay||0, nowHolPay=M.holPay||0, nowSumPay=nowOverPay+nowHolPay;

  const prevApplied=prevMetrics?.appliedTotal||0;
  const prevOverPay=prevMetrics?.overPay||0;
  const prevHolPay =prevMetrics?.holPay||0;
  const prevSumPay =(prevOverPay+prevHolPay)||0;
  const prevOverH =prevMetrics?.overHours||0;
  const prevHolH  =prevMetrics?.holHours||0;

  const A=makeDeltaText(nowApplied, prevApplied, 'h', false);
  const O=makeDeltaText(nowOverPay, prevOverPay, '원', true);
  const H=makeDeltaText(nowHolPay, prevHolPay, '원', true);
  const T=makeDeltaText(nowSumPay, prevSumPay, '원', true);

  appliedLine.textContent=A.line; appliedNow.textContent=`${nowApplied.toFixed(1)}h`; appliedDelta.innerHTML=A.delta;
  overLine.textContent=O.line; overPayNow.textContent=nowOverPay.toLocaleString(); overPayDelta.innerHTML=O.delta;
  holLine.textContent=H.line; holPayNow.textContent=nowHolPay.toLocaleString(); holPayDelta.innerHTML=H.delta;
  sumPayNow.textContent=nowSumPay.toLocaleString(); sumPayDelta.innerHTML=T.delta; sumLine.textContent=`전월: ${prevSumPay.toLocaleString()}원`;

  const nowOtherH = Math.max(0, nowApplied - (M.overHours + M.holHours));
  const prevOtherH= Math.max(0, prevApplied - (prevOverH + prevHolH));

  drawDoughnut(donutPrev, ['연장시간','휴일시간','기타'], [prevOverH, prevHolH, prevOtherH],
               ['rgba(239,68,68,0.32)','rgba(37,99,235,0.32)','rgba(229,231,235,0.45)']);
  drawDoughnut(donutNow,  ['연장시간','휴일시간','기타'], [M.overHours, M.holHours, nowOtherH],
               ['rgba(239,68,68,0.88)','rgba(37,99,235,0.88)','rgba(229,231,235,0.75)']);

  prevInfo.textContent=`연장시간 ${prevOverH.toFixed(1)}h · 휴일시간 ${prevHolH.toFixed(1)}h · 총수당 ${prevSumPay.toLocaleString()}원`;
  nowInfo.textContent =`연장시간 ${M.overHours.toFixed(1)}h · 휴일시간 ${M.holHours.toFixed(1)}h · 총수당 ${nowSumPay.toLocaleString()}원`;

  drawGroupedBars(barHours, ['적용시간(h)','연장시간(h)','휴일시간(h)'],
                  [prevApplied, prevOverH, prevHolH],
                  [nowApplied,  M.overHours, M.holHours], false);

  drawGroupedBars(barPays,  ['시간외수당(원)','휴일수당(원)','총수당(원)'],
                  [prevOverPay, prevHolPay, prevSumPay],
                  [nowOverPay,  nowHolPay,  nowSumPay], true);

  updatePrevBadge();
}

/* ===== 테이블 ===== */
const tblStatus=$('tblStatus'), tblSummary=$('tblSummary'), tblNext=$('tblNext');

function renderStatusTable(rows){
  if(!rows?.length){ tblStatus.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const cols=Object.keys(rows[0]);
  let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const sumKeys=['근무시간','휴게시간','적용시간','정수'];
  const sums={}; sumKeys.forEach(k=> sums[k]= rows.reduce((a,b)=> a+(Number(b[k])||0),0));
  const body=rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')
    + '<tr class="subtotal-row">'+cols.map(c=>`<td>${sumKeys.includes(c)?(c==='정수'?sums[c].toLocaleString():Number(sums[c]).toFixed(2)): (c==='순번'?'소계':'')}</td>`).join('')+'</tr>';
  tblStatus.innerHTML=thead+'<tbody>'+body+'</tbody>';
}

function renderSummaryTable(rows){
  if(!rows?.length){ tblSummary.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const order=['순번','부서','이름','근무시간','휴게시간','적용시간',
               '평일연장','평일야간','시간외수당',
               '휴일일반','휴일연장','휴일야간','휴일연장야간','휴일수당'];
  const cols=order.filter(c=>c in rows[0]);

  // 헤더에 그룹 외곽 테두리 클래스 부여
  const ths=cols.map(c=>{
    let cls='';
    if(c==='평일연장') cls='ot-left';
    if(c==='시간외수당') cls='ot-right';
    if(c==='휴일일반') cls='hol-left';
    if(c==='휴일수당') cls='hol-right';
    return `<th class="${cls}">${c}</th>`;
  }).join('');
  let thead='<thead><tr>'+ths+'</tr></thead>';

  const moneyCols=new Set(['시간외수당','휴일수당']);
  const bodyRows=rows.map(r=>{
    return '<tr>'+cols.map(c=>{
      const val = moneyCols.has(c)? Number(r[c]||0).toLocaleString() : (r[c]??'');
      let cls='';
      if(c==='평일연장') cls='ot-left';
      if(c==='시간외수당') cls='ot-right';
      if(c==='휴일일반') cls='hol-left';
      if(c==='휴일수당') cls='hol-right';
      return `<td class="${cls}">${val}</td>`;
    }).join('')+'</tr>';
  }).join('');

  const sumKeys=['근무시간','휴게시간','적용시간','시간외수당','휴일수당'];
  const sums={}; sumKeys.forEach(k=> sums[k]= rows.reduce((a,b)=> a+(Number(b[k])||0),0));
  const subtotal='<tr class="subtotal-row">'+cols.map(c=>{
    if(c==='순번') return '<td>소계</td>';
    if(sumKeys.includes(c)) return `<td>${(c.includes('수당')?Number(sums[c]).toLocaleString():sums[c].toFixed(2))}</td>`;
    return '<td></td>';
  }).join('')+'</tr>';

  tblSummary.innerHTML=thead+'<tbody>'+bodyRows+subtotal+'</tbody>';
}

function renderNextTable(rows){
  if(!rows?.length){ tblNext.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  // _empty* 칼럼 제거
  const allCols=Object.keys(rows[0]).filter(c=>!/^_empty/.test(c));
  let thead='<thead><tr>'+allCols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  let body=rows.map(r=>'<tr>'+allCols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('');
  tblNext.innerHTML=thead+'<tbody>'+body+'</tbody>';
}

/* ===== 실행 ===== */
let dfStatus=[], dfSummary=[], dfNext=[];
$('startSim').addEventListener('click', ()=>{
  try{
    const cur=process(attRows, wageRows);
    currentResult = cur;
    dfStatus=cur.status; dfSummary=cur.summary; dfNext=cur.next;

    renderReport(cur);
    renderStatusTable(cur.status);
    renderSummaryTable(cur.summary);
    renderNextTable(cur.next);

    showToast('시뮬레이션 완료'); gotoStep(2);
  }catch(err){ showToast('시뮬레이션 실패: '+err.message); console.error(err); }
});

/* ===== 저장(.xlsx, 서식 입힘) ===== */
const companyPrefix="ATEC";
function aoaFromRows(rows){
  const cols=Object.keys(rows[0]||{});
  const data=[cols];
  rows.forEach(r=> data.push(cols.map(c=> r[c])));
  return {cols, data};
}
async function saveXlsxStyled(filename, sheets){
  try{
    const wb = await XlsxPopulate.fromBlankAsync();
    // 기본 시트 제거
    wb.sheets().forEach((s,i)=>{ if(i>0) return; wb.deleteSheet(s); });
    for(const s of sheets){
      const sheet = wb.addSheet(s.name);
      const {cols, data} = aoaFromRows(s.rows);
      sheet.cell(1,1).value(data);

      // 머리글 스타일
      sheet.row(1).style({bold:true, fill:'#F3F4F6', border:true});
      // 숫자 서식
      const moneyCols = cols.map((c,i)=> (c.includes('수당')? i+1 : null)).filter(Boolean);
      moneyCols.forEach(ci=>{
        sheet.range(2,ci, data.length,ci).style({numberFormat:'#,##0'});
      });
      // 열너비 & 행높이
      cols.forEach((c,i)=> sheet.column(i+1).width(Math.max(10, Math.min(28, c.length*2+6))));
      sheet.row(1).height(22);
      // 얇은 외곽선
      sheet.usedRange().style({border:{style:'thin',color:'#E5E7EB'}});
      // 소계 행(마지막) 굵게 + 이중 상단선
      if(s.subtotal){
        const r = data.length; // 마지막
        sheet.row(r).style({bold:true});
        sheet.range(r,1,r,cols.length).style({topBorder:{style:'double',color:'#94A3B8'}});
      }
      // 틀 고정
      sheet.freezePanes(2,1);
    }
    const out = await wb.outputAsync();
    saveAs(new Blob([out],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}), `${companyPrefix}_${filename}.xlsx`);
  }catch(e){
    // 폴백: 기본 저장
    const wb2=XLSX.utils.book_new();
    sheets.forEach(s=>{
      const ws=XLSX.utils.json_to_sheet(s.rows);
      // 숫자 포맷만이라도
      const ref = XLSX.utils.decode_range(ws['!ref']||'A1');
      const headers = Object.keys(s.rows[0]||{});
      headers.forEach((h,idx)=>{
        if(h.includes('수당')){
          for(let r=1;r<=ref.e.r;r++){
            const cell = ws[XLSX.utils.encode_cell({c:idx,r})];
            if(cell && typeof cell.v==='number') cell.z = '#,##0';
          }
        }
      });
      XLSX.utils.book_append_sheet(wb2, ws, s.name);
    });
    const wbout=XLSX.write(wb2,{bookType:'xlsx',type:'array'});
    saveAs(new Blob([wbout],{type:"application/octet-stream"}), `${companyPrefix}_${filename}.xlsx`);
  }
}
$('btnSaveStatus').addEventListener('click', ()=>{ if(!dfStatus.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsxStyled('근태현황',{name:'근태현황',rows:dfStatus,subtotal:false} instanceof Array ? [] : [{name:'근태현황',rows:dfStatus,subtotal:true}]); });
$('btnSaveSummary').addEventListener('click', ()=>{ if(!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsxStyled('근태정리',[{name:'근태정리',rows:dfSummary,subtotal:true}]); });
$('btnSaveNext').addEventListener('click', ()=>{ if(!dfNext.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsxStyled('익월적용',[{name:'익월적용',rows:dfNext,subtotal:false}]); });
$('btnSaveAll').addEventListener('click', ()=>{ if(!dfStatus.length||!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsxStyled('근태_통합',[{name:'근태현황',rows:dfStatus,subtotal:true},{name:'근태정리',rows:dfSummary,subtotal:true},{name:'익월적용',rows:dfNext,subtotal:false}]); });

/* ===== 전월 배지 ===== */
function updatePrevBadge(){
  const b=$('prevState');
  if(prevMetrics){ b.style.background='#dcfce7'; b.style.color='#065f46'; b.innerHTML=`<span>●</span> 전월 데이터: 지정됨 (${prevMetrics.from||'업로드'})`; }
  else { b.style.background='#eef2ff'; b.style.color='#1e3a8a'; b.innerHTML=`<span>●</span> 전월 데이터: 미지정`; }
}
$('btnPrevReset').addEventListener('click', ()=>{ prevMetrics=null; updatePrevBadge(); if(currentResult) renderReport(currentResult); showToast('전월 데이터가 초기화되었습니다.'); });
</script>
</body>
</html>
