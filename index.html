<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATEC 인사관리(근태) · 1~4 페이지 통합본</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;--accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;--dark:#111827;--softblue:#e6efff;--softred:#ffe7e7;}
*{box-sizing:border-box}
body{font-family:'Pretendard','Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}
.topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
.stepper{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
.step{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--line);border-radius:14px;background:#fff;font-weight:700;color:#374151;transition:.2s;cursor:pointer}
.step .num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #d1d5db;background:#f9fafb;color:#111827}
.step.active{border-color:var(--accent1);box-shadow:0 3px 14px rgba(37,99,235,.12)}
.step.active .num{border-color:var(--accent1);background:var(--accent1);color:#fff}
.chev{flex:1;height:2px;background:linear-gradient(90deg,#e5e7eb 0%,#c7d2fe 50%,#e5e7eb 100%);min-width:40px}
main{max-width:1200px;margin:18px auto;padding:0 16px}
.page{display:none;opacity:0;transform:translateY(6px);transition:opacity .28s ease,transform .28s ease}
.page.show{display:block;opacity:1;transform:none}
.card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 24px rgba(0,0,0,.05);padding:20px;margin:18px 0}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.upload-box{border:2px dashed var(--line);border-radius:12px;padding:22px;text-align:center;background:#fbfdff}
.upload-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}
.upload-row .upload-box{min-height:130px}
.upload-action{display:flex;justify-content:center;margin-top:16px}
input[type=file]{display:none}
.pick{background:var(--dark);color:#fff;padding:10px 18px;border-radius:10px;font-weight:800;cursor:pointer;display:inline-block}
.pick.flash{background:var(--ok);animation:flash 1.1s ease-out}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
.filename{display:block;color:var(--muted);margin-top:10px;min-height:20px}
.btn{background:var(--dark);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
.btn:hover{background:var(--accent1)} .btn[disabled]{background:#9ca3af;cursor:not-allowed}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.kpi{border:1px solid var(--line);border-radius:16px;padding:14px;text-align:center}
.kpi h4{margin:0;color:var(--muted);font-size:14px}
.kpi .big{font-size:24px;font-weight:700;margin-top:3px}
.kpi .small{font-size:13px;color:#374151;line-height:1.95;margin-top:6px}
.chart-row{display:flex;gap:22px;justify-content:center;flex-wrap:wrap;align-items:flex-start}
.chart-box{width:460px;max-width:45vw;text-align:center}
.chart-box canvas{max-height:240px}
.chart-box p{font-size:15px;font-weight:800;margin:.6rem 0 0}
.sum-card h2{margin:0;font-size:22px}
.sum-meta{line-height:1.95;margin-top:4px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px 10px;text-align:center;font-size:.92rem;background:#fff}
th{background:#f3f4f6}
.subtotal{background:#f9fafb;font-weight:800;border-top:2px solid #9ca3af}
.group-red{box-shadow:inset 0 0 0 2px var(--softred);border-radius:8px}
.group-blue{box-shadow:inset 0 0 0 2px var(--softblue);border-radius:8px}
.next-wrap{overflow-x:auto;overflow-y:hidden;border:1px solid var(--line);border-radius:12px}
.next-inner{min-width:920px}
.save-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.btn-merge{background:#2563eb}
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10000}
.panel{background:#fff;max-width:720px;width:92vw;border-radius:16px;box-shadow:0 16px 60px rgba(0,0,0,.35);padding:18px}
.grid-map{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cell{display:flex;align-items:center;gap:10px}
.cell label{min-width:180px;font-weight:700}
select{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px}
</style>
</head>
<body>
<header>ATEC 인사관리(근태) 프로그램</header>
<div class="topbar">
  <div class="stepper">
    <div class="step active" data-step="1"><div class="num">1</div>업로드</div>
    <div class="chev"></div>
    <div class="step" data-step="2"><div class="num">2</div>리포트</div>
    <div class="chev"></div>
    <div class="step" data-step="3"><div class="num">3</div>세부내역</div>
    <div class="chev"></div>
    <div class="step" data-step="4"><div class="num">4</div>데이터 저장</div>
  </div>
</div>
<main>
<!-- 1. 업로드 -->
<section id="page1" class="page show">
  <div class="card">
    <h2 style="margin:0 0 10px 0">안내사항</h2>
    <ul style="margin:8px 0 6px 18px;line-height:1.7">
      <li>산정기간: <b>전월 21일 ~ 당월 20일</b> (결재 완료 기준)</li>
      <li>휴게시간: <b>4시간 초과 시 1시간</b> 자동 부여</li>
      <li>주 52시간 기준: 휴일/야간근무는 <b>주 12시간 이내</b> 신청 가능</li>
      <li>필요 RAW 데이터(2개)</li>
    </ul>
    <div style="padding-left:10px">
      <div style="margin:10px 0">1) 그룹웨어-시간외근무 승인(관리자) 데이터</div>
      <div style="margin:10px 0">2) ERP-책정임근현황(통상시급)</div>
    </div>
  </div>
  <div class="card">
    <h2 style="margin:0 0 10px 0">데이터 업로드</h2>
    <div class="upload-grid">
      <div class="upload-box">
        <label class="pick" for="curAtt">근태 RAW</label>
        <input id="curAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curAttName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="curWage">통상시급</label>
        <input id="curWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="curWageName" class="filename">선택된 파일 없음</span>
      </div>
    </div>
    <p style="margin:18px 0 6px;color:#374151;font-weight:800">[전월 자료] (선택사항)</p>
    <div class="upload-row">
      <div class="upload-box">
        <label class="pick" for="prevAtt">전월 근태 RAW</label>
        <input id="prevAtt" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevAttName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevWage">전월 통상시급</label>
        <input id="prevWage" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
        <span id="prevWageName" class="filename">선택된 파일 없음</span>
      </div>
      <div class="upload-box">
        <label class="pick" for="prevMerged">전월 통합자료(권장)</label>
        <input id="prevMerged" type="file" accept=".xlsx,.xls,.xlsm" />
        <span id="prevMergedName" class="filename">선택된 파일 없음 (근태_통합 또는 근태정리 시트)</span>
      </div>
    </div>
    <div class="upload-action">
      <button id="btnRun" class="btn" disabled>시뮬레이션 시작</button>
    </div>
  </div>
</section>
<!-- 2. 리포트 -->
<section id="page2" class="page">
  <div class="card sum-card" style="text-align:center">
    <h2 id="sumTitle">총 수당(시간외+휴일) 0원</h2>
    <p class="sum-meta" id="sumMeta">당월: 0원 (전월: 0원)</p>
    <p class="sum-meta" id="sumDelta" style="color:#2563eb">▼ 0원 (0.0%)</p>
  </div>
  <div class="card">
    <div class="summary-grid">
      <div class="kpi">
        <h4>총 적용시간</h4>
        <div class="big" id="appliedNow">0.0h</div>
        <div class="small" id="appliedPrev" style="opacity:.9">(전월: 0.0h)</div>
        <div class="small" id="appliedDelta"></div>
      </div>
      <div class="kpi">
        <h4>시간외수당</h4>
        <div class="big"><span id="overPayNow">0</span>원</div>
        <div class="small" id="overPayPrev" style="opacity:.9">(전월: 0원)</div>
        <div class="small" id="overPayDelta"></div>
      </div>
      <div class="kpi">
        <h4>휴일수당</h4>
        <div class="big"><span id="holPayNow">0</span>원</div>
        <div class="small" id="holPayPrev" style="opacity:.9">(전월: 0원)</div>
        <div class="small" id="holPayDelta"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="chart-row">
      <div class="chart-box">
        <p>전월 시간/수당 비율</p>
        <canvas id="donutPrev"></canvas>
      </div>
      <div class="chart-box">
        <p>당월 시간/수당 비율</p>
        <canvas id="donutNow"></canvas>
      </div>
    </div>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0">전월 대비 비교 차트</h3>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barHours"></canvas>
        <p style="margin:.6rem 0 0">시간 비교(적용·연장·휴일) — 전월(파랑) vs 당월(연한 빨강)</p>
      </div>
    </div>
    <div class="chart-row">
      <div class="chart-box" style="width:820px">
        <canvas id="barPays"></canvas>
        <p style="margin:.6rem 0 0">수당 비교(총·시간외·휴일) — 전월(파랑) vs 당월(연한 빨강)</p>
      </div>
    </div>
  </div>
</section>
<!-- 3. 세부내역 -->
<section id="page3" class="page">
  <div class="card">
    <h2 style="margin-top:0">근태현황</h2>
    <table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>근태정리</h2>
    <table id="tblSummary"><thead><tr><th>데이터 없음</th></tr></thead></table>
  </div>
  <div class="card">
    <h2>익월적용</h2>
    <div class="next-wrap"><div class="next-inner">
      <table id="tblNext"><thead><tr><th>데이터 없음</th></tr></thead></table>
    </div></div>
  </div>
</section>
<!-- 4. 데이터 저장 -->
<section id="page4" class="page">
  <div class="card">
    <h2 style="margin-top:0">엑셀 다운로드</h2>
    <p class="muted" style="margin-top:-4px">버튼을 클릭하면 .xlsx 저장 창이 열립니다.</p>
    <div class="save-row">
      <button class="btn" id="btnSaveStatus">근태현황 저장</button>
      <button class="btn" id="btnSaveSummary">근태정리 저장</button>
      <button class="btn" id="btnSaveNext">익월적용 저장</button>
      <button class="btn btn-merge" id="btnSaveAll">통합저장</button>
    </div>
    <p class="muted" style="margin-top:10px">※ 통합저장은 전월 데이터 보관을 하지 않습니다. 전월 비교는 1페이지의 <b>전월 자료 업로드</b>로 지정하세요.</p>
  </div>
</section>
</main>

<!-- 헤더 매핑 모달 -->
<div class="modal" id="mapModal">
  <div class="panel">
    <h3 id="mapTitle" style="margin:0 0 8px 0">헤더 매핑</h3>
    <p class="muted" style="margin-top:0">업로드한 파일의 열 이름을 아래 표준 항목에 연결하세요.</p>
    <div class="grid-map" id="mapGrid"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn" id="btnMapCancel" style="background:#6b7280">취소</button>
      <button class="btn" id="btnMapOk">매핑 완료</button>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
// ---- plugin registration guard (핫픽스 1)
try{
  if(window.Chart && window.ChartDataLabels){
    Chart.register(ChartDataLabels);
  }
}catch(e){
  console.warn('ChartDataLabels not ready', e);
}

// ---- utils
const $=id=>document.getElementById(id);
const showToast=(m)=>{const t=$('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2500);}
const number = v => { const n = Number(String(v??'').toString().replace(/[, ]/g,'')); return isNaN(n)?0:n; };
const hourMod24 = t => t - 24*Math.floor(t/24);
function parseTime(s){
  if(s==null) return -1; let st=String(s).trim().replace(/\s+/g,'');
  st=st.replace('시',':').replace('분','');
  if(!st.includes(':')){
    if(!/^\d+$/.test(st)) return -1;
    const n=parseInt(st,10); if(st.length<=2) return n; if(st.length<=4) return Math.floor(n/100)+(n%100)/60; return -1;
  }
  let [h,m]=st.split(':'); h=parseInt(h,10); m=parseInt(m,10);
  if(isNaN(h)||isNaN(m)||m<0||m>=60) return -1; return h+m/60;
}
const ceilHalf=x=> Math.ceil(Number(x)/0.5)*0.5;
const fmtHM=d=>{const h=Math.floor(d)%24;const m=Math.round((d-Math.floor(d))*60)%60;return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
const sum=(rows,key)=> rows.reduce((a,r)=> a + number(r[key]), 0);

// ---- mapping dictionaries
const REQUIRED_ATT=["신청시간","근무자 부서","근무자","근무일","근무유형","종결일자","상태"];
const REQUIRED_WAGE=["부서","이름","통상시급"];
const SYN={
 "신청시간":["신청시간","시간","근무시간대","근무신청시간","시작~종료","근무시간(신청)"],
 "근무자 부서":["근무자 부서","부서","부서(팀)","부서명","소속"],
 "근무자":["근무자","이름","성명","근무자명","사원명"],
 "근무일":["근무일","일자","근무일자","날짜"],
 "근무유형":["근무유형","유형","구분","근무구분"],
 "종결일자":["종결일자","결재일자","승인일자","종결일","결재일"],
 "상태":["상태","결재상태","승인상태"],
 "부서":["부서","부서명","소속","부서(팀)"],
 "이름":["이름","성명","사원명"],
 "통상시급":["통상시급","기본시급","시급","통상 임금","통상임금"]
};
function guessMap(required, cols){
  const m={}; required.forEach(k=>{
    const l=cols.map(c=>String(c||'').toLowerCase());
    const idx1=l.indexOf(k.toLowerCase());
    if(idx1>-1){ m[k]=cols[idx1]; return; }
    const alt=(SYN[k]||[]).map(s=>s.toLowerCase());
    const idx2=l.findIndex(x=>alt.includes(x));
    m[k]= idx2>-1? cols[idx2] : "";
  }); return m;
}
function openMapper(title, required, cols){
  return new Promise((resolve,reject)=>{
    $('mapTitle').textContent=title;
    const grid=$('mapGrid'); grid.innerHTML="";
    const g=guessMap(required, cols);
    required.forEach(k=>{
      const wrap=document.createElement('div'); wrap.className='cell';
      const lab=document.createElement('label'); lab.textContent=k;
      const sel=document.createElement('select'); sel.dataset.key=k;
      sel.appendChild(new Option('-- 열 선택 --',''));
      cols.forEach(c=> sel.appendChild(new Option(c,c)));
      sel.value=g[k]||"";
      wrap.appendChild(lab); wrap.appendChild(sel);
      grid.appendChild(wrap);
    });
    const modal=$('mapModal'); modal.style.display='flex';
    $('btnMapCancel').onclick=()=>{ modal.style.display='none'; reject(new Error('매핑 취소')); };
    $('btnMapOk').onclick=()=>{
      const mapping={}; const selects=[...grid.querySelectorAll('select')];
      for(const s of selects){ if(!s.value){ showToast('모든 항목을 매핑해 주세요.'); return; } mapping[s.dataset.key]=s.value; }
      modal.style.display='none'; resolve(mapping);
    };
  });
}
function normalizeRows(rows, mapping){ return rows.map(r=>{ const o={}; for(const k in mapping){ o[k]=r[mapping[k]]; } return o; }); }

// ---- state
let curAttRows=[], curWageRows=[];
let prevAttRows=[], prevWageRows=[];
let prevMergedMetrics=null;
let dfStatus=[], dfSummary=[], dfNext=[];

// ---- readers (핫픽스 3: XLSX 미로드 메시지)
function readExcel(file, preferSheets=[]){
  return new Promise((resolve,reject)=>{
    if(typeof XLSX==='undefined'){ return reject(new Error('Excel 라이브러리가 로드되지 않았습니다. (네트워크/CDN 차단)')); }
    const fr=new FileReader();
    fr.onload=e=>{
      try{
        const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        let ws=null; for(const n of preferSheets){ if(wb.Sheets[n]){ ws=wb.Sheets[n]; break; } }
        if(!ws) ws=wb.Sheets[wb.SheetNames[0]];
        resolve({wb, rows:XLSX.utils.sheet_to_json(ws,{defval:null})});
      }catch(err){reject(err);}
    }; fr.readAsArrayBuffer(file);
  });
}

// ---- UI helpers
function flashLabel(forId){ const lab=document.querySelector(`label[for="${forId}"]`); if(!lab) return; lab.classList.remove('flash'); void lab.offsetWidth; lab.classList.add('flash'); }
function attachPicker(inputId, nameId, handler){
  const inp=$(inputId), name=$(nameId);
  inp.addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f){ name.textContent='선택된 파일 없음'; return; }
    name.textContent='분석 중…';
    try{ await handler(f, name, inputId); flashLabel(inputId); }
    catch(err){ console.error(err); showToast('업로드 실패: '+err.message); name.textContent='실패'; }
    finally{ e.target.value=''; }
  });
}
function updateRunBtn(){ $('btnRun').disabled = !(curAttRows.length && curWageRows.length); }

// ---- processing (휴게 1시간 규정 / 종결일자 공란 → 익월적용 수집 / 수당계산 매칭 보강)
function process(attRows, wageRows){
  const status=[], agg={}, nextRows=[];
  const ensure=(name,dept)=>{ if(!agg[name]) agg[name]={부서:dept,이름:name,근무시간:0,휴게시간:0,적용시간:0,평일연장:0,평일야간:0,휴일일반:0,휴일연장:0,휴일야간:0,휴일연장야간:0}; };
  for(const r of attRows){
    if(String(r['상태']||'').includes('반려')) continue;
    const raw=String(r['신청시간']||''); if(!raw.includes('~')) continue;
    let [s,e]=raw.split('~').map(x=>x.trim()); let sh=parseTime(s), eh=parseTime(e); if(sh<0||eh<0) continue; if(eh<sh) eh+=24;
    const work=eh-sh;
    const brk = work>4 ? 1 : 0;              // 4시간 초과 시 1시간 고정
    const applied=work-brk;

    const closed = String(r['종결일자']||'').trim();
    if(!closed){
      nextRows.push({
        부서: r['근무자 부서'], 이름: r['근무자'], 근무일자: r['근무일'], 근무유형: r['근무유형'],
        신청시간: raw, 근무시작시간: fmtHM(sh), 근무종료시간: fmtHM(eh),
        근무시간:+work.toFixed(2), 휴게시간:+brk.toFixed(2), 적용시간:+applied.toFixed(2),
        종결일자:'', 비고:'미종결(종결일자 공란)'
      });
    }

    status.push({부서:r['근무자 부서'],이름:r['근무자'],근무일자:r['근무일'],근무유형:r['근무유형'],
      근무시작시간:fmtHM(sh),근무종료시간:fmtHM(eh),근무시간:+work.toFixed(2),휴게시간:+brk.toFixed(2),적용시간:+applied.toFixed(2),정수:ceilHalf(applied)});
    const nm=String(r['근무자']||'').replace('(IT)','').trim(); if(!nm) continue; const dept=String(r['근무자 부서']||'').trim(); const ty=String(r['근무유형']||'').toLowerCase();
    ensure(nm,dept); const A=agg[nm]; A.근무시간+=work; A.휴게시간+=brk; A.적용시간+=applied;
    let effStart=sh+brk; if(effStart>eh) effStart=eh;
    for(let t=effStart; t<eh-1e-6; t+=0.25){
      const hod=hourMod24(t); const worked=t-effStart;
      if(ty.includes('연장') && !ty.includes('휴일')){ if(hod>=18&&hod<22) A.평일연장+=0.25; if(hod>=22||hod<6) A.평일야간+=0.25; }
      else if(ty.includes('휴일')){
        if(worked<8){ if(hod>=6&&hod<22) A.휴일일반+=0.25; else A.휴일야간+=0.25; }
        else { if(hod>=6&&hod<22) A.휴일연장+=0.25; else A.휴일연장야간+=0.25; }
      }
    }
  }
  const summary=Object.values(agg).map((A,i)=>({순번:i+1,부서:A.부서,이름:A.이름,근무시간:+A.근무시간.toFixed(2),휴게시간:+A.휴게시간.toFixed(2),적용시간:+A.적용시간.toFixed(2),
    평일연장:+A.평일연장.toFixed(2),평일야간:+A.평일야간.toFixed(2),휴일일반:+A.휴일일반.toFixed(2),휴일연장:+A.휴일연장.toFixed(2),휴일야간:+A.휴일야간.toFixed(2),휴일연장야간:+A.휴일연장야간.toFixed(2)}));

  // 수당 계산(부서|이름 → 이름만 → 부서만 순서로 매칭)
  if(wageRows && wageRows.length){
    const key = (dept,name)=>`${String(dept||'').trim()}|${String(name||'').trim()}`;
    const wageMap = new Map();
    wageRows.forEach(r=>{
      const dept=String(r['부서']||'').trim();
      const name=String(r['이름']||'').trim();
      const base=number(r['통상시급']);
      if(!wageMap.has(key(dept,name))) wageMap.set(key(dept,name), base);
      if(!wageMap.has(key('',name))) wageMap.set(key('',name), base);
      if(!wageMap.has(key(dept,''))) wageMap.set(key(dept,''), base);
    });
    const mult={평일연장:1.5, 평일야간:2.0, 휴일일반:1.5, 휴일연장:2.0, 휴일야간:2.0, 휴일연장야간:2.5};
    summary.forEach(r=>{
      const base = wageMap.get(key(r.부서,r.이름)) ?? wageMap.get(key('',r.이름)) ?? wageMap.get(key(r.부서,'')) ?? 0;
      r['시간외수당'] = Math.ceil(base*mult.평일연장*r.평일연장) + Math.ceil(base*mult.평일야간*r.평일야간);
      r['휴일수당'] = Math.ceil(base*mult.휴일일반*r.휴일일반) + Math.ceil(base*mult.휴일연장*r.휴일연장) + Math.ceil(base*mult.휴일야간*r.휴일야간) + Math.ceil(base*mult.휴일연장야간*r.휴일연장야간);
    });
  }
  const overHours=summary.reduce((a,r)=>a+r.평일연장+r.평일야간,0);
  const holHours =summary.reduce((a,r)=>a+r.휴일일반+r.휴일연장+r.휴일야간+r.휴일연장야간,0);
  const appliedTotal= status.reduce((a,r)=>a+number(r.적용시간),0);
  let overPay=0, holPay=0;
  if(wageRows && wageRows.length){
    summary.forEach(r=>{ overPay += number(r['시간외수당']); holPay += number(r['휴일수당']); });
  }
  return {status,summary,next:nextRows,metrics:{appliedTotal,overHours,holHours,overPay,holPay,totalPay:overPay+holPay}};
}

// ---- charts
const donutPrev=document.getElementById('donutPrev'), donutNow=document.getElementById('donutNow');
const barHours=document.getElementById('barHours'), barPays=document.getElementById('barPays');
function drawDoughnut(ctx, labels, data, colors){
  if(!window.Chart) return;
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2}]},
    options:{maintainAspectRatio:false,aspectRatio:1.2,cutout:'62%',
      plugins:{legend:{position:'bottom',labels:{boxWidth:14}},
        datalabels:{color:'#fff',font:{weight:'700',size:14},formatter:v=>v?`${v}%`:''}}},plugins:(window.ChartDataLabels?[ChartDataLabels]:[])});
}
function drawBars(ctx, labels, prev, now, isMoney){
  if(!window.Chart) return;
  if(ctx._chart) ctx._chart.destroy();
  ctx._chart=new Chart(ctx,{type:'bar',
    data:{labels,datasets:[
      {label:'전월',data:prev,backgroundColor:'#60a5fa',maxBarThickness:40},
      {label:'당월',data:now, backgroundColor:'#fca5a5',maxBarThickness:40}
    ]},
    options:{maintainAspectRatio:false,aspectRatio:1.7,
      plugins:{
        legend:{position:'bottom'},
        datalabels:{
          anchor:'end',align:'end',offset:4,
          color:'#111827',
          backgroundColor:'rgba(220,235,255,0.68)',
          font:{weight:'bold',size:17},
          borderRadius:8,
          padding:{top:4,bottom:4,left:8,right:8},
          borderWidth:2,
          borderColor:'rgba(120,120,220,0.18)',
          shadowBlur:7,shadowColor:'#bdbdbd',
          formatter:v=>isMoney?Number(v).toLocaleString():v
        }
      },
      scales:{y:{beginAtZero:true,grace:'12%',ticks:{callback:v=>isMoney?Number(v).toLocaleString():v}}}
    },plugins:(window.ChartDataLabels?[ChartDataLabels]:[])});
}

// ---- table render/save
const tblStatus=$('tblStatus'), tblSummary=$('tblSummary'), tblNext=$('tblNext');
function renderTable(el, rows){
  if(!rows||!rows.length){ el.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const cols=Object.keys(rows[0]);
  let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  let tbody='<tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
  el.innerHTML=thead+tbody;
}
function renderSummaryTable(rows){
  if(!rows||!rows.length){ tblSummary.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>'; return; }
  const baseCols=['순번','부서','이름','근무시간','휴게시간','적용시간'];
  const redCols=['평일연장','평일야간','시간외수당'];
  const blueCols=['휴일일반','휴일연장','휴일야간','휴일연장야간','휴일수당'];
  const cols=[...baseCols,...redCols,...blueCols];
  const totals={}; cols.forEach(c=> totals[c]=0);
  rows.forEach(r=> cols.forEach(c=> totals[c]+= number(r[c])));
  let thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  let body='<tbody>';
  rows.forEach((r,i)=>{
    body+='<tr>'+baseCols.map(c=>`<td>${r[c]??''}</td>`).join('')
         + redCols.map(c=>`<td>${(c.includes('수당')? number(r[c]).toLocaleString(): r[c])??''}</td>`).join('')
         + blueCols.map(c=>`<td>${(c.includes('수당')? number(r[c]).toLocaleString(): r[c])??''}</td>`).join('')
         +'</tr>';
  });
  const subtotal = '<tr class="subtotal">'+
    '<td colspan="3">소계</td>'+
    ['근무시간','휴게시간','적용시간'].map(c=>`<td>${totals[c].toFixed(2)}</td>`).join('')+
    redCols.map(c=> `<td>${c.includes('수당')? totals[c].toLocaleString(): totals[c].toFixed(2)}</td>`).join('')+
    blueCols.map(c=> `<td>${c.includes('수당')? totals[c].toLocaleString(): totals[c].toFixed(2)}</td>`).join('')+
  '</tr>';
  body+=subtotal+'</tbody>';
  tblSummary.innerHTML=thead+body;
}
function renderNextTable(rows){
  if(!rows || !rows.length){ tblNext.innerHTML='<thead><tr><th>익월 적용 데이터 없음</th></tr></thead>'; return; }
  renderTable(tblNext, rows);
}
function toSheet(rows){ return XLSX.utils.json_to_sheet(rows); }
function saveXlsx(filename, sheets){
  if(typeof XLSX==='undefined' || typeof saveAs!=='function'){ showToast('저장을 위해 XLSX/FileSaver가 필요합니다.'); return; }
  const wb=XLSX.utils.book_new();
  sheets.forEach(s=>XLSX.utils.book_append_sheet(wb, s.ws, s.name));
  const now=new Date();
  const tag=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:"application/octet-stream"}), `ATEC_${filename}_${tag}.xlsx`);
}
$('btnSaveStatus').addEventListener('click', ()=>{ if(!dfStatus.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태현황',[{name:'근태현황',ws:toSheet(dfStatus)}]); });
$('btnSaveSummary').addEventListener('click', ()=>{ if(!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태정리',[{name:'근태정리',ws:toSheet(dfSummary)}]); });
$('btnSaveNext').addEventListener('click', ()=>{ if(!dfNext.length) return showToast('익월적용 데이터가 없습니다.'); saveXlsx('익월적용',[{name:'익월적용',ws:toSheet(dfNext)}]); });
$('btnSaveAll').addEventListener('click', ()=>{ if(!dfStatus.length||!dfSummary.length) return showToast('먼저 시뮬레이션을 수행하세요.'); saveXlsx('근태_통합',[{name:'근태현황',ws:toSheet(dfStatus)},{name:'근태정리',ws:toSheet(dfSummary)},{name:'익월적용',ws:toSheet(dfNext||[])}]); });

// ---- report
function renderReport(now, prev){
  function deltaArrow(val, prevVal) {
    const diff = (val || 0) - (prevVal || 0);
    const pct = (prevVal ? diff / prevVal * 100 : 0);
    const arrow = diff >= 0 ? '▲' : '▼';
    const color = diff >= 0 ? '#ef4444' : '#2563eb';
    return {arrow, diff, pct, color};
  }
  // 적용시간
  $('appliedNow').textContent = (now.appliedTotal||0).toFixed(1)+'h';
  $('appliedPrev').textContent = `(전월: ${(prev.appliedTotal||0).toFixed(1)}h)`;
  const applied = deltaArrow(now.appliedTotal, prev.appliedTotal);
  $('appliedDelta').innerHTML = `<span style="color:${applied.color};font-weight:800;">${applied.arrow} ${Math.abs(applied.diff).toFixed(1)}h (${applied.pct.toFixed(1)}%)</span>`;
  // 시간외수당
  $('overPayNow').textContent = (now.overPay||0).toLocaleString();
  $('overPayPrev').textContent = `(전월: ${(prev.overPay||0).toLocaleString()}원)`;
  const overPay = deltaArrow(now.overPay, prev.overPay);
  $('overPayDelta').innerHTML = `<span style="color:${overPay.color};font-weight:800;">${overPay.arrow} ${Math.abs(overPay.diff).toLocaleString()}원 (${overPay.pct.toFixed(1)}%)</span>`;
  // 휴일수당
  $('holPayNow').textContent = (now.holPay||0).toLocaleString();
  $('holPayPrev').textContent = `(전월: ${(prev.holPay||0).toLocaleString()}원)`;
  const holPay = deltaArrow(now.holPay, prev.holPay);
  $('holPayDelta').innerHTML = `<span style="color:${holPay.color};font-weight:800;">${holPay.arrow} ${Math.abs(holPay.diff).toLocaleString()}원 (${holPay.pct.toFixed(1)}%)</span>`;

  $('sumTitle').textContent = `총 수당(시간외+휴일) ${(now.totalPay||0).toLocaleString()}원`;
  $('sumMeta').textContent  = `당월: ${(now.totalPay||0).toLocaleString()}원 (전월: ${(prev.totalPay||0).toLocaleString()}원)`;
  const d=(now.totalPay||0)-(prev.totalPay||0); const p=(prev.totalPay? d/prev.totalPay*100:0);
  const arrow=d>=0?'▲':'▼'; const col=d>=0?'#ef4444':'#2563eb'; $('sumDelta').style.color=col; $('sumDelta').textContent=`${arrow} ${Math.abs(d).toLocaleString()}원 (${p.toFixed(1)}%)`;

  // 도넛/막대
  const pct=(n,t)=> t? Math.round(n/t*100):0;
  const prevT=(prev.overHours||0)+(prev.holHours||0), nowT=(now.overHours||0)+(now.holHours||0);
  drawDoughnut(donutPrev,['연장시간','휴일시간'],[pct(prev.overHours,prevT),pct(prev.holHours,prevT)],[ '#fecaca', '#bfdbfe' ]);
  drawDoughnut(donutNow, ['연장시간','휴일시간'],[pct(now.overHours,nowT),pct(now.holHours,nowT)],[ '#ef4444', '#2563eb' ]);
  drawBars(barHours,['적용시간(h)','연장시간(h)','휴일시간(h)'],
          [prev.appliedTotal||0,prev.overHours||0,prev.holHours||0],
          [now.appliedTotal||0, now.overHours||0, now.holHours||0], false);
  drawBars(barPays,['총수당(원)','시간외수당(원)','휴일수당(원)'],
          [prev.totalPay||0,prev.overPay||0,prev.holPay||0],
          [now.totalPay||0, now.overPay||0, now.holPay||0], true);
}

// ---- run
$('btnRun').addEventListener('click', ()=>{
  try{
    const cur=process(curAttRows, curWageRows);
    dfStatus=cur.status; dfSummary=cur.summary; dfNext=cur.next;
    let prev={appliedTotal:0,overHours:0,holHours:0,overPay:0,holPay:0,totalPay:0};
    if(prevMergedMetrics) prev=prevMergedMetrics;
    else if(prevAttRows.length && prevWageRows.length) prev=process(prevAttRows, prevWageRows).metrics;
    renderTable(tblStatus, dfStatus);
    renderSummaryTable(dfSummary);
    renderNextTable(dfNext);
    renderReport(cur.metrics, prev);
    setActiveStep(2); goto(2);
    showToast('시뮬레이션 완료');
  }catch(err){ console.error(err); showToast('실패: '+err.message); }
});

// ---- nav
function goto(n){ const pages=[...document.querySelectorAll('.page')]; pages.forEach(p=>{p.classList.remove('show');p.style.display='none';}); const tgt=document.getElementById('page'+n); tgt.style.display='block'; requestAnimationFrame(()=>tgt.classList.add('show')); window.scrollTo({top:0,behavior:'smooth'}); }
function setActiveStep(n){ document.querySelectorAll('.step').forEach(x=>x.classList.remove('active')); document.querySelector(`.step[data-step="${n}"]`).classList.add('active'); }
document.querySelectorAll('.step').forEach(s=> s.addEventListener('click', ()=>{ const n=Number(s.dataset.step); setActiveStep(n); goto(n); }));

// ---- pickers 바인딩 (핫픽스 2: DOMContentLoaded 이후)
function bindPickers(){
  attachPicker('curAtt','curAttName', async (file, name)=>{
    const {rows}=await readExcel(file);
    if(!rows.length) throw new Error('데이터가 비어있습니다.');
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_ATT.every(h=>cols.includes(h))){
      const map=await openMapper('당월 근태 RAW 헤더 매핑', REQUIRED_ATT, cols);
      curAttRows = normalizeRows(rows, map);
    }else curAttRows=rows;
    name.textContent=`선택 완료 · ${file.name} (${curAttRows.length}행)`; updateRunBtn();
  });

  attachPicker('curWage','curWageName', async (file, name)=>{
    const {rows}=await readExcel(file);
    if(!rows.length) throw new Error('데이터가 비어있습니다.');
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_WAGE.every(h=>cols.includes(h))){
      const map=await openMapper('당월 통상시급 헤더 매핑', REQUIRED_WAGE, cols);
      curWageRows = normalizeRows(rows, map);
    }else curWageRows=rows;
    name.textContent=`선택 완료 · ${file.name} (${curWageRows.length}행)`; updateRunBtn();
  });

  attachPicker('prevAtt','prevAttName', async (file, name)=>{
    const {rows}=await readExcel(file);
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_ATT.every(h=>cols.includes(h))){
      const map=await openMapper('전월 근태 RAW 헤더 매핑', REQUIRED_ATT, cols);
      prevAttRows = normalizeRows(rows, map);
    }else prevAttRows=rows;
    prevMergedMetrics=null;
    name.textContent=`전월 RAW 선택 · ${file.name} (${prevAttRows.length}행)`;
  });

  attachPicker('prevWage','prevWageName', async (file, name)=>{
    const {rows}=await readExcel(file);
    const cols=Object.keys(rows[0]||{});
    if(!REQUIRED_WAGE.every(h=>cols.includes(h))){
      const map=await openMapper('전월 통상시급 헤더 매핑', REQUIRED_WAGE, cols);
      prevWageRows = normalizeRows(rows, map);
    }else prevWageRows=rows;
    prevMergedMetrics=null;
    name.textContent=`전월 통상시급 선택 · ${file.name} (${prevWageRows.length}행)`;
  });

  attachPicker('prevMerged','prevMergedName', async (file, name)=>{
    const {wb}=await readExcel(file, ['근태정리']);
    if(!wb.Sheets['근태정리']) throw new Error('근태정리 시트를 찾을 수 없습니다.');
    const rows=XLSX.utils.sheet_to_json(wb.Sheets['근태정리'],{defval:null});
    const subtotal = rows.find(r=> Object.values(r).some(v=> String(v).includes('소계')));
    const sumCols=(keys)=> subtotal
      ? keys.reduce((a,k)=> a + number(subtotal[k]), 0)
      : rows.reduce((a,r)=> a + keys.reduce((s,k)=> s + number(r[k]),0), 0);
    const overHours = sumCols(['평일연장','평일야간']);
    const holHours  = sumCols(['휴일일반','휴일연장','휴일야간','휴일연장야간']);
    const overPay   = sumCols(['시간외수당']);
    const holPay    = sumCols(['휴일수당']);
    const appliedTotal = rows.reduce((a,r)=> a + number(r['적용시간']), 0) || (overHours+holHours);
    prevMergedMetrics = {appliedTotal,overHours,holHours,overPay,holPay,totalPay:overPay+holPay,from:file.name};
    prevAttRows=[]; prevWageRows=[];
    name.textContent=`전월 통합 지정 · ${file.name} (근태정리 ${rows.length}행)`; showToast('전월 통합자료가 설정되었습니다.');
  });
}
document.addEventListener('DOMContentLoaded', ()=>{ try{ bindPickers(); } catch(e){ console.error(e); showToast('업로드 초기화 실패: '+e.message);} });

// ---- init
goto(1);
</script>
</body>
</html>
