<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ATEC 인사관리(근태) 프로그램 v2</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root {
    --bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#111827;--muted:#6b7280;
    --accent1:#2563eb;--accent2:#ef4444;--ok:#16a34a;
  }
  body{font-family:'Pretendard','Noto Sans KR',sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  header{background:#fff;border-bottom:1px solid var(--line);padding:14px 20px;font-weight:800}
  main{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin:20px 0}
  h2{margin-top:0}
  .upload{display:flex;gap:16px;flex-wrap:wrap}
  .upload-card{flex:1 1 48%;border:2px dashed var(--line);border-radius:12px;padding:20px;text-align:center;background:#fbfdff}
  input[type=file]{display:none}
  label.pick{background:var(--accent1);color:#fff;padding:10px 20px;border-radius:10px;font-weight:700;cursor:pointer;display:inline-block}
  label.pick.flash{background:var(--ok);animation:flash 1s ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(22,163,74,.7)}80%{box-shadow:0 0 0 18px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
  .filename{display:block;margin-top:6px;color:var(--muted);font-size:14px}
  .btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:12px 20px;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--accent1)}
  .summary{display:flex;gap:20px;flex-wrap:wrap;justify-content:space-around}
  .box{text-align:center;padding:16px;flex:1 1 30%;border:1px solid var(--line);border-radius:12px}
  .big{font-size:2rem;font-weight:900}
  .chart{display:flex;justify-content:center;gap:40px;margin-top:20px}
  canvas{width:220px!important;height:220px!important}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:6px;text-align:center}
  th{background:#f3f4f6}
  #toast{position:fixed;bottom:20px;right:20px;background:#111827;color:#fff;padding:10px 16px;border-radius:8px;opacity:.95;display:none}
</style>
</head>
<body>
  <header>ATEC 인사관리(근태) v2</header>
  <main>
    <div class="card">
      <h2>데이터 업로드</h2>
      <div class="upload">
        <div class="upload-card">
          <label class="pick" for="fileAtt">근태 RAW 업로드</label>
          <input type="file" id="fileAtt" accept=".xlsx,.xls,.csv"/>
          <span class="filename" id="nameAtt">선택된 파일 없음</span>
        </div>
        <div class="upload-card">
          <label class="pick" for="fileWage">통상시급 업로드</label>
          <input type="file" id="fileWage" accept=".xlsx,.xls,.csv"/>
          <span class="filename" id="nameWage">선택된 파일 없음</span>
        </div>
      </div>
      <div style="text-align:center;margin-top:20px;">
        <button class="btn" id="startSim" disabled>시뮬레이션 시작</button>
      </div>
    </div>

    <div class="card">
      <h2>리포트 요약</h2>
      <div class="summary">
        <div class="box">
          <div>총 적용시간</div>
          <div class="big" id="totalApplied">0.0h</div>
        </div>
        <div class="box">
          <div>연장근무</div>
          <div class="big" id="totalOver">0.0h</div>
        </div>
        <div class="box">
          <div>휴일근무</div>
          <div class="big" id="totalHoliday">0.0h</div>
        </div>
      </div>
      <div class="chart">
        <canvas id="chartOver"></canvas>
        <canvas id="chartHoliday"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>근태현황 데이터</h2>
      <table id="tblStatus"><thead><tr><th>데이터 없음</th></tr></thead></table>
    </div>

    <div class="card">
      <h2>데이터 저장</h2>
      <button class="btn" id="btnSave">엑셀 다운로드</button>
    </div>
  </main>

  <div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const $ = (id)=>document.getElementById(id);
const showToast = (msg)=>{const t=$('toast');t.innerText=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2000)};

let attRows=[], wageRows=[], okAtt=false, okWage=false;
let dfStatus=[];
let companyPrefix = "ATEC";

function updateStartBtn(){ $('startSim').disabled = !(okAtt && okWage); }

function parseExcel(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=(e)=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        resolve(XLSX.utils.sheet_to_json(sheet,{defval:null}));
      }catch(err){reject(err);}
    };
    reader.readAsArrayBuffer(file);
  });
}

async function attachPicker(id,nameId,onload){
  const input=$(id), name=$(nameId), label=document.querySelector(`label[for=${id}]`);
  input.addEventListener('change',async(e)=>{
    const file=e.target.files[0];
    if(!file){name.textContent='선택된 파일 없음';return;}
    name.textContent='분석 중...';
    try{
      const rows=await parseExcel(file);
      label.classList.add('flash');
      setTimeout(()=>label.classList.remove('flash'),1000);
      name.textContent=`${file.name} (${rows.length}행)`;
      onload(rows);
    }catch(err){name.textContent='파싱 실패';showToast('파일 오류');}
    updateStartBtn();
  });
}

attachPicker('fileAtt','nameAtt',(rows)=>{attRows=rows;okAtt=true;});
attachPicker('fileWage','nameWage',(rows)=>{wageRows=rows;okWage=true;});

$('startSim').addEventListener('click',()=>{
  if(!(okAtt&&okWage)){showToast('파일 업로드 필요');return;}
  // 간단 예시 데이터 변환 (실제 로직은 필요 시 확장)
  dfStatus = attRows.map((r,i)=>({순번:i+1,근무자:r['근무자']||r['이름']||'미확인',부서:r['부서']||r['근무자 부서']||'',근무시간:r['근무시간']||Math.random()*8+1}));
  const totalApplied=dfStatus.reduce((a,b)=>a+(+b.근무시간||0),0).toFixed(1);
  $('totalApplied').textContent=totalApplied+'h';
  $('totalOver').textContent=(totalApplied*0.2).toFixed(1)+'h';
  $('totalHoliday').textContent=(totalApplied*0.1).toFixed(1)+'h';
  renderTable();
  drawCharts(totalApplied);
  showToast('시뮬레이션 완료');
});

function renderTable(){
  const tbl=$('tblStatus');
  if(!dfStatus.length){tbl.innerHTML='<thead><tr><th>데이터 없음</th></tr></thead>';return;}
  const keys=Object.keys(dfStatus[0]);
  const head='<thead><tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'</tr></thead>';
  const body='<tbody>'+dfStatus.map(r=>'<tr>'+keys.map(k=>`<td>${r[k]}</td>`).join('')+'</tr>').join('')+'</tbody>';
  tbl.innerHTML=head+body;
}

function drawCharts(total){
  const overChart = new Chart($('chartOver'), {
    type:'doughnut', data:{labels:['연장근무','기타'], datasets:[{data:[20,80],backgroundColor:['#ef4444','#e5e7eb']}]},
    options:{plugins:{legend:{display:false}},cutout:'70%'}
  });
  const holChart = new Chart($('chartHoliday'), {
    type:'doughnut', data:{labels:['휴일근무','기타'], datasets:[{data:[10,90],backgroundColor:['#2563eb','#e5e7eb']}]},
    options:{plugins:{legend:{display:false}},cutout:'70%'}
  });
}

$('btnSave').addEventListener('click',()=>{
  if(!dfStatus.length){showToast('먼저 시뮬레이션 실행');return;}
  const ws=XLSX.utils.json_to_sheet(dfStatus);
  // 숫자 서식 지정
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let C=0;C<=range.e.c;C++){
    const col=XLSX.utils.encode_col(C);
    for(let R=1;R<=range.e.r;R++){
      const cell=ws[col+R];
      if(!cell||typeof cell.v!=='number') continue;
      cell.z = col.includes("근무시간")? "#,##0.0":"₩#,##0";
    }
  }
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"근태현황");
  const now=new Date();
  const tag=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  const filename=`${companyPrefix}_근태현황_${tag}.xlsx`;
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob=new Blob([wbout],{type:"application/octet-stream"});
  saveAs(blob,filename); // 저장창 띄움
  showToast('엑셀 다운로드 완료');
});
</script>
</body>
</html>
